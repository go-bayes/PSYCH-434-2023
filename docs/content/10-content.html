<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Joseph Bulbulia">
<meta name="dcterms.date" content="2023-05-23">

<title>PSYC 434 Conducting Research Across Cultures: Trimester 1, 2023 - Causal Inference: reconsidering cross-cultural experiments</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<link href="../site_libs/table1-1.0/table1_defaults.css" rel="stylesheet">
<script src="../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">PSYC 434 Conducting Research Across Cultures: Trimester 1, 2023</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-content" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Content</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-content">    
        <li>
    <a class="dropdown-item" href="../content/common_graphs.html" rel="" target="">
 <span class="dropdown-text">Background: Causal Graphs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/measurement_error.html" rel="" target="">
 <span class="dropdown-text">Background: Causal Graphs: Measurement Error</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/index.html" rel="" target="">
 <span class="dropdown-text">Preliminaries</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/01-content.html" rel="" target="">
 <span class="dropdown-text">1: Asking questions in cross-cultural psychology</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/02-content.html" rel="" target="">
 <span class="dropdown-text">2: Getting started with R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/03-content.html" rel="" target="">
 <span class="dropdown-text">3: Lost in Translation? Measurement and Language</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/04-content.html" rel="" target="">
 <span class="dropdown-text">4: Dealing with Data (Factor Analysis)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/05-content.html" rel="" target="">
 <span class="dropdown-text">5: Dealing with Data (Multi-Group CFA)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/06-content.html" rel="" target="">
 <span class="dropdown-text">6: Dealing with Data (Partial Invariance)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/07-content.html" rel="" target="">
 <span class="dropdown-text">7: Causal Inference: Causal Graphs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/08-content.html" rel="" target="">
 <span class="dropdown-text">8: Causal Inference: Causal Effects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/09-content.html" rel="" target="">
 <span class="dropdown-text">9: Causal inference: Causal Estimation I</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/10-content.html" rel="" target="">
 <span class="dropdown-text">10: Causal Inference: Causal Estimation II</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/11-content.html" rel="" target="">
 <span class="dropdown-text">11: Reconsidering Measurement from a Causal Perspective</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/12-content.html" rel="" target="">
 <span class="dropdown-text">12: Future Horizons</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Causal Inference: reconsidering cross-cultural experiments</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
                      </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Joseph Bulbulia <a href="https://orcid.org/0000-0002-5861-2056" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Victoria University of Wellington, New Zealand
            </p>
        </div>
      </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 23, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#set-up-your-workspace-preparing-for-the-journey" id="toc-set-up-your-workspace-preparing-for-the-journey" class="nav-link" data-scroll-target="#set-up-your-workspace-preparing-for-the-journey">Set up your workspace Preparing for the Journey</a>
  <ul class="collapse">
  <li><a href="#import-the-data" id="toc-import-the-data" class="nav-link" data-scroll-target="#import-the-data">Import the data</a></li>
  </ul></li>
  <li><a href="#revisit-the-checklist" id="toc-revisit-the-checklist" class="nav-link" data-scroll-target="#revisit-the-checklist">Revisit the checklist</a>
  <ul class="collapse">
  <li><a href="#sculpting-the-data-a-hands-on-approach" id="toc-sculpting-the-data-a-hands-on-approach" class="nav-link" data-scroll-target="#sculpting-the-data-a-hands-on-approach">Sculpting the Data: A Hands-On Approach</a></li>
  <li><a href="#create-variables-for-the-latent-factors" id="toc-create-variables-for-the-latent-factors" class="nav-link" data-scroll-target="#create-variables-for-the-latent-factors">Create variables for the latent factors</a></li>
  </ul></li>
  <li><a href="#investigate-assumption-of-positivity" id="toc-investigate-assumption-of-positivity" class="nav-link" data-scroll-target="#investigate-assumption-of-positivity">Investigate assumption of positivity:</a>
  <ul class="collapse">
  <li><a href="#create-wide-data-frame-for-analysis" id="toc-create-wide-data-frame-for-analysis" class="nav-link" data-scroll-target="#create-wide-data-frame-for-analysis">Create wide data frame for analysis</a></li>
  <li><a href="#e-value" id="toc-e-value" class="nav-link" data-scroll-target="#e-value">E-value</a></li>
  </ul></li>
  <li><a href="#descriptive-table" id="toc-descriptive-table" class="nav-link" data-scroll-target="#descriptive-table">Descriptive table</a></li>
  <li><a href="#propensity-scores" id="toc-propensity-scores" class="nav-link" data-scroll-target="#propensity-scores">Propensity scores</a>
  <ul class="collapse">
  <li><a href="#example-summary-nz-euro-propensity-scores." id="toc-example-summary-nz-euro-propensity-scores." class="nav-link" data-scroll-target="#example-summary-nz-euro-propensity-scores.">Example Summary NZ Euro Propensity scores.</a></li>
  <li><a href="#example-summary-maori-propensity-scores." id="toc-example-summary-maori-propensity-scores." class="nav-link" data-scroll-target="#example-summary-maori-propensity-scores.">Example Summary Maori Propensity scores.</a></li>
  <li><a href="#more-data-wrangling" id="toc-more-data-wrangling" class="nav-link" data-scroll-target="#more-data-wrangling">More data wrangling</a></li>
  </ul></li>
  <li><a href="#anxiety-analysis-and-results" id="toc-anxiety-analysis-and-results" class="nav-link" data-scroll-target="#anxiety-analysis-and-results">Anxiety Analysis and Results</a></li>
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation">Interpretation</a></li>
  <li><a href="#depression-analysis-and-results" id="toc-depression-analysis-and-results" class="nav-link" data-scroll-target="#depression-analysis-and-results">Depression Analysis and Results</a></li>
  <li><a href="#interpretation-1" id="toc-interpretation-1" class="nav-link" data-scroll-target="#interpretation-1">Interpretation</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  <li><a href="#appendix-mg-cfa" id="toc-appendix-mg-cfa" class="nav-link" data-scroll-target="#appendix-mg-cfa">Appendix: MG-CFA</a>
  <ul class="collapse">
  <li><a href="#cfa-for-kessler-6" id="toc-cfa-for-kessler-6" class="nav-link" data-scroll-target="#cfa-for-kessler-6">CFA for Kessler 6</a></li>
  <li><a href="#confirmatory-factor-analysis-ignoring-groups" id="toc-confirmatory-factor-analysis-ignoring-groups" class="nav-link" data-scroll-target="#confirmatory-factor-analysis-ignoring-groups">Confirmatory factor analysis (ignoring groups)</a></li>
  <li><a href="#multi-group-confirmatory-factor-analysis" id="toc-multi-group-confirmatory-factor-analysis" class="nav-link" data-scroll-target="#multi-group-confirmatory-factor-analysis">Multi-group Confirmatory Factor Analysis</a></li>
  <li><a href="#configural-invariance" id="toc-configural-invariance" class="nav-link" data-scroll-target="#configural-invariance">Configural invariance</a></li>
  <li><a href="#metric-equivalence" id="toc-metric-equivalence" class="nav-link" data-scroll-target="#metric-equivalence">Metric Equivalence</a></li>
  <li><a href="#scalar-equivalence" id="toc-scalar-equivalence" class="nav-link" data-scroll-target="#scalar-equivalence">Scalar Equivalence</a></li>
  </ul></li>
  <li><a href="#solutions" id="toc-solutions" class="nav-link" data-scroll-target="#solutions">Solutions</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>Today, we dive deep into data analysis for causal inference ast it applies to observational cultural psychology. By the end, you will:</p>
<ul>
<li>Better understand how to integrate measurement theory with causal inference</li>
<li>Enhance your proficiency in causal analysis using doubly robust methods</li>
<li>Gain insights into the application of sensitivity analysis using E-Values</li>
</ul>
</section>
<section id="set-up-your-workspace-preparing-for-the-journey" class="level2">
<h2 class="anchored" data-anchor-id="set-up-your-workspace-preparing-for-the-journey">Set up your workspace Preparing for the Journey</h2>
<p>To kick things off, we will set up our environment. We’ll source essential functions, load necessary libraries, and import synthetic data for our exploration.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Before running this source code, make sure to update to the current version of R, and to update all existing packages.</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># functions</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"https://raw.githubusercontent.com/go-bayes/templates/main/functions/funs.R"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># experimental functions (more functions)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"https://raw.githubusercontent.com/go-bayes/templates/main/functions/experimental_funs.R"</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">#  If you haven't already, you should have created a folder called "data", in your Rstudio project. If not, download this file, add it to your the folder called "data" in your Rstudio project. # "https://www.dropbox.com/s/vwqijg4ha17hbs1/nzavs_dat_synth_t10_t12?dl=0"</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># A function we will use for our tables.</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>tab_ate_subgroup_rd <span class="ot">&lt;-</span> <span class="cf">function</span>(x,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>                                new_name,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>                                <span class="at">delta =</span> <span class="dv">1</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>                                <span class="at">sd =</span> <span class="dv">1</span>) {</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if required packages are installed</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  required_packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"EValue"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  new_packages <span class="ot">&lt;-</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    required_packages[<span class="sc">!</span>(required_packages <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[, <span class="st">"Package"</span>])]</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(new_packages))</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Missing packages: "</span>, <span class="fu">paste</span>(new_packages, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">require</span>(EValue)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">require</span>(dplyr)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check if input data is a dataframe</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.data.frame</span>(x))</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Input x must be a dataframe"</span>)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if required columns are in the dataframe</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  required_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"estimate"</span>, <span class="st">"lower_ci"</span>, <span class="st">"upper_ci"</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  missing_cols <span class="ot">&lt;-</span> required_cols[<span class="sc">!</span>(required_cols <span class="sc">%in%</span> <span class="fu">colnames</span>(x))]</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(missing_cols) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Missing columns in dataframe: "</span>,</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>         <span class="fu">paste</span>(missing_cols, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if lower_ci and upper_ci do not contain NA values</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">is.na</span>(x<span class="sc">$</span>lower_ci), <span class="fu">is.na</span>(x<span class="sc">$</span>upper_ci)))</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Columns 'lower_ci' and 'upper_ci' should not contain NA values"</span>)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), round, <span class="at">digits =</span> <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="st">"E[Y(1)]-E[Y(0)]"</span> <span class="ot">=</span> estimate)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>standard_error <span class="ot">&lt;-</span> <span class="fu">abs</span>(x<span class="sc">$</span>lower_ci <span class="sc">-</span> x<span class="sc">$</span>upper_ci) <span class="sc">/</span> <span class="fl">3.92</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  evalues_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(x)), <span class="cf">function</span>(i) {</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    row_evalue <span class="ot">&lt;-</span> EValue<span class="sc">::</span><span class="fu">evalues.OLS</span>(</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>      x[i, <span class="st">"E[Y(1)]-E[Y(0)]"</span>],</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">se =</span> x[i, <span class="st">"standard_error"</span>],</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd =</span> sd,</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">delta =</span> delta,</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">true =</span> <span class="dv">0</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If E_value is NA, set it to 1</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(row_evalue[<span class="dv">2</span>, <span class="st">"lower"</span>])) {</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>      row_evalue[<span class="dv">2</span>, <span class="st">"lower"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(row_evalue[<span class="dv">2</span>, <span class="st">"upper"</span>])) {</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>      row_evalue[<span class="dv">2</span>, <span class="st">"upper"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="fu">round</span>(<span class="fu">as.data.frame</span>(row_evalue)[<span class="dv">2</span>, ], <span class="dv">3</span>)) <span class="co"># exclude the NA column</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  evalues_df <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, evalues_list)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(evalues_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"E_Value"</span>, <span class="st">"E_Val_bound"</span>)</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>  tab_p <span class="ot">&lt;-</span> <span class="fu">cbind</span>(x, evalues_df)</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>  tab <span class="ot">&lt;-</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    tab_p <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">c</span>(</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>      <span class="st">"E[Y(1)]-E[Y(0)]"</span>,</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>      <span class="st">"lower_ci"</span>,</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>      <span class="st">"upper_ci"</span>,</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>      <span class="st">"E_Value"</span>,</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>      <span class="st">"E_Val_bound"</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(tab)</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="co"># extra packages we need</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a><span class="co"># for efa/cfa</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(psych)) {</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"psych"</span>)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"psych"</span>)</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a><span class="co"># for reporting</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(parameters)) {</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"parameters"</span>)</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"parameters"</span>)</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a><span class="co"># for graphing</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(see)) {</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"see"</span>)</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"see"</span>)</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a><span class="co"># for graphing</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(lavaan)) {</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"lavaan"</span>)</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"lavaan"</span>)</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a><span class="co"># for graphing</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(datawizard)) {</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"datawizard"</span>)</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"datawizard"</span>)</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="import-the-data" class="level3">
<h3 class="anchored" data-anchor-id="import-the-data">Import the data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This will read the synthetic data into Rstudio.  Note that the arrow package allows us to have lower memory demands in the storage and retrieval of data.</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>nzavs_synth <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"nzavs_dat_synth_t10_t12"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we will inspect column names.</p>
<p>Make sure to familiarise your self with the variable names <a href="https://github.com/go-bayes/psych-434-2023/blob/main/data/readme.qmd">here</a></p>
<p>It is alwasy a good idea to plot the data (do on your own time.)</p>
</section>
</section>
<section id="revisit-the-checklist" class="level2">
<h2 class="anchored" data-anchor-id="revisit-the-checklist">Revisit the checklist</h2>
<p>As we delve deeper, it’s essential to remember our checklist:</p>
<ol type="1">
<li>Clearly state your question.</li>
<li>Explain its relevance.</li>
<li>Ensure your question is causal.</li>
<li>Develop a subgroup analysis question if applicable.</li>
</ol>
<p>Our discussion today revolves around two main questions:</p>
<ol type="1">
<li>Does exercise influence anxiety/depression?</li>
<li>Do these effects differ among NZ Europeans and Māori?</li>
</ol>
<p>While these questions offer a starting point, they lack specificity. We need to clarify:</p>
<ul>
<li>The amount, regularity, and duration of exercise</li>
<li>The measures of depression to be used</li>
<li>The expected timeline for observing the effects</li>
</ul>
<p>Remember, we can clarify these by emulating a hypothetical experiment, a concept we call the <strong>Target Trial</strong>.</p>
<p>Our initial responses will be guided by the NZAVS measure of exercise, focusing on the hours of activity per week, the 1-year effect on Kessler-6 depression after initiating a change in exercise, and a particular emphasis on effect-modification by NZ European and Māori ethnic identification.</p>
<p>This analysis has practical motivation, as the effects of exercise on mental health and possible differences between cultural groups remain largely uncharted territory.</p>
<p>Our initial responses will be guided by the NZAVS measure of exercise, focusing on the hours of activity per week, the 1-year effect on Kessler-6 depression after initiating a change in exercise, and a particular emphasis on effect-modification by NZ European and Māori ethnic identification. This analysis has practical motivation, as the effects of exercise on mental health and possible differences between cultural groups remain largely uncharted territory.</p>
<section id="sculpting-the-data-a-hands-on-approach" class="level3">
<h3 class="anchored" data-anchor-id="sculpting-the-data-a-hands-on-approach">Sculpting the Data: A Hands-On Approach</h3>
<p>As we venture further, we’ll perform a series of transformations to shape our data according to our needs. Our process will involve:</p>
<ol type="1">
<li>Constructing a Kessler 6 average score</li>
<li>Building a Kessler 6 sum score</li>
<li>Coarsening the Exercise score</li>
</ol>
<p>Consider the ambiguity in the NZAVS exercise question: “During the past week, list ‘Hours spent exercising/physical activity’.” Different people interpret physical activity differently; John may consider any wakeful time as physical activity, while Jane counts only aerobic exercise. Such variation underlines the importance of the consistency assumption in causal inference. But we’ll delve deeper into that later.</p>
<p>For now, let’s transform our indicators.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create sum score of kessler 6</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>dt_start <span class="ot">&lt;-</span> nzavs_synth <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">%&gt;%</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lifesat_composite  =</span> <span class="fu">mean</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(lifesat_satlife,                         </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    lifesat_ideal) ))<span class="sc">|&gt;</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">kessler_6  =</span> <span class="fu">mean</span>(</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Specify the Kessler scale items</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>      kessler_depressed,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel so depressed that nothing could cheer you up?</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>      kessler_hopeless,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel hopeless?</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>      kessler_nervous,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel nervous?</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>      kessler_effort,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel that everything was an effort?</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>      kessler_restless,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel restless or fidgety ?</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>      kessler_worthless  <span class="co"># During the last 30 days, how often did you feel worthless?</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">|&gt;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">kessler_6_sum =</span> <span class="fu">round</span>(<span class="fu">sum</span>(</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span> (</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>      kessler_depressed,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>      kessler_hopeless,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>      kessler_nervous,</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>      kessler_effort,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>      kessler_restless,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>      kessler_worthless</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">0</span>)) <span class="sc">|&gt;</span>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Coarsen 'hours_exercise' into categories</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">hours_exercise_coarsen =</span> <span class="fu">cut</span>(</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>      hours_exercise,</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Hours spent exercising/ physical activity</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">8</span>, <span class="dv">200</span>),</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"inactive"</span>,</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"active"</span>,</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"very_active"</span>),</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Define thresholds for categories</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"(-1,3]"</span>, <span class="st">"(3,8]"</span>, <span class="st">"(8,200]"</span>),</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">ordered =</span> <span class="cn">TRUE</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    ))<span class="sc">|&gt;</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a binary 'urban' variable based on the 'rural_gch2018' variable</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">urban =</span> <span class="fu">factor</span>(</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>      rural_gch2018 <span class="sc">==</span> <span class="st">"medium_urban_accessibility"</span> <span class="sc">|</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define urban condition</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        rural_gch2018 <span class="sc">==</span> <span class="st">"high_urban_accessibility"</span>,</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>      <span class="st">"urban"</span>,</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Label 'urban' if condition is met</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>      <span class="st">"rural"</span>  <span class="co"># Label 'rural' if condition is not met</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Why do we coarsen the exposure? Recall the consistency assumption of causal inference:</p>
<p><strong>Consistency:</strong> Can I interpret what it means to intervene on the exposure? I should be able to.</p>
<p><strong>What is th hypothetical experiment here for change in exercise?</strong></p>
<p>Through data wrangling, we can answer our research questions more effectively by manipulating variables into more meaningful and digestible forms. We imagine an experiment in which people were within one band of the coarsened exercise band and we</p>
<p>These data checks will ensure the accuracy and reliability of our transformations, setting the foundation for solid data analysis.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># do some checks</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(dt_start<span class="sc">$</span>hours_exercise_coarsen)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dt_start<span class="sc">$</span>hours_exercise_coarsen)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(dt_start<span class="sc">$</span>hours_exercise)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(dt_start<span class="sc">$</span>hours_exercise)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># checks</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># justification for transforming exercise" has a very long tail</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dt_start<span class="sc">$</span>hours_exercise, <span class="at">breaks =</span> <span class="dv">1000</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># consider only those cases below &lt; or = to 20</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">subset</span>(dt_start, hours_exercise <span class="sc">&lt;=</span> <span class="dv">20</span>)<span class="sc">$</span>hours_exercise)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">as.numeric</span>(dt_start<span class="sc">$</span>hours_exercise_coarsen))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="create-variables-for-the-latent-factors" class="level3">
<h3 class="anchored" data-anchor-id="create-variables-for-the-latent-factors">Create variables for the latent factors</h3>
<p>Let’s next get the data into shape for analysis. Here we create a variable for the two factors (see Appendix)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get two factors from data</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>dt_start2 <span class="ot">&lt;-</span> dt_start <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">kessler_latent_depression =</span> <span class="fu">mean</span>(<span class="fu">c</span>(kessler_depressed, kessler_hopeless, kessler_effort), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">kessler_latent_anxiety  =</span> <span class="fu">mean</span>(<span class="fu">c</span>(kessler_effort, kessler_nervous, kessler_restless), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Inspect the data: anxiety</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#hist(dt_start2$kessler_latent_anxiety, by = dt_start2$eth_cat)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>create_histograms_anxiety <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># require patchwork</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(patchwork)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># separate the data by eth_cat</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  df1 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(eth_cat <span class="sc">==</span> <span class="st">"euro"</span>) <span class="co"># replace "level_1" with actual level</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(eth_cat <span class="sc">==</span> <span class="st">"māori"</span>) <span class="co"># replace "level_2" with actual level</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create the histograms</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df1, <span class="fu">aes</span>(<span class="at">x=</span>kessler_latent_anxiety)) <span class="sc">+</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"dodgerblue"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Kessler Latent Anxiety: NZ Euro"</span>) <span class="sc">+</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"kessler_latent_anxiety"</span>) <span class="sc">+</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Count"</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(<span class="at">x=</span>kessler_latent_anxiety)) <span class="sc">+</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"brown"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Kessler Latent Anxiety: Māori"</span>) <span class="sc">+</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"kessler_latent_anxiety"</span>) <span class="sc">+</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Count"</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot the histograms</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a> p1 <span class="sc">+</span> p2 <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"a"</span>, <span class="at">title =</span> <span class="st">"comparison of anxiety histograms"</span>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="fu">create_histograms_anxiety</span>(dt_start2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="10-content_files/figure-html/histogram_kessler_anxiety-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>create_histograms_depression <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># require patchwork</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(patchwork)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># separate the data by eth_cat</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  df11 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(eth_cat <span class="sc">==</span> <span class="st">"euro"</span>) <span class="co"># replace "level_1" with actual level</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  df22 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(eth_cat <span class="sc">==</span> <span class="st">"māori"</span>) <span class="co"># replace "level_2" with actual level</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create the histograms</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  p11 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df11, <span class="fu">aes</span>(<span class="at">x=</span>kessler_latent_depression)) <span class="sc">+</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"dodgerblue"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Kessler Latent Depression: NZ Euro"</span>) <span class="sc">+</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"kessler_latent_depression"</span>) <span class="sc">+</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Count"</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  p22 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df22, <span class="fu">aes</span>(<span class="at">x=</span>kessler_latent_depression)) <span class="sc">+</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"brown"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Kessler Latent Depression: Māori"</span>) <span class="sc">+</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"kessler_latent_depression"</span>) <span class="sc">+</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Count"</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot the histograms</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a> p11 <span class="sc">+</span> p22 <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"a"</span>, <span class="at">title =</span> <span class="st">"comparison of depression histograms"</span>)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="fu">create_histograms_depression</span>(dt_start2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="10-content_files/figure-html/histogram_kessler_depression-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>What do you make of these histograms?</p>
</section>
</section>
<section id="investigate-assumption-of-positivity" class="level2">
<h2 class="anchored" data-anchor-id="investigate-assumption-of-positivity">Investigate assumption of positivity:</h2>
<p>Recall the positive assumption:</p>
<p><strong>Positivity:</strong> Can we intervene on the exposure at all levels of the covariates? We should be able to.</p>
<p>Not this is just a description of the the summary scores. We do not assess change within indivuals</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#  select only the baseline year and the exposure year.  That will give us change in the exposure. ()</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>dt_exposure <span class="ot">&lt;-</span> dt_start2 <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select baseline year and exposure year</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(wave <span class="sc">==</span> <span class="st">"2018"</span> <span class="sc">|</span> wave <span class="sc">==</span> <span class="st">"2019"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select variables of interest</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, wave, hours_exercise_coarsen,  eth_cat) <span class="sc">|&gt;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the categorical variable needs to be numeric for us to use msm package to investigate change</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hours_exercise_coarsen_n =</span> <span class="fu">as.numeric</span>(hours_exercise_coarsen)) <span class="sc">|&gt;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>dt_exposure <span class="sc">|&gt;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabyl</span>(hours_exercise_coarsen_n, eth_cat,  wave )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$`2018`
 hours_exercise_coarsen_n euro māori pacific asian
                        1 3238   319      78   170
                        2 3790   341      81   130
                        3 1613   161      31    48

$`2019`
 hours_exercise_coarsen_n euro māori pacific asian
                        1 2880   307      79   143
                        2 3927   354      82   141
                        3 1834   160      29    64</code></pre>
</div>
</div>
<p>I’ve written a function called <code>transition_table</code> that will help us assess change in the exposure at the individual level.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#   consider people going from active to vary active</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> msm<span class="sc">::</span><span class="fu">statetable.msm</span>(<span class="fu">round</span>(hours_exercise_coarsen_n, <span class="dv">0</span>), id, <span class="at">data =</span> dt_exposure)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># for a function I wrote to create state tables</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>state_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Inactive"</span>, <span class="st">"Somewhat Active"</span>, <span class="st">"Active"</span>, <span class="st">"Extremely Active"</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># transition table</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="fu">transition_table</span>(out, state_names)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$explanation
[1] "This transition matrix describes the shifts from one state to another between the baseline wave and the following wave. The numbers in the cells represent the number of individuals who transitioned from one state (rows) to another (columns). For example, the cell in the first row and second column shows the number of individuals who transitioned from the first state (indicated by the left-most cell in the row) to the second state. The top left cell shows the number of individuals who remained in the first state."

$table


|      From       | Inactive | Somewhat Active | Active |
|:---------------:|:--------:|:---------------:|:------:|
|    Inactive     |   2186   |      1324       |  295   |
| Somewhat Active |   1019   |      2512       |  811   |
|     Active      |   204    |       668       |  981   |</code></pre>
</div>
</div>
<p>Next consider Māori only</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Maori only</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>dt_exposure_maori <span class="ot">&lt;-</span> dt_exposure <span class="sc">|&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eth_cat <span class="sc">==</span> <span class="st">"māori"</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>out_m <span class="ot">&lt;-</span> msm<span class="sc">::</span><span class="fu">statetable.msm</span>(<span class="fu">round</span>(hours_exercise_coarsen_n, <span class="dv">0</span>), id, <span class="at">data =</span> dt_exposure_maori)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># with this little support we might consider parametric models</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>t_tab_m<span class="ot">&lt;-</span> <span class="fu">transition_table</span>( out_m, state_names)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">#interpretation</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(t_tab_m<span class="sc">$</span>explanation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>This transition matrix describes the shifts from one state to another between the baseline wave and the following wave. The numbers in the cells represent the number of individuals who transitioned from one state (rows) to another (columns). For example, the cell in the first row and second column shows the number of individuals who transitioned from the first state (indicated by the left-most cell in the row) to the second state. The top left cell shows the number of individuals who remained in the first state.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(t_tab_m<span class="sc">$</span>table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

|      From       | Inactive | Somewhat Active | Active |
|:---------------:|:--------:|:---------------:|:------:|
|    Inactive     |   187    |       108       |   24   |
| Somewhat Active |    92    |       188       |   61   |
|     Active      |    28    |       58        |   75   |</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filter euro</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>dt_exposure_euro <span class="ot">&lt;-</span> dt_exposure <span class="sc">|&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eth_cat <span class="sc">==</span> <span class="st">"euro"</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># model change</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>out_e <span class="ot">&lt;-</span> msm<span class="sc">::</span><span class="fu">statetable.msm</span>(<span class="fu">round</span>(hours_exercise_coarsen_n, <span class="dv">0</span>), id, <span class="at">data =</span> dt_exposure_euro)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co"># creat transition table.</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>t_tab_e <span class="ot">&lt;-</span> <span class="fu">transition_table</span>( out_e, state_names)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">#interpretation</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(t_tab_e<span class="sc">$</span>explanation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>This transition matrix describes the shifts from one state to another between the baseline wave and the following wave. The numbers in the cells represent the number of individuals who transitioned from one state (rows) to another (columns). For example, the cell in the first row and second column shows the number of individuals who transitioned from the first state (indicated by the left-most cell in the row) to the second state. The top left cell shows the number of individuals who remained in the first state.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># table</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(t_tab_e<span class="sc">$</span>table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

|      From       | Inactive | Somewhat Active | Active |
|:---------------:|:--------:|:---------------:|:------:|
|    Inactive     |   1843   |      1136       |  259   |
| Somewhat Active |   870    |      2208       |  712   |
|     Active      |   167    |       583       |  863   |</code></pre>
</div>
</div>
<p>Overall we find evidence for change in the exposure variable. This suggest that we are ready to proceed with the next step of causal estimation.</p>
<section id="create-wide-data-frame-for-analysis" class="level3">
<h3 class="anchored" data-anchor-id="create-wide-data-frame-for-analysis">Create wide data frame for analysis</h3>
<p>Recall, I wrote a function for you that will put the data into temporal order such that measurement of the exposure and outcome appear at baseline, along with a rich set of baseline confounders, the exposure appears in the following wave, and the outcome appears in the wave following the exposure.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-dag-6" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="10-content_files/figure-html/fig-dag-6-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Causal graph: three-wave panel design</figcaption>
</figure>
</div>
</div>
</div>
<p>The graph encodes our assumptions about the world. It is a qualitative instrument to help us understand how to move from our assumptions to decisions about our analysis, in the first instance, the decision about whether to proceed with an analysis.</p>
<p>It is perhaps useful here to stop and consider what does this graph implies.</p>
<p>Question: 1. Does the graph imply unmeasured confounding?</p>
<p>Question 2. If there is unmeasured confounding, should we proceed?</p>
</section>
<section id="e-value" class="level3">
<h3 class="anchored" data-anchor-id="e-value">E-value</h3>
<blockquote class="blockquote">
<p>The minimum strength of association on the risk ratio scale that an unmeasured confounder would need to have with both the exposure and the outcome, conditional on the measured covariates, to fully explain away a specific exposure-outcome association</p>
</blockquote>
<p>See: <span class="citation" data-cites="vanderweele2020">(<a href="#ref-vanderweele2020" role="doc-biblioref">VanderWeele, Mathur, and Chen 2020</a>)</span></p>
<p>For example, suppose that the lower bound of the the E-value was 1.3 with the lower bound of the confidence interval = 1.12, we might then write:</p>
<blockquote class="blockquote">
<p>With an observed risk ratio of RR=1.3, an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of 1.3-fold each (or 30%), above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of 1.12-fold (or 12%) each could do so, but weaker joint confounder associations could not.</p>
</blockquote>
<p>The equations are as follows (for risk ratios)</p>
<p><span class="math display">
E-value_{RR} = RR + \sqrt{RR \times (RR - 1)}
</span> <span class="math display">
E-value_{LCL} = LCL + \sqrt{LCL \times (LCL - 1)}
</span></p>
<p>Here is an R function that will calculate E-values</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>calculate_e_value <span class="ot">&lt;-</span> <span class="cf">function</span>(rr, lcl) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  e_value_rr <span class="ot">=</span> rr <span class="sc">+</span> <span class="fu">sqrt</span>(rr<span class="sc">*</span>(rr <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  e_value_lcl <span class="ot">=</span> lcl <span class="sc">+</span> <span class="fu">sqrt</span>(lcl<span class="sc">*</span>(lcl <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">e_value_rr =</span> e_value_rr, <span class="at">e_value_lcl =</span> e_value_lcl)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co"># e.g. smoking causes cancer</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># finding   RR = 10.73 (95% CI: 8.02, 14.36)</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="fu">calculate_e_value</span>(<span class="fl">10.73</span>, <span class="fl">8.02</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$e_value_rr
[1] 20.94777

$e_value_lcl
[1] 15.52336</code></pre>
</div>
</div>
<p>We write:</p>
<blockquote class="blockquote">
<p>With an observed risk ratio of RR=10.7, an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of 20.9-fold each, above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of 15.5-fold each could do so, but weaker joint confounder associations could not.</p>
</blockquote>
<p>Note that in this class, most of the outcomes will be (standardised) continuous outcomes. Here’s a function and LaTeX code to describe the approximation.</p>
<p>This function takes a linear regression coefficient estimate (<code>est</code>), its standard error (<code>se</code>), the standard deviation of the outcome (<code>sd</code>), a contrast of interest in the exposure (<code>delta</code>, which defaults to 1), and a “true” standardized mean difference (true, which defaults to 0). It calculates the odds ratio using the formula from Chinn (2000) and VanderWeele (2017), and then uses this to calculate the E-value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: evalue_ols</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>compute_evalue_ols <span class="ot">&lt;-</span> <span class="cf">function</span>(est, se, <span class="at">delta =</span> <span class="dv">1</span>, <span class="at">true =</span> <span class="dv">0</span>) {</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rescale estimate and SE to reflect a contrast of size delta</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  est <span class="ot">&lt;-</span> est <span class="sc">/</span> delta</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  se <span class="ot">&lt;-</span> se <span class="sc">/</span> delta</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute transformed odds ratio and confidence intervals</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  odds_ratio <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fl">0.91</span> <span class="sc">*</span> est)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  lo <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fl">0.91</span> <span class="sc">*</span> est <span class="sc">-</span> <span class="fl">1.78</span> <span class="sc">*</span> se)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  hi <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fl">0.91</span> <span class="sc">*</span> est <span class="sc">+</span> <span class="fl">1.78</span> <span class="sc">*</span> se)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute E-Values based on the RR values</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  evalue_point_estimate <span class="ot">&lt;-</span> odds_ratio <span class="sc">*</span> <span class="fu">sqrt</span>(odds_ratio <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  evalue_lower_ci <span class="ot">&lt;-</span> lo <span class="sc">*</span> <span class="fu">sqrt</span>(lo <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return the E-values</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">EValue_PointEstimate =</span> evalue_point_estimate,</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>              <span class="at">EValue_LowerCI =</span> evalue_lower_ci))</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="co"># exampl:</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="co"># suppose we have an estimate of 0.5, a standard error of 0.1, and a standard deviation of 1.</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="co"># This would correspond to a half a standard deviation increase in the outcome per unit increase in the exposure.</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">compute_evalue_ols</span>(<span class="at">est =</span> <span class="fl">0.5</span>, <span class="at">se =</span> <span class="fl">0.1</span>, <span class="at">delta =</span> <span class="dv">1</span>)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$EValue_PointEstimate
[1] 2.529831

$EValue_LowerCI
[1] 2.008933</code></pre>
</div>
</div>
<p>We write:</p>
<blockquote class="blockquote">
<p>With an observed risk ratio of RR=2.92, an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of 2.92-fold each, above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of 2.23-fold each could do so, but weaker joint confounder associations could not.</p>
</blockquote>
<p>Note the E-values package will do the computational work for us (note we get slightly different estimates)</p>
<p>Note:</p>
<p>First, the fucntion converts the estimate to an odds ratio:</p>
<ol type="1">
<li><p><strong>Odds Ratio Conversion</strong>:</p>
<p>(OddsRatio = e^{ })</p></li>
</ol>
<p>Then, it calculates the confidence intervals for the odds ratio:</p>
<ol start="2" type="1">
<li><p><strong>Confidence Intervals</strong>:</p>
<p>(LowerConfidenceInterval = e^{log(OddsRatio) - 1.78 SE})</p>
<p>(UpperConfidenceInterval = e^{log(OddsRatio) + 1.78 SE})</p></li>
</ol>
<p>Finally, it calculates the E-value for the point estimate and the lower confidence interval:</p>
<ol start="3" type="1">
<li><p><strong>E-Values Calculation</strong>:</p>
<p>(EValue_{PointEstimate} = OddsRatio + )</p>
<p>(EValue_{LowerCI} = LowerConfidenceInterval + )</p></li>
</ol>
<p>[[JB: NEED TO CHECK]]</p>
<p>Generally, best to use the EValue function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(EValue)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>EValue<span class="sc">::</span><span class="fu">evalues.OLS</span>(<span class="at">est =</span> <span class="fl">0.5</span>, <span class="at">se =</span> <span class="fl">0.1</span>, <span class="at">sd =</span> <span class="dv">1</span>, <span class="at">delta =</span> <span class="dv">1</span>, <span class="at">true =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            point    lower    upper
RR       1.576173 1.319166 1.883252
E-values 2.529142 1.968037       NA</code></pre>
</div>
</div>
<div class="cell" data-table="wide_data">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="do">############## ############## ############## ############## ############## ############## ############## ########</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="do">####  ####  ####  CREATE DATA FRAME FOR ANALYSIS ####  ####  ################## ############## ######## #########</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="do">############## ############## ############## ############## ############## ############## ############# #########</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># I have created a function that will put the data into the correct shape. Here are the steps.</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: choose baseline variables (confounders).  here we select standard demographic variablees plus personality variables.</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Note again that the function will automatically include the baseline exposure and basline outcome in the baseline variable confounder set so you don't need to include these. </span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co"># here are some plausible baseline confounders</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"edu"</span>,</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"male"</span>,</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"eth_cat"</span>,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"employed"</span>,</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gen_cohort"</span>,</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nz_dep2018"</span>, <span class="co"># nz dep</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nzsei13"</span>, <span class="co"># occupational prestige</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"partner"</span>,</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"parent"</span>,</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pol_orient"</span>,</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a> <span class="co"># "rural_gch2018",</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>   <span class="st">"urban"</span>, <span class="co"># use the two level urban varaible. </span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"agreeableness"</span>,</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"conscientiousness"</span>,</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"extraversion"</span>,</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"honesty_humility"</span>,</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"openness"</span>,</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"neuroticism"</span>,</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"modesty"</span>,</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"religion_identification_level"</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a><span class="do">## Step 2, select the exposure variable.  This is the "cause"</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>exposure_var <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"hours_exercise_coarsen"</span>)</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a><span class="do">## step 3. select the outcome variable.  These are the outcomes.</span></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>outcome_vars_reflective <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"kessler_latent_anxiety"</span>,</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"kessler_latent_depression"</span>)</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a><span class="co"># the function "create_wide_data" should be in your environment.</span></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a><span class="co"># If not, make sure to run the first line of code in this script once more.  You may ignore the warnings. or uncomment and run the code below</span></span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a><span class="co"># source("https://raw.githubusercontent.com/go-bayes/templates/main/functions/funs.R")</span></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>dt_prepare <span class="ot">&lt;-</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">create_wide_data</span>(</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">dat_long =</span> dt_start2,</span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">baseline_vars =</span> baseline_vars,</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">exposure_var =</span> exposure_var,</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome_vars =</span> outcome_vars_reflective</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using an external vector in selections was deprecated in tidyselect 1.1.0.
ℹ Please use `all_of()` or `any_of()` instead.
  # Was:
  data %&gt;% select(exclude_vars)

  # Now:
  data %&gt;% select(all_of(exclude_vars))

See &lt;https://tidyselect.r-lib.org/reference/faq-external-vector.html&gt;.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using an external vector in selections was deprecated in tidyselect 1.1.0.
ℹ Please use `all_of()` or `any_of()` instead.
  # Was:
  data %&gt;% select(t0_column_order)

  # Now:
  data %&gt;% select(all_of(t0_column_order))

See &lt;https://tidyselect.r-lib.org/reference/faq-external-vector.html&gt;.</code></pre>
</div>
</div>
</section>
</section>
<section id="descriptive-table" class="level2">
<h2 class="anchored" data-anchor-id="descriptive-table">Descriptive table</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I have created a function that will allow you to take a data frame and</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># create a table</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">baseline_table</span>(dt_prepare, <span class="at">output_format =</span> <span class="st">"markdown"</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># but it is not very nice. Next up, is a better table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get data into shape</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>dt_new <span class="ot">&lt;-</span> dt_prepare <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"t0"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_all</span>( <span class="sc">~</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(., <span class="st">"^t0_"</span>, <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">wave =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="st">"baseline"</span>, <span class="fu">nrow</span>(dt_prepare)))) <span class="sc">|&gt;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>(<span class="at">case =</span> <span class="st">"screaming_snake"</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co"># create a formula string</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>baseline_vars_names <span class="ot">&lt;-</span> dt_new <span class="sc">%&gt;%</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>WAVE) <span class="sc">%&gt;%</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>()</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>table_baseline_vars <span class="ot">&lt;-</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(baseline_vars_names, <span class="at">collapse =</span> <span class="st">"+"</span>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>formula_string_table_baseline <span class="ot">&lt;-</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="st">"~"</span>, table_baseline_vars, <span class="st">"|WAVE"</span>)</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>table1<span class="sc">::</span><span class="fu">table1</span>(<span class="fu">as.formula</span>(formula_string_table_baseline),</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> dt_new,</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>               <span class="at">overall =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div class="Rtable1">
<table class="Rtable1 table table-sm table-striped small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th class="rowlabel firstrow lastrow" data-quarto-table-cell-role="th"></th>
<th class="firstrow lastrow" data-quarto-table-cell-role="th"><span class="stratlabel">baseline<br>
<span class="stratn">(N=10000)</span></span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowlabel firstrow">EDU</td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">Mean (SD)</td>
<td>5.85 (2.59)</td>
</tr>
<tr class="odd">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">6.96 [-0.128, 10.1]</td>
</tr>
<tr class="even">
<td class="rowlabel firstrow">MALE</td>
<td class="firstrow"></td>
</tr>
<tr class="odd">
<td class="rowlabel">Male</td>
<td>3905 (39.1%)</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">Not_male</td>
<td class="lastrow">6095 (61.0%)</td>
</tr>
<tr class="odd">
<td class="rowlabel firstrow">ETH_CAT</td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">euro</td>
<td>8641 (86.4%)</td>
</tr>
<tr class="odd">
<td class="rowlabel">māori</td>
<td>821 (8.2%)</td>
</tr>
<tr class="even">
<td class="rowlabel">pacific</td>
<td>190 (1.9%)</td>
</tr>
<tr class="odd">
<td class="rowlabel lastrow">asian</td>
<td class="lastrow">348 (3.5%)</td>
</tr>
<tr class="even">
<td class="rowlabel firstrow">EMPLOYED</td>
<td class="firstrow"></td>
</tr>
<tr class="odd">
<td class="rowlabel">Mean (SD)</td>
<td>0.836 (0.370)</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">1.00 [0, 1.00]</td>
</tr>
<tr class="odd">
<td class="rowlabel firstrow">GEN_COHORT</td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">Gen_Silent: born&lt; 1946</td>
<td>166 (1.7%)</td>
</tr>
<tr class="odd">
<td class="rowlabel">Gen Boomers: born &gt;= 1946 &amp; b.&lt; 1965</td>
<td>4257 (42.6%)</td>
</tr>
<tr class="even">
<td class="rowlabel">GenX: born &gt;=1961 &amp; b.&lt; 1981</td>
<td>3493 (34.9%)</td>
</tr>
<tr class="odd">
<td class="rowlabel">GenY: born &gt;=1981 &amp; b.&lt; 1996</td>
<td>1883 (18.8%)</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">GenZ: born &gt;= 1996</td>
<td class="lastrow">201 (2.0%)</td>
</tr>
<tr class="odd">
<td class="rowlabel firstrow">NZ_DEP2018</td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">Mean (SD)</td>
<td>4.46 (2.65)</td>
</tr>
<tr class="odd">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">4.01 [0.835, 10.1]</td>
</tr>
<tr class="even">
<td class="rowlabel firstrow">NZSEI13</td>
<td class="firstrow"></td>
</tr>
<tr class="odd">
<td class="rowlabel">Mean (SD)</td>
<td>57.0 (16.1)</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">61.0 [9.91, 90.1]</td>
</tr>
<tr class="odd">
<td class="rowlabel firstrow">PARTNER</td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">Mean (SD)</td>
<td>0.795 (0.404)</td>
</tr>
<tr class="odd">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">1.00 [0, 1.00]</td>
</tr>
<tr class="even">
<td class="rowlabel firstrow">PARENT</td>
<td class="firstrow"></td>
</tr>
<tr class="odd">
<td class="rowlabel">Mean (SD)</td>
<td>0.706 (0.456)</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">1.00 [0, 1.00]</td>
</tr>
<tr class="odd">
<td class="rowlabel firstrow">POL_ORIENT</td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">Mean (SD)</td>
<td>3.47 (1.40)</td>
</tr>
<tr class="odd">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">3.09 [0.862, 7.14]</td>
</tr>
<tr class="even">
<td class="rowlabel firstrow">URBAN</td>
<td class="firstrow"></td>
</tr>
<tr class="odd">
<td class="rowlabel">rural</td>
<td>1738 (17.4%)</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">urban</td>
<td class="lastrow">8262 (82.6%)</td>
</tr>
<tr class="odd">
<td class="rowlabel firstrow">AGREEABLENESS</td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">Mean (SD)</td>
<td>5.36 (0.986)</td>
</tr>
<tr class="odd">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">5.48 [0.977, 7.13]</td>
</tr>
<tr class="even">
<td class="rowlabel firstrow">CONSCIENTIOUSNESS</td>
<td class="firstrow"></td>
</tr>
<tr class="odd">
<td class="rowlabel">Mean (SD)</td>
<td>5.19 (1.03)</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">5.28 [0.938, 7.16]</td>
</tr>
<tr class="odd">
<td class="rowlabel firstrow">EXTRAVERSION</td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">Mean (SD)</td>
<td>3.85 (1.21)</td>
</tr>
<tr class="odd">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">3.80 [0.861, 7.07]</td>
</tr>
<tr class="even">
<td class="rowlabel firstrow">HONESTY_HUMILITY</td>
<td class="firstrow"></td>
</tr>
<tr class="odd">
<td class="rowlabel">Mean (SD)</td>
<td>5.52 (1.12)</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">5.71 [1.14, 7.15]</td>
</tr>
<tr class="odd">
<td class="rowlabel firstrow">OPENNESS</td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">Mean (SD)</td>
<td>5.06 (1.10)</td>
</tr>
<tr class="odd">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">5.12 [0.899, 7.15]</td>
</tr>
<tr class="even">
<td class="rowlabel firstrow">NEUROTICISM</td>
<td class="firstrow"></td>
</tr>
<tr class="odd">
<td class="rowlabel">Mean (SD)</td>
<td>3.41 (1.17)</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">3.31 [0.860, 7.08]</td>
</tr>
<tr class="odd">
<td class="rowlabel firstrow">MODESTY</td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">Mean (SD)</td>
<td>6.07 (0.860)</td>
</tr>
<tr class="odd">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">6.24 [2.17, 7.17]</td>
</tr>
<tr class="even">
<td class="rowlabel firstrow">RELIGION_IDENTIFICATION_LEVEL</td>
<td class="firstrow"></td>
</tr>
<tr class="odd">
<td class="rowlabel">Mean (SD)</td>
<td>2.19 (2.07)</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">1.00 [1.00, 7.00]</td>
</tr>
<tr class="odd">
<td class="rowlabel firstrow">HOURS_EXERCISE_COARSEN</td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">inactive</td>
<td>3805 (38.1%)</td>
</tr>
<tr class="odd">
<td class="rowlabel">active</td>
<td>4342 (43.4%)</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">very_active</td>
<td class="lastrow">1853 (18.5%)</td>
</tr>
<tr class="odd">
<td class="rowlabel firstrow">KESSLER_LATENT_ANXIETY</td>
<td class="firstrow"></td>
</tr>
<tr class="even">
<td class="rowlabel">Mean (SD)</td>
<td>1.16 (0.719)</td>
</tr>
<tr class="odd">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">1.03 [-0.0800, 4.03]</td>
</tr>
<tr class="even">
<td class="rowlabel firstrow">KESSLER_LATENT_DEPRESSION</td>
<td class="firstrow"></td>
</tr>
<tr class="odd">
<td class="rowlabel">Mean (SD)</td>
<td>0.744 (0.686)</td>
</tr>
<tr class="even">
<td class="rowlabel lastrow">Median [Min, Max]</td>
<td class="lastrow">0.646 [-0.0871, 4.02]</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># another method for making a table</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># x &lt;- table1::table1(as.formula(formula_string_table_baseline),</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">#                     data = dt_new,</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">#                     overall = FALSE)</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co"># # some options, see: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># table1::t1kable(x, format = "html", booktabs = TRUE) |&gt;</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   kable_material(c("striped", "hover"))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We need to do some more data wrangling, alas! Data wrangling is the majority of data analysis. The good news is that R makes wrangling relatively straightforward.</p>
<ol type="1">
<li><p><code>mutate(id = factor(1:nrow(dt_prepare)))</code>: This creates a new column called <code>id</code> that has unique identification factors for each row in the dataset. It ranges from 1 to the number of rows in the dataset.</p></li>
<li><p>The next <code>mutate</code> operation is used to convert the <code>t0_eth_cat</code>, <code>t0_urban</code>, and <code>t0_gen_cohort</code> variables to factor type, if they are not already.</p></li>
<li><p>The <code>filter</code> command is used to subset the dataset to only include rows where the <code>t0_eth_cat</code> is either “euro” or “māori”. The original dataset includes data with four different ethnic categories. This command filters out any row not related to these two groups.</p></li>
<li><p><code>ungroup()</code> ensures that there’s no grouping in the dataframe.</p></li>
<li><p>The <code>mutate(across(where(is.numeric), ~ scale(.x), .names = "{col}_z"))</code> step standardizes all numeric columns in the dataset by subtracting the mean and dividing by the standard deviation (a z-score transformation). The resulting columns are renamed to include “_z” at the end of their original names.</p></li>
<li><p>The <code>select</code> function is used to keep only specific columns: the <code>id</code> column, any columns that are factors, and any columns that end in “_z”.</p></li>
<li><p>The <code>relocate</code> functions re-order columns. The first <code>relocate</code> places the <code>id</code> column at the beginning. The next three <code>relocate</code> functions order the rest of the columns based on their names: those starting with “t0_” are placed before “t1_” columns, and those starting with “t2_” are placed after “t1_” columns.</p></li>
<li><p><code>droplevels()</code> removes unused factor levels in the dataframe.</p></li>
<li><p>Finally, <code>skimr::skim(dt)</code> will print out a summary of the data in the <code>dt</code> object using the skimr package. This provides a useful overview of the data, including data types and summary statistics.</p></li>
</ol>
<p>This function seems to be part of a data preparation pipeline in a longitudinal or panel analysis, where observations are ordered over time (indicated by t0_, t1_, t2_, etc.).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="do">### </span><span class="al">###</span><span class="do"> </span><span class="al">###</span><span class="do"> </span><span class="al">###</span><span class="do"> </span><span class="al">###</span><span class="do"> </span><span class="al">###</span><span class="do"> SUBGROUP DATA ANALYSIS: DATA WRANGLING  </span><span class="al">###</span><span class="do"> </span><span class="al">###</span><span class="do"> </span><span class="al">###</span><span class="do"> </span><span class="al">###</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> dt_prepare<span class="sc">|&gt;</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">factor</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(dt_prepare))) <span class="sc">|&gt;</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">t0_eth_cat =</span> <span class="fu">as.factor</span>(t0_eth_cat),</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">t0_urban =</span> <span class="fu">as.factor</span>(t0_urban),</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">t0_gen_cohort =</span> <span class="fu">as.factor</span>(t0_gen_cohort)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(t0_eth_cat <span class="sc">==</span> <span class="st">"euro"</span> <span class="sc">|</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>                t0_eth_cat <span class="sc">==</span> <span class="st">"māori"</span>) <span class="sc">|&gt;</span> <span class="co"># Too few asian and pacific</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># transform numeric variables into z scores (improves estimation)</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">scale</span>(.x), <span class="at">.names =</span> <span class="st">"{col}_z"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select only factors and numeric values that are z-scores</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, <span class="co"># category is too sparse</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>         <span class="fu">where</span>(is.factor),</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>         <span class="fu">ends_with</span>(<span class="st">"_z"</span>), ) <span class="sc">|&gt;</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tidy data frame so that the columns are ordered by time (useful for more complex models)</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(id, <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>))   <span class="sc">|&gt;</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"t0_"</span>), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>))  <span class="sc">|&gt;</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"t2_"</span>), <span class="at">.after =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="co"># view object</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>skimr<span class="sc">::</span><span class="fu">skim</span>(dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table style="width: auto;" class="table table-condensed">
<caption>
Data summary
</caption>
<tbody>
<tr>
<td style="text-align:left;">
Name
</td>
<td style="text-align:left;">
dt
</td>
</tr>
<tr>
<td style="text-align:left;">
Number of rows
</td>
<td style="text-align:left;">
9462
</td>
</tr>
<tr>
<td style="text-align:left;">
Number of columns
</td>
<td style="text-align:left;">
26
</td>
</tr>
<tr>
<td style="text-align:left;">
_______________________
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
Column type frequency:
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
factor
</td>
<td style="text-align:left;">
7
</td>
</tr>
<tr>
<td style="text-align:left;">
numeric
</td>
<td style="text-align:left;">
19
</td>
</tr>
<tr>
<td style="text-align:left;">
________________________
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
Group variables
</td>
<td style="text-align:left;">
None
</td>
</tr>
</tbody>

</table>
<p><strong>Variable type: factor</strong></p>

<table>
<thead>
<tr>
<th style="text-align:left;">
skim_variable
</th>
<th style="text-align:right;">
n_missing
</th>
<th style="text-align:right;">
complete_rate
</th>
<th style="text-align:left;">
ordered
</th>
<th style="text-align:right;">
n_unique
</th>
<th style="text-align:left;">
top_counts
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
id
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:right;">
9462
</td>
<td style="text-align:left;">
1: 1, 2: 1, 3: 1, 4: 1
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_male
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
Not: 5767, Mal: 3695
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_eth_cat
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
eur: 8641, māo: 821
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_gen_cohort
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:left;">
Gen: 4107, Gen: 3311, Gen: 1716, Gen: 164
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_urban
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
urb: 7762, rur: 1700
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_hours_exercise_coarsen
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
act: 4131, ina: 3557, ver: 1774
</td>
</tr>
<tr>
<td style="text-align:left;">
t1_hours_exercise_coarsen
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:left;">
act: 4281, ina: 3187, ver: 1994
</td>
</tr>
</tbody>

</table>
<p><strong>Variable type: numeric</strong></p>

<table>
<thead>
<tr>
<th style="text-align:left;">
skim_variable
</th>
<th style="text-align:right;">
n_missing
</th>
<th style="text-align:right;">
complete_rate
</th>
<th style="text-align:right;">
mean
</th>
<th style="text-align:right;">
sd
</th>
<th style="text-align:right;">
p0
</th>
<th style="text-align:right;">
p25
</th>
<th style="text-align:right;">
p50
</th>
<th style="text-align:right;">
p75
</th>
<th style="text-align:right;">
p100
</th>
<th style="text-align:left;">
hist
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
t0_edu_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-2.29
</td>
<td style="text-align:right;">
-1.05
</td>
<td style="text-align:right;">
0.44
</td>
<td style="text-align:right;">
0.82
</td>
<td style="text-align:right;">
1.66
</td>
<td style="text-align:left;">
▂▃▃▇▂
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_employed_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-2.26
</td>
<td style="text-align:right;">
0.44
</td>
<td style="text-align:right;">
0.44
</td>
<td style="text-align:right;">
0.44
</td>
<td style="text-align:right;">
0.44
</td>
<td style="text-align:left;">
▂▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_nz_dep2018_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-1.36
</td>
<td style="text-align:right;">
-0.92
</td>
<td style="text-align:right;">
-0.16
</td>
<td style="text-align:right;">
0.63
</td>
<td style="text-align:right;">
2.17
</td>
<td style="text-align:left;">
▇▆▆▅▂
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_nzsei13_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-2.94
</td>
<td style="text-align:right;">
-0.75
</td>
<td style="text-align:right;">
0.25
</td>
<td style="text-align:right;">
0.81
</td>
<td style="text-align:right;">
2.07
</td>
<td style="text-align:left;">
▁▃▅▇▁
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_partner_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-1.99
</td>
<td style="text-align:right;">
0.50
</td>
<td style="text-align:right;">
0.50
</td>
<td style="text-align:right;">
0.50
</td>
<td style="text-align:right;">
0.50
</td>
<td style="text-align:left;">
▂▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_parent_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-1.58
</td>
<td style="text-align:right;">
-1.58
</td>
<td style="text-align:right;">
0.63
</td>
<td style="text-align:right;">
0.63
</td>
<td style="text-align:right;">
0.63
</td>
<td style="text-align:left;">
▃▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_pol_orient_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-1.87
</td>
<td style="text-align:right;">
-1.02
</td>
<td style="text-align:right;">
-0.28
</td>
<td style="text-align:right;">
0.44
</td>
<td style="text-align:right;">
2.62
</td>
<td style="text-align:left;">
▇▆▇▅▂
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_agreeableness_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-4.46
</td>
<td style="text-align:right;">
-0.62
</td>
<td style="text-align:right;">
0.12
</td>
<td style="text-align:right;">
0.68
</td>
<td style="text-align:right;">
1.79
</td>
<td style="text-align:left;">
▁▁▃▇▆
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_conscientiousness_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-4.13
</td>
<td style="text-align:right;">
-0.65
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
0.76
</td>
<td style="text-align:right;">
1.91
</td>
<td style="text-align:left;">
▁▁▅▇▅
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_extraversion_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-2.48
</td>
<td style="text-align:right;">
-0.71
</td>
<td style="text-align:right;">
-0.04
</td>
<td style="text-align:right;">
0.72
</td>
<td style="text-align:right;">
2.67
</td>
<td style="text-align:left;">
▂▆▇▅▁
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_honesty_humility_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-3.95
</td>
<td style="text-align:right;">
-0.69
</td>
<td style="text-align:right;">
0.17
</td>
<td style="text-align:right;">
0.84
</td>
<td style="text-align:right;">
1.45
</td>
<td style="text-align:left;">
▁▁▃▆▇
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_openness_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-3.76
</td>
<td style="text-align:right;">
-0.71
</td>
<td style="text-align:right;">
0.05
</td>
<td style="text-align:right;">
0.81
</td>
<td style="text-align:right;">
1.90
</td>
<td style="text-align:left;">
▁▂▆▇▅
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_neuroticism_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-2.18
</td>
<td style="text-align:right;">
-0.76
</td>
<td style="text-align:right;">
-0.09
</td>
<td style="text-align:right;">
0.71
</td>
<td style="text-align:right;">
3.14
</td>
<td style="text-align:left;">
▃▇▇▃▁
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_modesty_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-4.67
</td>
<td style="text-align:right;">
-0.66
</td>
<td style="text-align:right;">
0.19
</td>
<td style="text-align:right;">
0.83
</td>
<td style="text-align:right;">
1.26
</td>
<td style="text-align:left;">
▁▁▂▅▇
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_religion_identification_level_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-0.56
</td>
<td style="text-align:right;">
-0.56
</td>
<td style="text-align:right;">
-0.56
</td>
<td style="text-align:right;">
-0.08
</td>
<td style="text-align:right;">
2.37
</td>
<td style="text-align:left;">
▇▁▁▁▂
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_kessler_latent_anxiety_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-1.72
</td>
<td style="text-align:right;">
-0.69
</td>
<td style="text-align:right;">
-0.19
</td>
<td style="text-align:right;">
0.70
</td>
<td style="text-align:right;">
4.01
</td>
<td style="text-align:left;">
▇▇▆▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
t0_kessler_latent_depression_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-1.21
</td>
<td style="text-align:right;">
-0.63
</td>
<td style="text-align:right;">
-0.13
</td>
<td style="text-align:right;">
0.42
</td>
<td style="text-align:right;">
4.83
</td>
<td style="text-align:left;">
▇▂▂▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
t2_kessler_latent_depression_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-1.23
</td>
<td style="text-align:right;">
-0.65
</td>
<td style="text-align:right;">
-0.16
</td>
<td style="text-align:right;">
0.39
</td>
<td style="text-align:right;">
4.75
</td>
<td style="text-align:left;">
▇▃▂▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
t2_kessler_latent_anxiety_z
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-1.74
</td>
<td style="text-align:right;">
-0.70
</td>
<td style="text-align:right;">
-0.20
</td>
<td style="text-align:right;">
0.68
</td>
<td style="text-align:right;">
3.97
</td>
<td style="text-align:left;">
▇▇▆▁▁
</td>
</tr>
</tbody>

</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># quick cross table</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co">#table( dt$t1_hours_exercise_coarsen, dt$t0_eth_cat )</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># checks</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dt<span class="sc">$</span>t2_kessler_latent_depression_z)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dt<span class="sc">$</span>t2_kessler_latent_anxiety_z)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>dt <span class="sc">|&gt;</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabyl</span>(t0_eth_cat, t1_hours_exercise_coarsen ) <span class="sc">|&gt;</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualise missingness</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(dt)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="co"># save your dataframe for future use</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="co"># make dataframe</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">as.data.frame</span>(dt)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="co"># save data</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dt, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"dt"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="propensity-scores" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="propensity-scores">Propensity scores</h2>
<p>Next we generate propensity scores. Instead of modelling the outcome (t2_y) we will model the exposure (t1_x) as predicted by baseline indicators (t0_c) that we assume may be associated with the outcome and the exposure.</p>
<p>The first step is to obtain the baseline variables. note that we must remove “t0_eth_cat” because we are performing separate weighting for each stratum within this variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read  data -- you may start here if you need to repeat the analysis</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"dt"</span>))</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># get column names</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>baseline_vars_reflective_propensity <span class="ot">&lt;-</span> dt<span class="sc">|&gt;</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"t0"</span>), <span class="sc">-</span>t0_eth_cat) <span class="sc">|&gt;</span> <span class="fu">colnames</span>()</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co"># define our exposure</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="st">"t1_hours_exercise_coarsen"</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co"># define subclasses</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="st">"t0_eth_cat"</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure data is in a data frame format</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(dt)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="co"># next we use our trick for creating a formula string, which will reduce our work</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>formula_str_prop <span class="ot">&lt;-</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(X,</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"~"</span>,</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste</span>(baseline_vars_reflective_propensity, <span class="at">collapse =</span> <span class="st">"+"</span>))</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="co"># this shows the exposure variable as predicted by the baseline confounders.</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>formula_str_prop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "t1_hours_exercise_coarsen ~ t0_male+t0_gen_cohort+t0_urban+t0_hours_exercise_coarsen+t0_edu_z+t0_employed_z+t0_nz_dep2018_z+t0_nzsei13_z+t0_partner_z+t0_parent_z+t0_pol_orient_z+t0_agreeableness_z+t0_conscientiousness_z+t0_extraversion_z+t0_honesty_humility_z+t0_openness_z+t0_neuroticism_z+t0_modesty_z+t0_religion_identification_level_z+t0_kessler_latent_anxiety_z+t0_kessler_latent_depression_z"</code></pre>
</div>
</div>
<p>For propensity score analysis, we will try several different approaches. We will want to select the method that produces the best balance.</p>
<p>I typically use <code>ps</code> (classical propensity scores), <code>ebal</code> and <code>energy</code>. The latter two in my experience yeild good balance. Also <code>energy</code> will work with <em>continuous</em> exposures.</p>
<p>For more information, see <a href="https://ngreifer.github.io/WeightIt/" class="uri">https://ngreifer.github.io/WeightIt/</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># traditional propensity scores-- note we select the ATT and we have a subgroup </span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>dt_match_ps <span class="ot">&lt;-</span> <span class="fu">match_mi_general</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dt,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_vars =</span> baseline_vars_reflective_propensity,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">subgroup =</span> <span class="st">"t0_eth_cat"</span>,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"ps"</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dt_match_ps, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"dt_match_ps"</span>))</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ebalance</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>dt_match_ebal <span class="ot">&lt;-</span> <span class="fu">match_mi_general</span>(</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dt,</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_vars =</span> baseline_vars_reflective_propensity,</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">subgroup =</span> <span class="st">"t0_eth_cat"</span>,</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"ebal"</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a><span class="co"># save output</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dt_match_ebal, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"dt_match_ebal"</span>))</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="do">## energy balance method</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>dt_match_energy <span class="ot">&lt;-</span> <span class="fu">match_mi_general</span>(</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dt,</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_vars =</span> baseline_vars_reflective_propensity,</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">subgroup =</span> <span class="st">"t0_eth_cat"</span>,</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">#focal = "high", # for use with ATT</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"energy"</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dt_match_energy, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"dt_match_energy"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Results, first for Europeans</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#dt_match_energy &lt;- readRDS(here::here("data", "dt_match_energy"))</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>dt_match_ebal <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"dt_match_ebal"</span>))</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co">#dt_match_ps &lt;- readRDS(here::here("data", "dt_match_ps"))</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># next we inspect balance. "Max.Diff.Adj" should ideally be less than .05, but less than .1 is ok. This is the standardised mean difference. The variance ratio should be less than 2. </span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co"># note that if the variables are unlikely to influence the outcome we can be less strict. </span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co">#See: Hainmueller, J. 2012. “Entropy Balancing for Causal Effects: A Multivariate Reweighting Method to Produce Balanced Samples in Observational Studies.” Political Analysis 20 (1): 25–46. https://doi.org/10.1093/pan/mpr025.</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Cole SR, Hernan MA. Constructing inverse probability weights for marginal structural models. American Journal of</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Epidemiology 2008; 168(6):656–664.</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Moving towards best practice when using inverse probability of treatment weighting (IPTW) using the propensity score to estimate causal treatment effects in observational studies</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Peter C. Austin, Elizabeth A. Stuart</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co"># https://onlinelibrary.wiley.com/doi/10.1002/sim.6607</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co">#bal.tab(dt_match_energy$euro)   #  good</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(dt_match_ebal<span class="sc">$</span>euro)   <span class="co">#  best</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance summary across all treatment pairs
                                                      Type Max.Diff.Adj
t0_male_Not_male                                    Binary       0.0001
t0_gen_cohort_Gen_Silent: born&lt; 1946                Binary       0.0001
t0_gen_cohort_Gen Boomers: born &gt;= 1946 &amp; b.&lt; 1965  Binary       0.0001
t0_gen_cohort_GenX: born &gt;=1961 &amp; b.&lt; 1981          Binary       0.0001
t0_gen_cohort_GenY: born &gt;=1981 &amp; b.&lt; 1996          Binary       0.0001
t0_gen_cohort_GenZ: born &gt;= 1996                    Binary       0.0000
t0_urban_urban                                      Binary       0.0001
t0_hours_exercise_coarsen_inactive                  Binary       0.0000
t0_hours_exercise_coarsen_active                    Binary       0.0000
t0_hours_exercise_coarsen_very_active               Binary       0.0000
t0_edu_z                                           Contin.       0.0000
t0_employed_z                                      Contin.       0.0003
t0_nz_dep2018_z                                    Contin.       0.0000
t0_nzsei13_z                                       Contin.       0.0000
t0_partner_z                                       Contin.       0.0001
t0_parent_z                                        Contin.       0.0001
t0_pol_orient_z                                    Contin.       0.0000
t0_agreeableness_z                                 Contin.       0.0000
t0_conscientiousness_z                             Contin.       0.0000
t0_extraversion_z                                  Contin.       0.0000
t0_honesty_humility_z                              Contin.       0.0001
t0_openness_z                                      Contin.       0.0000
t0_neuroticism_z                                   Contin.       0.0001
t0_modesty_z                                       Contin.       0.0001
t0_religion_identification_level_z                 Contin.       0.0001
t0_kessler_latent_anxiety_z                        Contin.       0.0001
t0_kessler_latent_depression_z                     Contin.       0.0000

Effective sample sizes
           inactive  active very_active
Unadjusted  2880.   3927.       1834.  
Adjusted    1855.89 3659.59     1052.01</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">#bal.tab(dt_match_ps$euro)   #  not as good</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># here we show only the best tab, but you should put all information into an appendix</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Results for Maori</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># who only Ebal</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">#bal.tab(dt_match_energy$māori)   #  good</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(dt_match_ebal<span class="sc">$</span>māori)   <span class="co">#  best</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance summary across all treatment pairs
                                                      Type Max.Diff.Adj
t0_male_Not_male                                    Binary       0.0000
t0_gen_cohort_Gen_Silent: born&lt; 1946                Binary       0.0000
t0_gen_cohort_Gen Boomers: born &gt;= 1946 &amp; b.&lt; 1965  Binary       0.0000
t0_gen_cohort_GenX: born &gt;=1961 &amp; b.&lt; 1981          Binary       0.0000
t0_gen_cohort_GenY: born &gt;=1981 &amp; b.&lt; 1996          Binary       0.0000
t0_gen_cohort_GenZ: born &gt;= 1996                    Binary       0.0000
t0_urban_urban                                      Binary       0.0000
t0_hours_exercise_coarsen_inactive                  Binary       0.0000
t0_hours_exercise_coarsen_active                    Binary       0.0000
t0_hours_exercise_coarsen_very_active               Binary       0.0000
t0_edu_z                                           Contin.       0.0000
t0_employed_z                                      Contin.       0.0001
t0_nz_dep2018_z                                    Contin.       0.0000
t0_nzsei13_z                                       Contin.       0.0000
t0_partner_z                                       Contin.       0.0002
t0_parent_z                                        Contin.       0.0001
t0_pol_orient_z                                    Contin.       0.0000
t0_agreeableness_z                                 Contin.       0.0001
t0_conscientiousness_z                             Contin.       0.0000
t0_extraversion_z                                  Contin.       0.0000
t0_honesty_humility_z                              Contin.       0.0000
t0_openness_z                                      Contin.       0.0000
t0_neuroticism_z                                   Contin.       0.0000
t0_modesty_z                                       Contin.       0.0000
t0_religion_identification_level_z                 Contin.       0.0001
t0_kessler_latent_anxiety_z                        Contin.       0.0000
t0_kessler_latent_depression_z                     Contin.       0.0001

Effective sample sizes
           inactive active very_active
Unadjusted   307.   354.        160.  
Adjusted     220.54 321.09       76.39</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">#bal.tab(dt_match_ps$māori)   #  not good</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># code for summar</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>sum_e <span class="ot">&lt;-</span> <span class="fu">summary</span>(dt_match_ebal<span class="sc">$</span>euro)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>sum_m <span class="ot">&lt;-</span> <span class="fu">summary</span>(dt_match_ebal<span class="sc">$</span>māori)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co"># summary euro</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>sum_e</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Summary of weights

- Weight ranges:

               Min                                  Max
inactive    0.2310 |---------------------------| 7.0511
active      0.5769  |----|                       1.9603
very_active 0.1601 |----------------------|      5.9191

- Units with the 5 most extreme weights by group:
                                               
               6560      9   7209   4878   5105
    inactive 5.1084 5.1312 5.1642 5.3517 7.0511
               3279   1867   4754   2783   7057
      active 1.7467 1.7654 1.7701 1.8692 1.9603
               5977   4293    700   2352   4765
 very_active 5.1495 5.3064 5.4829 5.7273 5.9191

- Weight statistics:

            Coef of Var   MAD Entropy # Zeros
inactive          0.743 0.536   0.212       0
active            0.270 0.248   0.036       0
very_active       0.862 0.637   0.302       0

- Effective Sample Sizes:

           inactive  active very_active
Unweighted  2880.   3927.       1834.  
Weighted    1855.89 3659.59     1052.01</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># summary maori</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>sum_m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Summary of weights

- Weight ranges:

               Min                                  Max
inactive    0.2213  |---------------|            3.8101
active      0.3995   |-----|                     1.9800
very_active 0.0719 |---------------------------| 6.2941

- Units with the 5 most extreme weights by group:
                                               
                296    322    355    758    812
    inactive 3.0104  3.407 3.6372 3.7101 3.8101
                 95    783    473    703    699
      active 1.8319 1.8387 1.9395 1.9436   1.98
                745    149     78    226    718
 very_active 4.0921 4.3405 4.4111 4.6833 6.2941

- Weight statistics:

            Coef of Var   MAD Entropy # Zeros
inactive          0.627 0.475   0.170       0
active            0.321 0.264   0.050       0
very_active       1.050 0.732   0.411       0

- Effective Sample Sizes:

           inactive active very_active
Unweighted   307.   354.        160.  
Weighted     220.54 321.09       76.39</code></pre>
</div>
</div>
<div class="cell page-columns page-full">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>love_plot_e <span class="ot">&lt;-</span> <span class="fu">love.plot</span>(dt_match_ebal<span class="sc">$</span>euro,</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">binary =</span> <span class="st">"std"</span>,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> .<span class="dv">1</span>))<span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"NZ Euro Weighting: method e-balance"</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>love_plot_e </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display column-page-right">
<p><img src="10-content_files/figure-html/love_plot_euro-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell page-columns page-full">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>love_plot_m <span class="ot">&lt;-</span> <span class="fu">love.plot</span>(dt_match_ebal<span class="sc">$</span>māori,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">binary =</span> <span class="st">"std"</span>,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> .<span class="dv">1</span>)) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Māori Weighting: method e-balance"</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>love_plot_m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display column-page-right">
<p><img src="10-content_files/figure-html/love_plot_maori-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="example-summary-nz-euro-propensity-scores." class="level3">
<h3 class="anchored" data-anchor-id="example-summary-nz-euro-propensity-scores.">Example Summary NZ Euro Propensity scores.</h3>
<p><em>We estimated propensity score analysis using entropy balancing, energy balancing and traditional propensity scores. Of these approaches, entropy balancing provided the best balance. The results indicate an excellent balance across all variables, with Max.Diff.Adj values significantly below the target threshold of 0.05 across a range of binary and continuous baseline confounders, including gender, generation cohort, urban_location, exercise hours (coarsened, baseline), education, employment status, depression, anxiety, and various personality traits. The Max.Diff.Adj values for all variables were well below the target threshold of 0.05, with most variables achieving a Max.Diff.Adj of 0.0001 or lower. This indicates a high level of balance across all treatment pairs.</em></p>
<p><em>The effective sample sizes were also adjusted using entropy balancing. The unadjusted sample sizes for the inactive, active, and very active groups were 2880, 3927, and 1834, respectively. After adjustment, the effective sample sizes were reduced to 1855.89, 3659.59, and 1052.01, respectively.</em></p>
<p><em>The weight ranges for the inactive, active, and very active groups varied, with the inactive group showing the widest range (0.2310 to 7.0511) and the active group showing the narrowest range (0.5769 to 1.9603). Despite these variations, the coefficient of variation, mean absolute deviation (MAD), and entropy were all within acceptable limits for each group, indicating a good balance of weights.</em></p>
<p><em>We also identified the units with the five most extreme weights by group. These units exhibited higher weights compared to the rest of the units in their respective groups, but they did not significantly affect the overall balance of weights.</em></p>
<p><em>We plotted these results using love plots, visually confirming both the balance in the propensity score model using entropy balanced weights, and the imbalance in the model that does not adjust for baseline confounders.</em></p>
<p><em>Overall, these findings support the use of entropy balancing in propensity score analysis to ensure a balanced distribution of covariates across treatment groups, conditional on the measured covariates included in the model.</em></p>
</section>
<section id="example-summary-maori-propensity-scores." class="level3">
<h3 class="anchored" data-anchor-id="example-summary-maori-propensity-scores.">Example Summary Maori Propensity scores.</h3>
<p>Results:</p>
<p><em>The entropy balancing method was also the best performing method that was applied to a subgroup analysis of the Māori population. Similar to the NZ European subgroup analysis, the method achieved a high level of balance across all treatment pairs for the Māori subgroup. The Max.Diff.Adj values for all variables were well below the target threshold of 0.05, with most variables achieving a Max.Diff.Adj of 0.0001 or lower. This indicates a high level of balance across all treatment pairs for the Māori subgroup.</em></p>
<p><em>The effective sample sizes for the Māori subgroup were also adjusted using entropy balancing. The unadjusted sample sizes for the inactive, active, and very active groups were 307, 354, and 160, respectively. After adjustment, the effective sample sizes were reduced to 220.54, 321.09, and 76.39, respectively</em></p>
<p><em>The weight ranges for the inactive, active, and very active groups in the Māori subgroup varied, with the inactive group showing the widest range (0.2213 to 3.8101) and the active group showing the narrowest range (0.3995 to 1.9800). Despite these variations, the coefficient of variation, mean absolute deviation (MAD), and entropy were all within acceptable limits for each group, indicating a good balance of weights.</em></p>
<p><em>The study also identified the units with the five most extreme weights by group for the Māori subgroup. These units exhibited higher weights compared to the rest of the units in their respective groups, but they did not significantly affect the overall balance of weights.</em></p>
<p><em>In conclusion, the results of the Māori subgroup analysis are consistent with the overall analysis. The entropy balancing method achieved a high level of balance across all treatment pairs, with Max.Diff.Adj values significantly below the target threshold. These findings support the use of entropy balancing in propensity score analysis to ensure a balanced distribution of covariates across treatment groups, even in subgroup analyses.</em></p>
</section>
<section id="more-data-wrangling" class="level3">
<h3 class="anchored" data-anchor-id="more-data-wrangling">More data wrangling</h3>
<p>Note that we need to attach the <code>weights</code> from the propensity score model back to the data.</p>
<p>However, because our weighting analysis estimates a model for the <em>exposure</em>, we only need to do this analysis once, no matter how many outcomes we investigate. So there’s a little good news.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prepare nz_euro data</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>dt_ref_e <span class="ot">&lt;-</span> <span class="fu">subset</span>(dt, t0_eth_cat <span class="sc">==</span> <span class="st">"euro"</span>) <span class="co"># original data subset only nz europeans</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># add weights</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>dt_ref_e<span class="sc">$</span>weights <span class="ot">&lt;-</span> dt_match_ebal<span class="sc">$</span>euro<span class="sc">$</span>weights <span class="co"># get weights from the ps matching model,add to data</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co"># prepare maori data</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>dt_ref_m <span class="ot">&lt;-</span> <span class="fu">subset</span>(dt, t0_eth_cat <span class="sc">==</span> <span class="st">"māori"</span>)<span class="co"># original data subset only maori</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="co"># add weights</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>dt_ref_m<span class="sc">$</span>weights <span class="ot">&lt;-</span> dt_match_ebal<span class="sc">$</span>māori<span class="sc">$</span>weights <span class="co"># get weights from the ps matching model, add to data</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="co"># combine data into one data frame</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>dt_ref_all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dt_ref_e, dt_ref_m) <span class="co"># combine the data into one dataframe. </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="anxiety-analysis-and-results" class="level2">
<h2 class="anchored" data-anchor-id="anxiety-analysis-and-results">Anxiety Analysis and Results</h2>
<p>Let’s consider a pseudo experiment where someone moves from inactive to active.</p>
<p>We will use doubly robust analysis. This means that we estimate a model using both propensity score weights (obtained using the ebalance algortithm) and regression stratification.</p>
<p>I wrote a function that will caluclate “E-values.” An E-value is defined as the</p>
<blockquote class="blockquote">
<p>E-values represent the minimum strength or magnitude of association that an unmeasured confounder would need to have with both treatment and outcome in order to explain the observed effect estimates conditional on measured covariates.</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we do not evaluate to save time</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="do">### SUBGROUP analysis</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span>  dt_ref_all</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span>  <span class="st">"t2_kessler_latent_anxiety_z"</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="st">"t1_hours_exercise_coarsen"</span> <span class="co"># already defined above</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">=</span> baseline_vars_reflective_propensity</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>treat_0 <span class="ot">=</span> <span class="st">"inactive"</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>treat_1 <span class="ot">=</span> <span class="st">"very_active"</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>estimand <span class="ot">=</span> <span class="st">"ATE"</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>scale <span class="ot">=</span> <span class="st">"RD"</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>family <span class="ot">=</span> <span class="st">"gaussian"</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>continuous_X <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>splines <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>cores <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>S <span class="ot">=</span> <span class="st">"t0_eth_cat"</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="co"># not we interact the subclass X treatment X covariates</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>formula_str <span class="ot">&lt;-</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    Y,</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"~"</span>,</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    S,</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"*"</span>,</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"("</span>,</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>    X ,</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"*"</span>,</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"("</span>,</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(baseline_vars_reflective_propensity, <span class="at">collapse =</span> <span class="st">"+"</span>),</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">")"</span>,</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">")"</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a><span class="co"># formula_str. # inspect on our own time </span></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a><span class="co"># fit model</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>fit_all_all  <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>(formula_str),</span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> weights,</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># weights = if (!is.null(weight_var)) weight_var else NULL,</span></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> family,</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate coefficients</span></span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a><span class="fu">conflicts_prefer</span>(clarify<span class="sc">::</span>sim)</span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>sim_model_all <span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_all_all, <span class="at">n =</span> nsims, <span class="at">vcov =</span> <span class="st">"HC0"</span>)</span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate effect as modified in europeans</span></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_e <span class="ot">&lt;-</span> <span class="fu">sim_ame</span>(</span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>  sim_model_all,</span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">var =</span> X,</span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">cl =</span> cores,</span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">subset =</span> t0_eth_cat <span class="sc">==</span> <span class="st">"euro"</span>,</span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a><span class="co">#rm(sim_estimand_all_e)</span></span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a><span class="co"># note contrast of interest</span></span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_e <span class="ot">&lt;-</span></span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transform</span>(sim_estimand_all_e, <span class="at">RD =</span> <span class="st">`</span><span class="at">E[Y(very_active)]</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">E[Y(inactive)]</span><span class="st">`</span>)</span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a><span class="co">#rm(sim_estimand_all_m)</span></span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate effect as modified in māori</span></span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_m <span class="ot">&lt;-</span> <span class="fu">sim_ame</span>(</span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a>  sim_model_all,</span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">var =</span> X,</span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">cl =</span> cores,</span>
<span id="cb50-73"><a href="#cb50-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">subset =</span> t0_eth_cat <span class="sc">==</span> <span class="st">"māori"</span>,</span>
<span id="cb50-74"><a href="#cb50-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a><span class="co"># combine</span></span>
<span id="cb50-78"><a href="#cb50-78" aria-hidden="true" tabindex="-1"></a><span class="co">#m(sim_estimand_all_m)</span></span>
<span id="cb50-79"><a href="#cb50-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-80"><a href="#cb50-80" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_m <span class="ot">&lt;-</span></span>
<span id="cb50-81"><a href="#cb50-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transform</span>(sim_estimand_all_m, <span class="at">RD =</span> <span class="st">`</span><span class="at">E[Y(very_active)]</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">E[Y(inactive)]</span><span class="st">`</span>)</span>
<span id="cb50-82"><a href="#cb50-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-83"><a href="#cb50-83" aria-hidden="true" tabindex="-1"></a><span class="co"># rearrange</span></span>
<span id="cb50-84"><a href="#cb50-84" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sim_estimand_all_e) <span class="ot">&lt;-</span></span>
<span id="cb50-85"><a href="#cb50-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">names</span>(sim_estimand_all_e), <span class="st">"e"</span>, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb50-86"><a href="#cb50-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-87"><a href="#cb50-87" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sim_estimand_all_m) <span class="ot">&lt;-</span></span>
<span id="cb50-88"><a href="#cb50-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">names</span>(sim_estimand_all_m), <span class="st">"m"</span>, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb50-89"><a href="#cb50-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-90"><a href="#cb50-90" aria-hidden="true" tabindex="-1"></a>est_all_anxiety <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sim_estimand_all_m, sim_estimand_all_e)</span>
<span id="cb50-91"><a href="#cb50-91" aria-hidden="true" tabindex="-1"></a>est_all_anxiety <span class="ot">&lt;-</span> <span class="fu">transform</span>(est_all_anxiety, <span class="st">`</span><span class="at">RD_m - RD_e</span><span class="st">`</span> <span class="ot">=</span> RD_m <span class="sc">-</span> RD_e)</span>
<span id="cb50-92"><a href="#cb50-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-93"><a href="#cb50-93" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(est_all_anxiety, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>,<span class="st">"est_all_anxiety"</span>))</span>
<span id="cb50-94"><a href="#cb50-94" aria-hidden="true" tabindex="-1"></a><span class="co"># view summary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Calculate E-values</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read data</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>est_all_anxiety <span class="ot">&lt;-</span> <span class="fu">readRDS</span>( here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>,<span class="st">"est_all_anxiety"</span>))</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co"># make dataframe</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>df_anxiety_all <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="fu">summary</span>(est_all_anxiety) )</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>table_estimates_anxiety <span class="ot">&lt;-</span> df_anxiety_all <span class="sc">|&gt;</span> </span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">row.names</span>(df_anxiety_all) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"RD_m"</span>, <span class="st">"RD_e"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">lower_ci =</span> <span class="st">`</span><span class="at">X2.5..</span><span class="st">`</span>,</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper_ci =</span> <span class="st">`</span><span class="at">X97.5..</span><span class="st">`</span>,</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> Estimate) <span class="sc">|&gt;</span> </span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a> <span class="co"># dplyr::mutate(standard_error = abs(`2.5 %` - `97.5 %`) / 3.92) |&gt; </span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), round, <span class="at">digits =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There was 1 warning in `dplyr::mutate()`.
ℹ In argument: `across(where(is.numeric), round, digits = 3)`.
Caused by warning:
! The `...` argument of `across()` is deprecated as of dplyr 1.1.0.
Supply arguments directly to `.fns` through an anonymous function instead.

  # Previously
  across(a:b, mean, na.rm = TRUE)

  # Now
  across(a:b, \(x) mean(x, na.rm = TRUE))</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># note that I made a function to calculate the Evalue, load this with "experimental functions"</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>test_tab <span class="ot">&lt;-</span> <span class="fu">tab_ate_subgroup_rd</span>(table_estimates_anxiety, <span class="at">delta =</span> <span class="dv">1</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Confidence interval crosses the true value, so its E-value is 1.
Confidence interval crosses the true value, so its E-value is 1.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>test_tab <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">E[Y(1)]-E[Y(0)]</th>
<th style="text-align: right;">lower_ci</th>
<th style="text-align: right;">upper_ci</th>
<th style="text-align: right;">E_Value</th>
<th style="text-align: right;">E_Val_bound</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">RD_m</td>
<td style="text-align: right;">0.028</td>
<td style="text-align: right;">-0.113</td>
<td style="text-align: right;">0.179</td>
<td style="text-align: right;">1.189</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">RD_e</td>
<td style="text-align: right;">-0.039</td>
<td style="text-align: right;">-0.103</td>
<td style="text-align: right;">0.019</td>
<td style="text-align: right;">1.230</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>df_anxiety_all_plot <span class="ot">&lt;-</span> df_anxiety_all <span class="sc">|&gt;</span> </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(row.names(df_anxiety_all) %in% c("RD_m - RD_e")) |&gt; </span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">lower_ci =</span> <span class="st">`</span><span class="at">X2.5..</span><span class="st">`</span>,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper_ci =</span> <span class="st">`</span><span class="at">X97.5..</span><span class="st">`</span>,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> Estimate) <span class="sc">|&gt;</span> </span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a> <span class="co"># dplyr::mutate(standard_error = abs(`2.5 %` - `97.5 %`) / 3.92) |&gt; </span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), round, <span class="at">digits =</span> <span class="dv">3</span>)) </span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>df_anxiety_all_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    estimate lower_ci upper_ci
E[Y(inactive)]_m       0.151    0.061    0.247
E[Y(active)]_m         0.188    0.096    0.272
E[Y(very_active)]_m    0.179    0.075    0.299
RD_m                   0.028   -0.113    0.179
E[Y(inactive)]_e       0.004   -0.029    0.037
E[Y(active)]_e        -0.017   -0.043    0.007
E[Y(very_active)]_e   -0.036   -0.086    0.010
RD_e                  -0.039   -0.103    0.019
RD_m - RD_e            0.068   -0.088    0.229</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_sub_forest</span>(df_anxiety_all_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="10-content_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>df_anxiety_all_plot<span class="sc">|&gt;</span> </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">estimate</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">lower_ci</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">upper_ci</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">E[Y(inactive)]_m</td>
<td style="text-align: right;">0.151</td>
<td style="text-align: right;">0.061</td>
<td style="text-align: right;">0.247</td>
</tr>
<tr class="even">
<td style="text-align: left;">E[Y(active)]_m</td>
<td style="text-align: right;">0.188</td>
<td style="text-align: right;">0.096</td>
<td style="text-align: right;">0.272</td>
</tr>
<tr class="odd">
<td style="text-align: left;">E[Y(very_active)]_m</td>
<td style="text-align: right;">0.179</td>
<td style="text-align: right;">0.075</td>
<td style="text-align: right;">0.299</td>
</tr>
<tr class="even">
<td style="text-align: left;">RD_m</td>
<td style="text-align: right;">0.028</td>
<td style="text-align: right;">-0.113</td>
<td style="text-align: right;">0.179</td>
</tr>
<tr class="odd">
<td style="text-align: left;">E[Y(inactive)]_e</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">-0.029</td>
<td style="text-align: right;">0.037</td>
</tr>
<tr class="even">
<td style="text-align: left;">E[Y(active)]_e</td>
<td style="text-align: right;">-0.017</td>
<td style="text-align: right;">-0.043</td>
<td style="text-align: right;">0.007</td>
</tr>
<tr class="odd">
<td style="text-align: left;">E[Y(very_active)]_e</td>
<td style="text-align: right;">-0.036</td>
<td style="text-align: right;">-0.086</td>
<td style="text-align: right;">0.010</td>
</tr>
<tr class="even">
<td style="text-align: left;">RD_e</td>
<td style="text-align: right;">-0.039</td>
<td style="text-align: right;">-0.103</td>
<td style="text-align: right;">0.019</td>
</tr>
<tr class="odd">
<td style="text-align: left;">RD_m - RD_e</td>
<td style="text-align: right;">0.068</td>
<td style="text-align: right;">-0.088</td>
<td style="text-align: right;">0.229</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="interpretation" class="level2">
<h2 class="anchored" data-anchor-id="interpretation">Interpretation</h2>
<ul>
<li>Increase in activity among NZ Europeans would be expected to lower anxiety.</li>
<li>Increase in activity among Māori is not reliable.<br>
</li>
<li>No reliable differences in these effects between the groups.</li>
</ul>
</section>
<section id="depression-analysis-and-results" class="level2">
<h2 class="anchored" data-anchor-id="depression-analysis-and-results">Depression Analysis and Results</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="do">### SUBGROUP analysis</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span>  dt_ref_all</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span>  <span class="st">"t2_kessler_latent_depression_z"</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="st">"t1_hours_exercise_coarsen"</span> <span class="co"># already defined above</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">=</span> baseline_vars_reflective_propensity</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>treat_0 <span class="ot">=</span> <span class="st">"inactive"</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>treat_1 <span class="ot">=</span> <span class="st">"very_active"</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>estimand <span class="ot">=</span> <span class="st">"ATE"</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>scale <span class="ot">=</span> <span class="st">"RD"</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>family <span class="ot">=</span> <span class="st">"gaussian"</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>continuous_X <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>splines <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>cores <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>S <span class="ot">=</span> <span class="st">"t0_eth_cat"</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a><span class="co"># not we interact the subclass X treatment X covariates</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>formula_str <span class="ot">&lt;-</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>    Y,</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"~"</span>,</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>    S,</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"*"</span>,</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"("</span>,</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>    X ,</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"*"</span>,</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"("</span>,</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(baseline_vars_reflective_propensity, <span class="at">collapse =</span> <span class="st">"+"</span>),</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">")"</span>,</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">")"</span></span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a><span class="co"># fit model</span></span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>fit_all_dep  <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>(formula_str),</span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> weights,</span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># weights = if (!is.null(weight_var)) weight_var else NULL,</span></span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> family,</span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df</span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a><span class="co"># coefs &lt;- coef(fit_all_dep)</span></span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a><span class="co"># table(is.na(coefs))#   </span></span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a><span class="co"># insight::get_varcov(fit_all_all)</span></span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate coefficients</span></span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a><span class="fu">conflicts_prefer</span>(clarify<span class="sc">::</span>sim)</span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a>sim_model_all <span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_all_dep, <span class="at">n =</span> nsims, <span class="at">vcov =</span> <span class="st">"HC1"</span>)</span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-53"><a href="#cb60-53" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate effect as modified in europeans</span></span>
<span id="cb60-54"><a href="#cb60-54" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_e_d <span class="ot">&lt;-</span> <span class="fu">sim_ame</span>(</span>
<span id="cb60-55"><a href="#cb60-55" aria-hidden="true" tabindex="-1"></a>  sim_model_all,</span>
<span id="cb60-56"><a href="#cb60-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">var =</span> X,</span>
<span id="cb60-57"><a href="#cb60-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">cl =</span> cores,</span>
<span id="cb60-58"><a href="#cb60-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">subset =</span> t0_eth_cat <span class="sc">==</span> <span class="st">"euro"</span>,</span>
<span id="cb60-59"><a href="#cb60-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb60-60"><a href="#cb60-60" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-61"><a href="#cb60-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-62"><a href="#cb60-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-63"><a href="#cb60-63" aria-hidden="true" tabindex="-1"></a><span class="co"># note contrast of interest</span></span>
<span id="cb60-64"><a href="#cb60-64" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_e_d <span class="ot">&lt;-</span></span>
<span id="cb60-65"><a href="#cb60-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transform</span>(sim_estimand_all_e_d, <span class="at">RD =</span> <span class="st">`</span><span class="at">E[Y(very_active)]</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">E[Y(inactive)]</span><span class="st">`</span>)</span>
<span id="cb60-66"><a href="#cb60-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-67"><a href="#cb60-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-68"><a href="#cb60-68" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate effect as modified in māori</span></span>
<span id="cb60-69"><a href="#cb60-69" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_m_d <span class="ot">&lt;-</span> <span class="fu">sim_ame</span>(</span>
<span id="cb60-70"><a href="#cb60-70" aria-hidden="true" tabindex="-1"></a>  sim_model_all,</span>
<span id="cb60-71"><a href="#cb60-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">var =</span> X,</span>
<span id="cb60-72"><a href="#cb60-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">cl =</span> cores,</span>
<span id="cb60-73"><a href="#cb60-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">subset =</span> t0_eth_cat <span class="sc">==</span> <span class="st">"māori"</span>,</span>
<span id="cb60-74"><a href="#cb60-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb60-75"><a href="#cb60-75" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-76"><a href="#cb60-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-77"><a href="#cb60-77" aria-hidden="true" tabindex="-1"></a><span class="co"># combine</span></span>
<span id="cb60-78"><a href="#cb60-78" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_m_d <span class="ot">&lt;-</span></span>
<span id="cb60-79"><a href="#cb60-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transform</span>(sim_estimand_all_m_d, <span class="at">RD =</span> <span class="st">`</span><span class="at">E[Y(very_active)]</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">E[Y(inactive)]</span><span class="st">`</span>)</span>
<span id="cb60-80"><a href="#cb60-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-81"><a href="#cb60-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-82"><a href="#cb60-82" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb60-83"><a href="#cb60-83" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(sim_estimand_all_e_d)</span></span>
<span id="cb60-84"><a href="#cb60-84" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(sim_estimand_all_m_d)</span></span>
<span id="cb60-85"><a href="#cb60-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-86"><a href="#cb60-86" aria-hidden="true" tabindex="-1"></a><span class="co"># rearrange</span></span>
<span id="cb60-87"><a href="#cb60-87" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sim_estimand_all_e_d) <span class="ot">&lt;-</span></span>
<span id="cb60-88"><a href="#cb60-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">names</span>(sim_estimand_all_e_d), <span class="st">"e"</span>, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb60-89"><a href="#cb60-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-90"><a href="#cb60-90" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sim_estimand_all_m_d) <span class="ot">&lt;-</span></span>
<span id="cb60-91"><a href="#cb60-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">names</span>(sim_estimand_all_m_d), <span class="st">"m"</span>, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb60-92"><a href="#cb60-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-93"><a href="#cb60-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-94"><a href="#cb60-94" aria-hidden="true" tabindex="-1"></a>est_all_d <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sim_estimand_all_m_d, sim_estimand_all_e_d)</span>
<span id="cb60-95"><a href="#cb60-95" aria-hidden="true" tabindex="-1"></a>est_all_d <span class="ot">&lt;-</span> <span class="fu">transform</span>(est_all_d, <span class="st">`</span><span class="at">RD_m - RD_e</span><span class="st">`</span> <span class="ot">=</span> RD_m <span class="sc">-</span> RD_e)</span>
<span id="cb60-96"><a href="#cb60-96" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(est_all_d, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"est_all_d"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>est_all_d <span class="ot">&lt;-</span> <span class="fu">readRDS</span>( here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"est_all_d"</span>))</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co"># make dataframe</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>df_dep <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="fu">summary</span>(est_all_d) )</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>table_estimates_depression <span class="ot">&lt;-</span> df_dep <span class="sc">|&gt;</span> </span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">row.names</span>(df_dep) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"RD_m"</span>, <span class="st">"RD_e"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">lower_ci =</span> <span class="st">`</span><span class="at">X2.5..</span><span class="st">`</span>,</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper_ci =</span> <span class="st">`</span><span class="at">X97.5..</span><span class="st">`</span>,</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> Estimate) <span class="sc">|&gt;</span> </span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a> <span class="co"># dplyr::mutate(standard_error = abs(`2.5 %` - `97.5 %`) / 3.92) |&gt; </span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), round, <span class="at">digits =</span> <span class="dv">3</span>))</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a><span class="co"># note that I made a function to calculate the Evalue, load this with "experimental functions"</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>table_depression <span class="ot">&lt;-</span> <span class="fu">tab_ate_subgroup_rd</span>(table_estimates_depression, <span class="at">delta =</span> <span class="dv">1</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Confidence interval crosses the true value, so its E-value is 1.
Confidence interval crosses the true value, so its E-value is 1.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>table_depression <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">E[Y(1)]-E[Y(0)]</th>
<th style="text-align: right;">lower_ci</th>
<th style="text-align: right;">upper_ci</th>
<th style="text-align: right;">E_Value</th>
<th style="text-align: right;">E_Val_bound</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">RD_m</td>
<td style="text-align: right;">0.028</td>
<td style="text-align: right;">-0.130</td>
<td style="text-align: right;">0.165</td>
<td style="text-align: right;">1.189</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">RD_e</td>
<td style="text-align: right;">-0.039</td>
<td style="text-align: right;">-0.097</td>
<td style="text-align: right;">0.014</td>
<td style="text-align: right;">1.230</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># view summary</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>df_dep <span class="sc">|&gt;</span> </span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, round, <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Estimate</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">X2.5..</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">X97.5..</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">E[Y(inactive)]_m</td>
<td style="text-align: right;">0.151</td>
<td style="text-align: right;">0.062</td>
<td style="text-align: right;">0.246</td>
</tr>
<tr class="even">
<td style="text-align: left;">E[Y(active)]_m</td>
<td style="text-align: right;">0.188</td>
<td style="text-align: right;">0.094</td>
<td style="text-align: right;">0.278</td>
</tr>
<tr class="odd">
<td style="text-align: left;">E[Y(very_active)]_m</td>
<td style="text-align: right;">0.179</td>
<td style="text-align: right;">0.069</td>
<td style="text-align: right;">0.290</td>
</tr>
<tr class="even">
<td style="text-align: left;">RD_m</td>
<td style="text-align: right;">0.028</td>
<td style="text-align: right;">-0.130</td>
<td style="text-align: right;">0.165</td>
</tr>
<tr class="odd">
<td style="text-align: left;">E[Y(inactive)]_e</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">-0.030</td>
<td style="text-align: right;">0.038</td>
</tr>
<tr class="even">
<td style="text-align: left;">E[Y(active)]_e</td>
<td style="text-align: right;">-0.017</td>
<td style="text-align: right;">-0.041</td>
<td style="text-align: right;">0.008</td>
</tr>
<tr class="odd">
<td style="text-align: left;">E[Y(very_active)]_e</td>
<td style="text-align: right;">-0.036</td>
<td style="text-align: right;">-0.083</td>
<td style="text-align: right;">0.006</td>
</tr>
<tr class="even">
<td style="text-align: left;">RD_e</td>
<td style="text-align: right;">-0.039</td>
<td style="text-align: right;">-0.097</td>
<td style="text-align: right;">0.014</td>
</tr>
<tr class="odd">
<td style="text-align: left;">RD_m - RD_e</td>
<td style="text-align: right;">0.068</td>
<td style="text-align: right;">-0.099</td>
<td style="text-align: right;">0.226</td>
</tr>
</tbody>
</table>


</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This table provides estimated levels of depression, in standard deviation units, for different levels of activity for two groups: Māori (indicated by "_m") and NZ Europeans (indicated by "_e").</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>df_dep_plot_data <span class="ot">&lt;-</span> df_dep <span class="sc">|&gt;</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">rename</span>( <span class="at">lower_ci =</span> <span class="st">`</span><span class="at">X2.5..</span><span class="st">`</span>,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper_ci =</span> <span class="st">`</span><span class="at">X97.5..</span><span class="st">`</span>,</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> Estimate) <span class="sc">|&gt;</span> </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, round, <span class="dv">3</span>) </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>plot_sub_forest <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">require</span>(ggplot2)</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if required packages are installed</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>  required_packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>  new_packages <span class="ot">&lt;-</span> required_packages[<span class="sc">!</span>(required_packages <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[, <span class="st">"Package"</span>])]</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(new_packages))</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Missing packages: "</span>, <span class="fu">paste</span>(new_packages, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if required columns are in the dataframe</span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>  required_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"estimate"</span>, <span class="st">"lower_ci"</span>, <span class="st">"upper_ci"</span>)</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>  missing_cols <span class="ot">&lt;-</span> required_cols[<span class="sc">!</span>(required_cols <span class="sc">%in%</span> <span class="fu">colnames</span>(df))]</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(missing_cols) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Missing columns in dataframe: "</span>, <span class="fu">paste</span>(missing_cols, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Order the factor levels by the estimate column in decreasing order</span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x=</span>estimate, <span class="at">y=</span><span class="fu">factor</span>(<span class="fu">row.names</span>(df)))) <span class="sc">+</span></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower_ci, <span class="at">xmax =</span> upper_ci), <span class="at">height=</span><span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype=</span><span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Estimate"</span>) <span class="sc">+</span></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">""</span>)</span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_sub_forest</span>(df_dep_plot_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="10-content_files/figure-html/my_graph-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="interpretation-1" class="level2">
<h2 class="anchored" data-anchor-id="interpretation-1">Interpretation</h2>
<ul>
<li>Increase in activity among NZ Europeans would be expected to lower depression, but the effect is not reliable.</li>
<li>Increase in activity among Māori does not reliably affect depression..</li>
<li>No reliable group differences.</li>
</ul>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<ol type="1">
<li>Generate a Kessler 6 binary score (Not Depressed vs.&nbsp;Moderately or Severely Depressed)</li>
</ol>
<p>and also:</p>
<ol start="2" type="1">
<li><p>Create a variable for the log of exercise hour</p></li>
<li><p>Take Home: estimate whether exercise causally affects nervousness, using the single item of the kessler 6 score. Briefly write up your results.</p></li>
</ol>
</section>
<section id="appendix-mg-cfa" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="appendix-mg-cfa">Appendix: MG-CFA</h2>
<section id="cfa-for-kessler-6" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="cfa-for-kessler-6">CFA for Kessler 6</h3>
<p>We have learned how to do confirmatory factor analysis. Let’s put this knowledge to use but clarifying the underlying factor structure of Kessler-6</p>
<p>The code below will:</p>
<ul>
<li>Load required packages.</li>
<li>Select the Kessler 6 items</li>
<li>Check whether there is sufficient correlation among the variables to support factor analysis.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select the columns we need. </span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>dt_only_k6 <span class="ot">&lt;-</span> dt_start <span class="sc">|&gt;</span> <span class="fu">select</span>(kessler_depressed, kessler_effort,kessler_hopeless,</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>                                 kessler_worthless, kessler_nervous,</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>                                 kessler_restless)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="co"># check factor structure</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>performance<span class="sc">::</span><span class="fu">check_factorstructure</span>(dt_only_k6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Is the data suitable for Factor Analysis?


  - Sphericity: Bartlett's test of sphericity suggests that there is sufficient significant correlation in the data for factor analysis (Chisq(15) = 70564.23, p &lt; .001).
  - KMO: The Kaiser, Meyer, Olkin (KMO) overall measure of sampling adequacy suggests that data seems appropriate for factor analysis (KMO = 0.86). The individual KMO scores are: kessler_depressed (0.83), kessler_effort (0.89), kessler_hopeless (0.85), kessler_worthless (0.85), kessler_nervous (0.88), kessler_restless (0.85).</code></pre>
</div>
</div>
<p>The code below will allow us to explore the factor structure, on the assumption of n = 3 factors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># exploratory factor analysis</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="co"># explore a factor structure made of 3 latent variables</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>efa <span class="ot">&lt;-</span> psych<span class="sc">::</span><span class="fu">fa</span>(dt_only_k6, <span class="at">nfactors =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model_parameters</span>(<span class="at">sort =</span> <span class="cn">TRUE</span>, <span class="at">threshold =</span> <span class="st">"max"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: GPArotation</code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>efa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Rotated loadings from Factor Analysis (oblimin-rotation)

Variable          | MR1  | MR2  | MR3  | Complexity | Uniqueness
----------------------------------------------------------------
kessler_depressed | 0.85 |      |      |    1.01    |    0.33   
kessler_worthless | 0.79 |      |      |    1.00    |    0.35   
kessler_hopeless  | 0.75 |      |      |    1.02    |    0.33   
kessler_nervous   |      | 1.00 |      |    1.00    |  5.00e-03 
kessler_restless  |      |      | 0.69 |    1.02    |    0.52   
kessler_effort    |      |      | 0.48 |    1.66    |    0.50   

The 3 latent factors (oblimin rotation) accounted for 66.05% of the total variance of the original data (MR1 = 35.14%, MR2 = 17.17%, MR3 = 13.73%).</code></pre>
</div>
</div>
<p>This output describes an exploratory factor analysis (EFA) with 3 factors conducted on the Kessler 6 (K6) scale data. The K6 scale is used to measure psychological distress.</p>
<p>The analysis identifies three latent factors, labeled MR1, MR2, and MR3, which collectively account for 66.05% of the variance in the K6 data. The factors MR1, MR2, and MR3 explain 35.14%, 17.17%, and 13.73% of the variance respectively.</p>
<p>Factor loadings, indicating the strength and direction of the relationship between the K6 items and the latent factors, are as follows:</p>
<ol type="1">
<li>Factor MR1 is strongly associated with ‘kessler_depressed’, ‘kessler_worthless’, and ‘kessler_hopeless’ with loadings of 0.85, 0.79, and 0.75 respectively.</li>
<li>Factor MR2 is exclusively linked with ‘kessler_nervous’ with a loading of 1.00.</li>
<li>Factor MR3 relates to ‘kessler_restless’ and ‘kessler_effort’ with loadings of 0.69 and 0.48 respectively.</li>
</ol>
<p>The ‘Uniqueness’ values show the proportion of each variable’s variance that isn’t shared with the other variables.</p>
<p>The ‘Complexity’ values give a measure of how each item loads on more than one factor. All the items are either loading exclusively on one factor (complexity=1.00) or slightly more than one factor. ‘kessler_effort’ with complexity of 1.66 shows it’s the item most shared between the factors.</p>
<p>The analysis suggests these K6 items measure may measure three somewhat distinct, yet related, factors of psychological distress.</p>
<p>However, the meaning of these factors would need to be interpreted in the context of the variables and the theoretical framework of the study.</p>
<p>Notably, there are many many theoretical frameworks for in measurement theory. Here is a brief description of the different conclusions one might make, depending on one’s preferred theory.</p>
<div class="cell page-columns page-full">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">n_factors</span>(dt_only_k6)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(n) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display column-page-right">
<p><img src="10-content_files/figure-html/plot_factors-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="confirmatory-factor-analysis-ignoring-groups" class="level3">
<h3 class="anchored" data-anchor-id="confirmatory-factor-analysis-ignoring-groups">Confirmatory factor analysis (ignoring groups)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first partition the data </span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>part_data <span class="ot">&lt;-</span> datawizard<span class="sc">::</span><span class="fu">data_partition</span>(dt_only_k6, <span class="at">traing_proportion =</span> .<span class="dv">07</span>, <span class="at">seed =</span> <span class="dv">123</span>)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co"># set up training data</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>training <span class="ot">&lt;-</span> part_data<span class="sc">$</span>p_0<span class="fl">.7</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> part_data<span class="sc">$</span>test</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="co"># one factor model</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>structure_k6_one <span class="ot">&lt;-</span> psych<span class="sc">::</span><span class="fu">fa</span>(training, <span class="at">nfactors =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">efa_to_cfa</span>()</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="co"># two factor model model</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>structure_k6_two <span class="ot">&lt;-</span> psych<span class="sc">::</span><span class="fu">fa</span>(training, <span class="at">nfactors =</span> <span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">efa_to_cfa</span>()</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a><span class="co"># three factor model</span></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>structure_k6_three <span class="ot">&lt;-</span> psych<span class="sc">::</span><span class="fu">fa</span>(training, <span class="at">nfactors =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">efa_to_cfa</span>()</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect models</span></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>structure_k6_one</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Latent variables
MR1 =~ kessler_depressed + kessler_effort + kessler_hopeless + kessler_worthless + kessler_nervous + kessler_restless + .row_id</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>structure_k6_two</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Latent variables
MR1 =~ kessler_depressed + kessler_hopeless + kessler_worthless
MR2 =~ kessler_effort + kessler_nervous + kessler_restless + .row_id</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>structure_k6_three</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Latent variables
MR1 =~ kessler_depressed + kessler_effort + kessler_hopeless + kessler_worthless
MR2 =~ kessler_restless
MR3 =~ kessler_nervous + .row_id</code></pre>
</div>
</div>
<p>Next we perform the confirmatory factor analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit and compare models</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="co"># one latent model</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>one_latent <span class="ot">&lt;-</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_one, <span class="at">data =</span> test))</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="co"># two latents model</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>two_latents <span class="ot">&lt;-</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_two, <span class="at">data =</span> test))</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="co"># three latents model</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>three_latents <span class="ot">&lt;-</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_three, <span class="at">data =</span> test))</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a><span class="co"># compare models</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>  performance<span class="sc">::</span><span class="fu">compare_performance</span>(one_latent, two_latents, three_latents, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a><span class="co"># view as html table</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(compare) <span class="sc">|&gt;</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 4%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Model</th>
<th style="text-align: right;">Chi2</th>
<th style="text-align: right;">Chi2_df</th>
<th style="text-align: right;">p_Chi2</th>
<th style="text-align: right;">Baseline</th>
<th style="text-align: right;">Baseline_df</th>
<th style="text-align: right;">p_Baseline</th>
<th style="text-align: right;">GFI</th>
<th style="text-align: right;">AGFI</th>
<th style="text-align: right;">NFI</th>
<th style="text-align: right;">NNFI</th>
<th style="text-align: right;">CFI</th>
<th style="text-align: right;">RMSEA</th>
<th style="text-align: right;">RMSEA_CI_low</th>
<th style="text-align: right;">RMSEA_CI_high</th>
<th style="text-align: right;">p_RMSEA</th>
<th style="text-align: right;">RMR</th>
<th style="text-align: right;">SRMR</th>
<th style="text-align: right;">RFI</th>
<th style="text-align: right;">PNFI</th>
<th style="text-align: right;">IFI</th>
<th style="text-align: right;">RNI</th>
<th style="text-align: right;">Loglikelihood</th>
<th style="text-align: right;">AIC</th>
<th style="text-align: right;">AIC_wt</th>
<th style="text-align: right;">BIC</th>
<th style="text-align: right;">BIC_wt</th>
<th style="text-align: right;">BIC_adjusted</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">one_latent</td>
<td style="text-align: left;">lavaan</td>
<td style="text-align: right;">1359.7168</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">159746.19</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.9533955</td>
<td style="text-align: right;">0.9067909</td>
<td style="text-align: right;">0.9914883</td>
<td style="text-align: right;">0.9873622</td>
<td style="text-align: right;">0.9915748</td>
<td style="text-align: right;">0.1033455</td>
<td style="text-align: right;">0.0987385</td>
<td style="text-align: right;">0.1080285</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">36.00334</td>
<td style="text-align: right;">0.0493327</td>
<td style="text-align: right;">0.9872324</td>
<td style="text-align: right;">0.6609922</td>
<td style="text-align: right;">0.9915752</td>
<td style="text-align: right;">0.9915748</td>
<td style="text-align: right;">-151483.7</td>
<td style="text-align: right;">302995.3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">303094.8</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">303050.3</td>
</tr>
<tr class="even">
<td style="text-align: left;">two_latents</td>
<td style="text-align: left;">lavaan</td>
<td style="text-align: right;">317.9709</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30915.77</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.9900793</td>
<td style="text-align: right;">0.9786322</td>
<td style="text-align: right;">0.9897149</td>
<td style="text-align: right;">0.9840541</td>
<td style="text-align: right;">0.9901287</td>
<td style="text-align: right;">0.0510548</td>
<td style="text-align: right;">0.0462789</td>
<td style="text-align: right;">0.0559908</td>
<td style="text-align: right;">0.3499758</td>
<td style="text-align: right;">36.31236</td>
<td style="text-align: right;">0.0226983</td>
<td style="text-align: right;">0.9833857</td>
<td style="text-align: right;">0.6126807</td>
<td style="text-align: right;">0.9901313</td>
<td style="text-align: right;">0.9901287</td>
<td style="text-align: right;">-150962.8</td>
<td style="text-align: right;">301955.6</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">302062.2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">302014.5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">three_latents</td>
<td style="text-align: left;">lavaan</td>
<td style="text-align: right;">747.8723</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">20903.30</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.9763317</td>
<td style="text-align: right;">0.9447739</td>
<td style="text-align: right;">0.9642223</td>
<td style="text-align: right;">0.9383317</td>
<td style="text-align: right;">0.9647609</td>
<td style="text-align: right;">0.0825447</td>
<td style="text-align: right;">0.0775761</td>
<td style="text-align: right;">0.0876237</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">37.13824</td>
<td style="text-align: right;">0.0377955</td>
<td style="text-align: right;">0.9373890</td>
<td style="text-align: right;">0.5509842</td>
<td style="text-align: right;">0.9647761</td>
<td style="text-align: right;">0.9647609</td>
<td style="text-align: right;">-151177.7</td>
<td style="text-align: right;">302387.5</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">302501.2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">302450.3</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This table provides the results of three different Confirmatory Factor Analysis (CFA) models: one that specifies a single latent factor, one that specifies two latent factors, and one that specifies three latent factors. The results include a number of goodness-of-fit statistics, which can be used to assess how well each model fits the data.</p>
<section id="one_latent-cfa" class="level4">
<h4 class="anchored" data-anchor-id="one_latent-cfa">One_latent CFA:</h4>
<p>This model assumes that there is only one underlying latent factor contributing to all variables. This model has a chi-square statistic of 1359.7 with 14 degrees of freedom, which is highly significant (p&lt;0.001), indicating a poor fit of the model to the data. Other goodness-of-fit indices like GFI, AGFI, NFI, NNFI, and CFI are all high (above 0.9), generally indicating good fit, but these indices can be misleading in the presence of large sample sizes. RMSEA is above 0.1 which indicates a poor fit. The SRMR is less than 0.08 which suggests a good fit, but given the high Chi-square and RMSEA values, we can’t solely rely on this index. The Akaike information criterion (AIC), Bayesian information criterion (BIC) and adjusted BIC are used for comparing models, with lower values indicating better fit.</p>
</section>
<section id="two_latents-cfa" class="level4">
<h4 class="anchored" data-anchor-id="two_latents-cfa">Two_latents CFA</h4>
<p>This model assumes that there are two underlying latent factors. The chi-square statistic is lower than the one-factor model (317.97 with 13 df), suggesting a better fit. The p-value is still less than 0.05, indicating a statistically significant chi-square, which typically suggests a poor fit. However, all other fit indices (GFI, AGFI, NFI, NNFI, and CFI) are above 0.9 and the RMSEA is 0.051, which generally indicate good fit. The SRMR is also less than 0.08 which suggests a good fit. This model has the lowest AIC and BIC values among the three models, indicating the best fit according to these criteria.</p>
</section>
<section id="three_latents-cfa" class="level4">
<h4 class="anchored" data-anchor-id="three_latents-cfa">Three_latents CFA</h4>
<p>This model assumes three underlying latent factors. The chi-square statistic is 747.87 with 12 df, higher than the two-factor model, suggesting a worse fit to the data. Other fit indices such as GFI, AGFI, NFI, NNFI, and CFI are below 0.97 and the RMSEA is 0.083, which generally indicate acceptable but not excellent fit. The SRMR is less than 0.08 which suggests a good fit. The AIC and BIC values are higher than the two-factor model but lower than the one-factor model, indicating a fit that is better than the one-factor model but worse than the two-factor model.</p>
<p>Based on these results, the two-latents model seems to provide the best fit to the data among the three models, according to most of the fit indices and the AIC and BIC. Note, all models have significant chi-square statistics, which suggests some degree of misfit. It’s also important to consider the substantive interpretation of the factors, to make sure the model makes sense theoretically.</p>
</section>
</section>
<section id="multi-group-confirmatory-factor-analysis" class="level3">
<h3 class="anchored" data-anchor-id="multi-group-confirmatory-factor-analysis">Multi-group Confirmatory Factor Analysis</h3>
<p>This script runs multi-group confirmatory factor analysis (MG-CFA)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select needed columns plus 'ethnicity'</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co"># filter dataset for only 'euro' and 'maori' ethnic categories</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>dt_eth_k6_eth <span class="ot">&lt;-</span> dt_start <span class="sc">|&gt;</span> </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eth_cat <span class="sc">==</span> <span class="st">"euro"</span> <span class="sc">|</span> eth_cat <span class="sc">==</span> <span class="st">"maori"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(kessler_depressed, kessler_effort,kessler_hopeless,</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>         kessler_worthless, kessler_nervous,</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>         kessler_restless, eth_cat)</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="co"># partition the dataset into training and test subsets</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="co"># stratify by ethnic category to ensure balanced representation</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>part_data_eth <span class="ot">&lt;-</span> datawizard<span class="sc">::</span><span class="fu">data_partition</span>(dt_eth_k6_eth, <span class="at">traing_proportion =</span> .<span class="dv">07</span>, <span class="at">seed =</span> <span class="dv">123</span>, <span class="at">group =</span> <span class="st">"eth_cat"</span>)</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>training_eth <span class="ot">&lt;-</span> part_data_eth<span class="sc">$</span>p_0<span class="fl">.7</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>test_eth <span class="ot">&lt;-</span> part_data_eth<span class="sc">$</span>test</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a><span class="co"># run confirmatory factor analysis (CFA) models for configural invariance across ethnic groups</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a><span class="co"># models specify one, two, and three latent variables</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>one_latent_eth_configural <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_one, <span class="at">group =</span> <span class="st">"eth_cat"</span>, <span class="at">data =</span> test_eth))</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>two_latents_eth_configural <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_two, <span class="at">group =</span> <span class="st">"eth_cat"</span>, <span class="at">data =</span> test_eth))</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>three_latents_eth_configural <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_three, <span class="at">group =</span> <span class="st">"eth_cat"</span>, <span class="at">data =</span> test_eth))</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a><span class="co"># compare model performances for configural invariance</span></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>compare_eth_configural <span class="ot">&lt;-</span> performance<span class="sc">::</span><span class="fu">compare_performance</span>(one_latent_eth_configural, two_latents_eth_configural, three_latents_eth_configural, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a><span class="co"># run CFA models for metric invariance, holding factor loadings equal across groups</span></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a><span class="co"># models specify one, two, and three latent variables</span></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>one_latent_eth_metric <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_one, <span class="at">group =</span> <span class="st">"eth_cat"</span>, <span class="at">group.equal =</span> <span class="st">"loadings"</span>, <span class="at">data =</span> test_eth))</span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>two_latents_eth_metric  <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_two, <span class="at">group =</span> <span class="st">"eth_cat"</span>, <span class="at">group.equal =</span> <span class="st">"loadings"</span>, <span class="at">data =</span> test_eth))</span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>three_latents_eth_metric  <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_three, <span class="at">group =</span> <span class="st">"eth_cat"</span>,<span class="at">group.equal =</span> <span class="st">"loadings"</span>, <span class="at">data =</span> test_eth))</span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a><span class="co"># compare model performances for metric invariance</span></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>compare_eth_metric  <span class="ot">&lt;-</span> performance<span class="sc">::</span><span class="fu">compare_performance</span>(one_latent_eth_metric, two_latents_eth_metric, three_latents_eth_metric, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a><span class="co"># run CFA models for scalar invariance, holding factor loadings and intercepts equal across groups</span></span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a><span class="co"># models specify one, two, and three latent variables</span></span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a>one_latent_eth_scalar <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_one, <span class="at">group =</span> <span class="st">"eth_cat"</span>, <span class="at">group.equal =</span> <span class="fu">c</span>(<span class="st">"loadings"</span>,<span class="st">"intercepts"</span>), <span class="at">data =</span> test_eth))</span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a>two_latents_eth_scalar  <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_two, <span class="at">group =</span> <span class="st">"eth_cat"</span>, <span class="at">group.equal =</span>  <span class="fu">c</span>(<span class="st">"loadings"</span>,<span class="st">"intercepts"</span>), <span class="at">data =</span> test_eth))</span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a>three_latents_eth_scalar  <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_three, <span class="at">group =</span> <span class="st">"eth_cat"</span>,<span class="at">group.equal =</span>  <span class="fu">c</span>(<span class="st">"loadings"</span>,<span class="st">"intercepts"</span>), <span class="at">data =</span> test_eth))</span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a><span class="co"># compare model performances for scalar invariance</span></span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a>compare_eth_scalar  <span class="ot">&lt;-</span> performance<span class="sc">::</span><span class="fu">compare_performance</span>(one_latent_eth_scalar, two_latents_eth_scalar, three_latents_eth_scalar, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Recall, in the context of measurement and factor analysis, the concepts of <em>configural</em>, <em>metric</em>, and <em>scalar invariance</em> relate to the comparability of a measurement instrument, such as a survey or test, across different groups.</p>
<p>We saw in part 1 of this course that these invariance concepts are frequently tested in the context of cross-cultural, multi-group, or longitudinal studies.</p>
<p>Let’s first define these concepts, and then apply them to the context of the Kessler 6 (K6) Distress Scale used among Maori and New Zealand Europeans.</p>
<ol type="1">
<li><strong>Configural invariance</strong> refers to the most basic level of measurement invariance, and it is established when the same pattern of factor loadings and structure is observed across groups. This means that the underlying or “latent” constructs (factors) are defined the same way for different groups. This doesn’t mean the strength of relationship between items and factors (loadings) or the item means (intercepts) are the same, just that the items relate to the same factors in all groups.</li>
</ol>
<p>In the context of the K6 Distress Scale, configural invariance would suggest that the same six items are measuring the construct of psychological distress in the same way for both Māori and New Zealand Europeans, even though the strength of the relationship between the items and the construct (distress), or the average scores, might differ.</p>
<ol start="2" type="1">
<li><strong>Metric invariance</strong> (also known as “weak invariance”) refers to the assumption that factor loadings are equivalent across groups, meaning that the relationship or association between the measured items and their underlying factor is the same in all groups. This is important when comparing the strength of relationships with other variables across groups.</li>
</ol>
<p>If metric invariance holds for the K6 Distress Scale, this would mean that a unit change in the latent distress factor would correspond to the same change in each item score (e.g., feeling nervous, hopeless, restless, etc.) for both Māori and New Zealand Europeans.</p>
<ol start="3" type="1">
<li><strong>Scalar invariance</strong> (also known as “strong invariance”) involves equivalence of both factor loadings and intercepts (item means) across groups. This means that not only are the relationships between the items and the factors the same across groups (as with metric invariance), but also the zero-points or origins of the scales are the same. Scalar invariance is necessary when one wants to compare latent mean scores across groups.</li>
</ol>
<p>In the context of the K6 Distress Scale, if scalar invariance holds, it would mean that a specific score on the scale would correspond to the same level of the underlying distress factor for both Māori and New Zealand Europeans. It would mean that the groups do not differ systematically in how they interpret and respond to the items. If this holds, one can make meaningful comparisons of distress level between Maori and New Zealand Europeans based on the scale scores.</p>
<p>Note: each of these levels of invariance is a progressively stricter test of the equivalence of the measurement instrument across groups. Demonstrating scalar invariance, for example, also demonstrates configural and metric invariance. On the other hand, failure to demonstrate metric invariance means that scalar invariance also does not hold. These tests are therefore usually conducted in sequence. The results of these tests should be considered when comparing group means or examining the relationship between a scale and other variables across groups.</p>
</section>
<section id="configural-invariance" class="level3">
<h3 class="anchored" data-anchor-id="configural-invariance">Configural invariance</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(compare_eth_configural)<span class="sc">|&gt;</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 9%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Model</th>
<th style="text-align: right;">Chi2</th>
<th style="text-align: right;">Chi2_df</th>
<th style="text-align: right;">p_Chi2</th>
<th style="text-align: right;">Baseline</th>
<th style="text-align: right;">Baseline_df</th>
<th style="text-align: right;">p_Baseline</th>
<th style="text-align: right;">GFI</th>
<th style="text-align: right;">AGFI</th>
<th style="text-align: right;">NFI</th>
<th style="text-align: right;">NNFI</th>
<th style="text-align: right;">CFI</th>
<th style="text-align: right;">RMSEA</th>
<th style="text-align: right;">RMSEA_CI_low</th>
<th style="text-align: right;">RMSEA_CI_high</th>
<th style="text-align: right;">p_RMSEA</th>
<th style="text-align: right;">RMR</th>
<th style="text-align: right;">SRMR</th>
<th style="text-align: right;">RFI</th>
<th style="text-align: right;">PNFI</th>
<th style="text-align: right;">IFI</th>
<th style="text-align: right;">RNI</th>
<th style="text-align: right;">Loglikelihood</th>
<th style="text-align: right;">AIC</th>
<th style="text-align: right;">AIC_wt</th>
<th style="text-align: right;">BIC</th>
<th style="text-align: right;">BIC_wt</th>
<th style="text-align: right;">BIC_adjusted</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">one_latent_eth_configural</td>
<td style="text-align: left;">lavaan</td>
<td style="text-align: right;">1162.4746</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">341229.17</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.9831752</td>
<td style="text-align: right;">0.9579381</td>
<td style="text-align: right;">0.9965933</td>
<td style="text-align: right;">0.9949511</td>
<td style="text-align: right;">0.9966341</td>
<td style="text-align: right;">0.1027048</td>
<td style="text-align: right;">0.0977499</td>
<td style="text-align: right;">0.1077479</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">38.29915</td>
<td style="text-align: right;">0.0439380</td>
<td style="text-align: right;">0.9948899</td>
<td style="text-align: right;">0.6643955</td>
<td style="text-align: right;">0.9966342</td>
<td style="text-align: right;">0.9966341</td>
<td style="text-align: right;">-129452.1</td>
<td style="text-align: right;">258946.1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">259092.3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">259025.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">two_latents_eth_configural</td>
<td style="text-align: left;">lavaan</td>
<td style="text-align: right;">276.7703</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">42034.04</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.9961916</td>
<td style="text-align: right;">0.9897467</td>
<td style="text-align: right;">0.9934156</td>
<td style="text-align: right;">0.9898581</td>
<td style="text-align: right;">0.9937217</td>
<td style="text-align: right;">0.0510782</td>
<td style="text-align: right;">0.0459383</td>
<td style="text-align: right;">0.0564019</td>
<td style="text-align: right;">0.3560216</td>
<td style="text-align: right;">34.17489</td>
<td style="text-align: right;">0.0201464</td>
<td style="text-align: right;">0.9893636</td>
<td style="text-align: right;">0.6149715</td>
<td style="text-align: right;">0.9937229</td>
<td style="text-align: right;">0.9937217</td>
<td style="text-align: right;">-129009.2</td>
<td style="text-align: right;">258062.4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">258215.5</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">258145.6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">three_latents_eth_configural</td>
<td style="text-align: left;">lavaan</td>
<td style="text-align: right;">701.6287</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">27397.50</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.9906044</td>
<td style="text-align: right;">0.9725962</td>
<td style="text-align: right;">0.9743908</td>
<td style="text-align: right;">0.9559166</td>
<td style="text-align: right;">0.9748095</td>
<td style="text-align: right;">0.0859629</td>
<td style="text-align: right;">0.0806184</td>
<td style="text-align: right;">0.0914299</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">76.26852</td>
<td style="text-align: right;">0.0358868</td>
<td style="text-align: right;">0.9551839</td>
<td style="text-align: right;">0.5567947</td>
<td style="text-align: right;">0.9748177</td>
<td style="text-align: right;">0.9748095</td>
<td style="text-align: right;">-129221.6</td>
<td style="text-align: right;">258489.3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">258649.3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">258576.2</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The table represents the comparison of three multi-group confirmatory factor analysis (CFA) models conducted to test for configural invariance across different ethnic categories (eth_cat). Configural invariance refers to whether the pattern of factor loadings is the same across groups. It’s the most basic form of measurement invariance.</p>
<p>Looking at the results, we can draw the following conclusions:</p>
<ol type="1">
<li><p><strong>Chi2 (Chi-square)</strong>: A lower value suggests a better model fit. In this case, the two_latents_eth_configural model exhibits the lowest Chi2 value, suggesting it has the best fit according to this metric.</p></li>
<li><p><strong>GFI (Goodness of Fit Index) and AGFI (Adjusted Goodness of Fit Index)</strong>: These values range from 0 to 1, with values closer to 1 suggesting a better fit. The two_latents_eth_configural model has the highest GFI and AGFI values, indicating it is the best fit according to these indices.</p></li>
<li><p><strong>NFI (Normed Fit Index), NNFI (Non-Normed Fit Index, also called TLI), CFI (Comparative Fit Index)</strong>: These range from 0 to 1, with values closer to 1 suggesting a better fit. The one_latent_eth_configural model has the highest values, suggesting it is the best fit according to these metrics.</p></li>
<li><p><strong>RMSEA (Root Mean Square Error of Approximation)</strong>: Lower values are better, with values below 0.05 considered good and up to 0.08 considered acceptable. In this table, the two_latents_eth_configural model has an RMSEA of 0.05, which falls within the acceptable range.</p></li>
<li><p><strong>RMR (Root Mean Square Residual) and SRMR (Standardized Root Mean Square Residual)</strong>: Lower values are better, typically less than 0.08 is considered a good fit. All models exhibit acceptable RMR and SRMR values, with the two_latents_eth_configural model having the lowest.</p></li>
<li><p><strong>RFI (Relative Fit Index), PNFI (Parsimonious Normed Fit Index), IFI (Incremental Fit Index), RNI (Relative Noncentrality Index)</strong>: These range from 0 to 1, with values closer to 1 suggesting a better fit. The one_latent_eth_configural model has the highest values, suggesting the best fit according to these measures.</p></li>
<li><p><strong>AIC (Akaike Information Criterion) and BIC (Bayesian Information Criterion)</strong>: Lower values indicate a better fit when comparing models. The two_latents_eth_configural model has the lowest AIC and BIC, suggesting it is the best fit according to these criteria.</p></li>
<li><p><strong>p_Chi2 and p_RMSEA</strong>: These are the significance levels for the Chi-square test and the RMSEA, respectively. Non-significant values (p &gt; 0.05) suggest a good fit. Only the RMSEA for the two_latents_eth_configural model is non-significant, suggesting a good fit.</p></li>
</ol>
<p>Overall, the two_latents_eth_configural model appears to provide the best fit across multiple indices, suggesting configural invariance (i.e., the same general factor structure) across ethnic categories with a two-factor solution. As with the previous assessment, theoretical soundness and other substantive considerations should also be taken into account when deciding on the final model. We will return to these issues next week.</p>
</section>
<section id="metric-equivalence" class="level3">
<h3 class="anchored" data-anchor-id="metric-equivalence">Metric Equivalence</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(compare_eth_metric)<span class="sc">|&gt;</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 8%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Model</th>
<th style="text-align: right;">Chi2</th>
<th style="text-align: right;">Chi2_df</th>
<th style="text-align: right;">p_Chi2</th>
<th style="text-align: right;">Baseline</th>
<th style="text-align: right;">Baseline_df</th>
<th style="text-align: right;">p_Baseline</th>
<th style="text-align: right;">GFI</th>
<th style="text-align: right;">AGFI</th>
<th style="text-align: right;">NFI</th>
<th style="text-align: right;">NNFI</th>
<th style="text-align: right;">CFI</th>
<th style="text-align: right;">RMSEA</th>
<th style="text-align: right;">RMSEA_CI_low</th>
<th style="text-align: right;">RMSEA_CI_high</th>
<th style="text-align: right;">p_RMSEA</th>
<th style="text-align: right;">RMR</th>
<th style="text-align: right;">SRMR</th>
<th style="text-align: right;">RFI</th>
<th style="text-align: right;">PNFI</th>
<th style="text-align: right;">IFI</th>
<th style="text-align: right;">RNI</th>
<th style="text-align: right;">Loglikelihood</th>
<th style="text-align: right;">AIC</th>
<th style="text-align: right;">AIC_wt</th>
<th style="text-align: right;">BIC</th>
<th style="text-align: right;">BIC_wt</th>
<th style="text-align: right;">BIC_adjusted</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">one_latent_eth_metric</td>
<td style="text-align: left;">lavaan</td>
<td style="text-align: right;">1162.4746</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">341229.17</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.9831752</td>
<td style="text-align: right;">0.9579381</td>
<td style="text-align: right;">0.9965933</td>
<td style="text-align: right;">0.9949511</td>
<td style="text-align: right;">0.9966341</td>
<td style="text-align: right;">0.1027048</td>
<td style="text-align: right;">0.0977499</td>
<td style="text-align: right;">0.1077479</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">38.29915</td>
<td style="text-align: right;">0.0439380</td>
<td style="text-align: right;">0.9948899</td>
<td style="text-align: right;">0.6643955</td>
<td style="text-align: right;">0.9966342</td>
<td style="text-align: right;">0.9966341</td>
<td style="text-align: right;">-129452.1</td>
<td style="text-align: right;">258946.1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">259092.3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">259025.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">two_latents_eth_metric</td>
<td style="text-align: left;">lavaan</td>
<td style="text-align: right;">276.7703</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">42034.04</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.9961916</td>
<td style="text-align: right;">0.9897467</td>
<td style="text-align: right;">0.9934156</td>
<td style="text-align: right;">0.9898581</td>
<td style="text-align: right;">0.9937217</td>
<td style="text-align: right;">0.0510782</td>
<td style="text-align: right;">0.0459383</td>
<td style="text-align: right;">0.0564019</td>
<td style="text-align: right;">0.3560216</td>
<td style="text-align: right;">34.17489</td>
<td style="text-align: right;">0.0201464</td>
<td style="text-align: right;">0.9893636</td>
<td style="text-align: right;">0.6149715</td>
<td style="text-align: right;">0.9937229</td>
<td style="text-align: right;">0.9937217</td>
<td style="text-align: right;">-129009.2</td>
<td style="text-align: right;">258062.4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">258215.5</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">258145.6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">three_latents_eth_metric</td>
<td style="text-align: left;">lavaan</td>
<td style="text-align: right;">701.6287</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">27397.50</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.9906044</td>
<td style="text-align: right;">0.9725962</td>
<td style="text-align: right;">0.9743908</td>
<td style="text-align: right;">0.9559166</td>
<td style="text-align: right;">0.9748095</td>
<td style="text-align: right;">0.0859629</td>
<td style="text-align: right;">0.0806184</td>
<td style="text-align: right;">0.0914299</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">76.26852</td>
<td style="text-align: right;">0.0358868</td>
<td style="text-align: right;">0.9551839</td>
<td style="text-align: right;">0.5567947</td>
<td style="text-align: right;">0.9748177</td>
<td style="text-align: right;">0.9748095</td>
<td style="text-align: right;">-129221.6</td>
<td style="text-align: right;">258489.3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">258649.3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">258576.2</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This table presents the results of a multi-group confirmatory factor analysis (CFA) conducted to test metric equivalence (also known as measurement invariance) across different ethnic categories (eth_cat). The models (one_latent_eth_metric, two_latents_eth_metric, three_latents_eth_metric) were run with a constraint of equal factor loadings across groups, which is a requirement for metric invariance.</p>
<p>Here’s the interpretation of the fit indices:</p>
<ol type="1">
<li><p><strong>Chi2 (Chi-square)</strong>: Lower values indicate better model fit. The two_latents_eth_metric model has the lowest Chi2 value, suggesting the best fit according to this measure.</p></li>
<li><p><strong>GFI (Goodness of Fit Index), AGFI (Adjusted Goodness of Fit Index)</strong>: These range from 0 to 1, with values closer to 1 indicating a better fit. The two_latents_eth_metric model has the highest GFI and AGFI values, suggesting the best fit according to these indices.</p></li>
<li><p><strong>NFI (Normed Fit Index), NNFI (Non-Normed Fit Index, or TLI), CFI (Comparative Fit Index)</strong>: These range from 0 to 1, with values closer to 1 indicating a better fit. For these indices, the one_latent_eth_metric model has the highest values, suggesting the best fit according to these measures.</p></li>
<li><p><strong>RMSEA (Root Mean Square Error of Approximation)</strong>: Lower values are better, with values below 0.05 generally considered good, and values up to 0.08 considered acceptable. Only the two_latents_eth_metric model has an RMSEA within the acceptable range (0.051).</p></li>
<li><p><strong>RMR (Root Mean Square Residual) and SRMR (Standardized Root Mean Square Residual)</strong>: Lower values are better, typically less than 0.08 is considered a good fit. All models have acceptable RMR and SRMR values, with the two_latents_eth_metric model having the lowest, indicating the best fit.</p></li>
<li><p><strong>RFI (Relative Fit Index), PNFI (Parsimonious Normed Fit Index), IFI (Incremental Fit Index), RNI (Relative Noncentrality Index)</strong>: These range from 0 to 1, with values closer to 1 indicating better fit. The one_latent_eth_metric model has the highest values, suggesting the best fit according to these indices.</p></li>
<li><p><strong>AIC (Akaike Information Criterion) and BIC (Bayesian Information Criterion)</strong>: Lower values indicate a better fit when comparing models. The two_latents_eth_metric model has the lowest AIC and BIC, indicating the best fit according to these criteria.</p></li>
<li><p><strong>p_Chi2 and p_RMSEA</strong>: These are the significance levels for the Chi-square test and the RMSEA, respectively. Statistically non-significant values at the traditional threshold (p &gt; 0.05) suggest a good fit. Only the RMSEA for the two_latents_eth_metric model is statistically non-significant, suggesting a good fit.</p></li>
</ol>
<p>In summary, the two_latents_eth_metric model appears to provide the best fit overall, indicating that a two-factor solution might be appropriate and that the metric equivalence (equal factor loadings) assumption is supported across ethnic categories. However, one must also take into consideration the theoretical soundness of the model and other substantive considerations when deciding on the final model.</p>
</section>
<section id="scalar-equivalence" class="level3">
<h3 class="anchored" data-anchor-id="scalar-equivalence">Scalar Equivalence</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># view as html table</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(compare_eth_scalar)<span class="sc">|&gt;</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 8%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Model</th>
<th style="text-align: right;">Chi2</th>
<th style="text-align: right;">Chi2_df</th>
<th style="text-align: right;">p_Chi2</th>
<th style="text-align: right;">Baseline</th>
<th style="text-align: right;">Baseline_df</th>
<th style="text-align: right;">p_Baseline</th>
<th style="text-align: right;">GFI</th>
<th style="text-align: right;">AGFI</th>
<th style="text-align: right;">NFI</th>
<th style="text-align: right;">NNFI</th>
<th style="text-align: right;">CFI</th>
<th style="text-align: right;">RMSEA</th>
<th style="text-align: right;">RMSEA_CI_low</th>
<th style="text-align: right;">RMSEA_CI_high</th>
<th style="text-align: right;">p_RMSEA</th>
<th style="text-align: right;">RMR</th>
<th style="text-align: right;">SRMR</th>
<th style="text-align: right;">RFI</th>
<th style="text-align: right;">PNFI</th>
<th style="text-align: right;">IFI</th>
<th style="text-align: right;">RNI</th>
<th style="text-align: right;">Loglikelihood</th>
<th style="text-align: right;">AIC</th>
<th style="text-align: right;">AIC_wt</th>
<th style="text-align: right;">BIC</th>
<th style="text-align: right;">BIC_wt</th>
<th style="text-align: right;">BIC_adjusted</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">one_latent_eth_scalar</td>
<td style="text-align: left;">lavaan</td>
<td style="text-align: right;">1162.4746</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">341229.17</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.9831752</td>
<td style="text-align: right;">0.9579381</td>
<td style="text-align: right;">0.9965933</td>
<td style="text-align: right;">0.9949511</td>
<td style="text-align: right;">0.9966341</td>
<td style="text-align: right;">0.1027048</td>
<td style="text-align: right;">0.0977499</td>
<td style="text-align: right;">0.1077479</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">38.29915</td>
<td style="text-align: right;">0.0439380</td>
<td style="text-align: right;">0.9948899</td>
<td style="text-align: right;">0.6643955</td>
<td style="text-align: right;">0.9966342</td>
<td style="text-align: right;">0.9966341</td>
<td style="text-align: right;">-129452.1</td>
<td style="text-align: right;">258946.1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">259092.3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">259025.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">two_latents_eth_scalar</td>
<td style="text-align: left;">lavaan</td>
<td style="text-align: right;">276.7703</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">42034.04</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.9961916</td>
<td style="text-align: right;">0.9897467</td>
<td style="text-align: right;">0.9934156</td>
<td style="text-align: right;">0.9898581</td>
<td style="text-align: right;">0.9937217</td>
<td style="text-align: right;">0.0510782</td>
<td style="text-align: right;">0.0459383</td>
<td style="text-align: right;">0.0564019</td>
<td style="text-align: right;">0.3560216</td>
<td style="text-align: right;">34.17489</td>
<td style="text-align: right;">0.0201464</td>
<td style="text-align: right;">0.9893636</td>
<td style="text-align: right;">0.6149715</td>
<td style="text-align: right;">0.9937229</td>
<td style="text-align: right;">0.9937217</td>
<td style="text-align: right;">-129009.2</td>
<td style="text-align: right;">258062.4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">258215.5</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">258145.6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">three_latents_eth_scalar</td>
<td style="text-align: left;">lavaan</td>
<td style="text-align: right;">701.6287</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">27397.50</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.9906044</td>
<td style="text-align: right;">0.9725962</td>
<td style="text-align: right;">0.9743908</td>
<td style="text-align: right;">0.9559166</td>
<td style="text-align: right;">0.9748095</td>
<td style="text-align: right;">0.0859629</td>
<td style="text-align: right;">0.0806184</td>
<td style="text-align: right;">0.0914299</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">76.26852</td>
<td style="text-align: right;">0.0358868</td>
<td style="text-align: right;">0.9551839</td>
<td style="text-align: right;">0.5567947</td>
<td style="text-align: right;">0.9748177</td>
<td style="text-align: right;">0.9748095</td>
<td style="text-align: right;">-129221.6</td>
<td style="text-align: right;">258489.3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">258649.3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">258576.2</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The table presents the results of a multi-group confirmatory factor analysis (CFA) conducted to test scalar equivalence (also known as measurement invariance) across different ethnic categories (eth_cat). The models (one_latent_eth_scalar, two_latents_eth_scalar, three_latents_eth_scalar) were run with constraints on both factor loadings and intercepts to be equal across groups, a requirement for scalar invariance.</p>
<p>Here’s the interpretation of the fit indices:</p>
<ol type="1">
<li><p><strong>Chi2 (Chi-square)</strong>: Lower values indicate better model fit. The two_latents_eth_scalar model has the lowest Chi2 value, suggesting the best fit according to this measure.</p></li>
<li><p><strong>GFI (Goodness of Fit Index), AGFI (Adjusted Goodness of Fit Index)</strong>: These range from 0 to 1, with values closer to 1 indicating a better fit. The two_latents_eth_scalar model has the highest GFI and AGFI values, suggesting the best fit according to these indices.</p></li>
<li><p><strong>NFI (Normed Fit Index), NNFI (Non-Normed Fit Index, or TLI), CFI (Comparative Fit Index)</strong>: These range from 0 to 1, with values closer to 1 indicating a better fit. The one_latent_eth_scalar model has the highest values, suggesting the best fit according to these measures.</p></li>
<li><p><strong>RMSEA (Root Mean Square Error of Approximation)</strong>: Lower values are better, with values below 0.05 generally considered good, and values up to 0.08 considered acceptable. Only the two_latents_eth_scalar model has an RMSEA within the acceptable range (0.05).</p></li>
<li><p><strong>RMR (Root Mean Square Residual) and SRMR (Standardized Root Mean Square Residual)</strong>: Lower values are better, typically less than 0.08 is considered a good fit. All models have acceptable RMR and SRMR values, with the two_latents_eth_scalar model having the lowest, indicating the best fit.</p></li>
<li><p><strong>RFI (Relative Fit Index), PNFI (Parsimonious Normed Fit Index), IFI (Incremental Fit Index), RNI (Relative Noncentrality Index)</strong>: These range from 0 to 1, with values closer to 1 indicating better fit. The one_latent_eth_scalar model has the highest values, suggesting the best fit according to these indices.</p></li>
<li><p><strong>AIC (Akaike Information Criterion) and BIC (Bayesian Information Criterion)</strong>: Lower values indicate a better fit when comparing models. The two_latents_eth_scalar model has the lowest AIC and BIC, indicating the best fit according to these criteria.</p></li>
<li><p><strong>p_Chi2 and p_RMSEA</strong>: These are the significance levels for the Chi-square test and the RMSEA, respectively. Non-significant values (p &gt; 0.05) suggest a good fit. Only the RMSEA for the two_latents_eth_scalar model is non-significant, suggesting a good fit.</p></li>
</ol>
<p>In summary, the two_latents_eth_scalar model appears to provide the best fit overall, indicating that a two-factor solution might be appropriate and that the scalar equivalence (equal factor loadings and intercepts) assumption is supported across ethnic categories. However, we must also consider the theoretical soundness of the model and other substantive considerations when deciding on the final model (a matter to which we will return next week.)</p>
<p>Overall it seems that we have good evidence for the two-factor model of Kessler-6.</p>
</section>
</section>
<section id="solutions" class="level2">
<h2 class="anchored" data-anchor-id="solutions">Solutions</h2>
<ol type="1">
<li>Generate a Kessler 6 binary score (Not Depressed vs.&nbsp;Moderately or Severely Depressed)</li>
</ol>
<p>and also:</p>
<ol start="2" type="1">
<li>Create a variable for the log of exercise hour</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># functions </span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="co">#source("https://raw.githubusercontent.com/go-bayes/templates/main/functions/funs.R")</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="co"># experimental functions (more functions)</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="co">#source(</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a> <span class="co"># "https://raw.githubusercontent.com/go-bayes/templates/main/functions/experimental_funs.R"</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="co">#)</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>nzavs_synth <span class="ot">&lt;-</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>  arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"nzavs_dat_synth_t10_t12"</span>))</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>dt_new <span class="ot">&lt;-</span> nzavs_synth <span class="sc">%&gt;%</span></span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">%&gt;%</span></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">kessler_6  =</span> <span class="fu">mean</span>(<span class="fu">sum</span>(</span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Specify the Kessler scale items</span></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>      kessler_depressed,</span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel so depressed that nothing could cheer you up?</span></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>      kessler_hopeless,</span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel hopeless?</span></span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a>      kessler_nervous,</span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel nervous?</span></span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a>      kessler_effort,</span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel that everything was an effort?</span></span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true" tabindex="-1"></a>      kessler_restless,</span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel restless or fidgety ?</span></span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true" tabindex="-1"></a>      kessler_worthless  <span class="co"># During the last 30 days, how often did you feel worthless?</span></span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true" tabindex="-1"></a>  ))) <span class="sc">|&gt;</span></span>
<span id="cb85-35"><a href="#cb85-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">kessler_6_sum =</span> <span class="fu">round</span>(<span class="fu">sum</span>(</span>
<span id="cb85-36"><a href="#cb85-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span> (</span>
<span id="cb85-37"><a href="#cb85-37" aria-hidden="true" tabindex="-1"></a>      kessler_depressed,</span>
<span id="cb85-38"><a href="#cb85-38" aria-hidden="true" tabindex="-1"></a>      kessler_hopeless,</span>
<span id="cb85-39"><a href="#cb85-39" aria-hidden="true" tabindex="-1"></a>      kessler_nervous,</span>
<span id="cb85-40"><a href="#cb85-40" aria-hidden="true" tabindex="-1"></a>      kessler_effort,</span>
<span id="cb85-41"><a href="#cb85-41" aria-hidden="true" tabindex="-1"></a>      kessler_restless,</span>
<span id="cb85-42"><a href="#cb85-42" aria-hidden="true" tabindex="-1"></a>      kessler_worthless</span>
<span id="cb85-43"><a href="#cb85-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb85-44"><a href="#cb85-44" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb85-45"><a href="#cb85-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">0</span>)) <span class="sc">|&gt;</span>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb85-46"><a href="#cb85-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a categorical variable 'kessler_6_coarsen' based on the sum of Kessler scale items</span></span>
<span id="cb85-47"><a href="#cb85-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb85-48"><a href="#cb85-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">kessler_6_coarsen =</span> <span class="fu">cut</span>(</span>
<span id="cb85-49"><a href="#cb85-49" aria-hidden="true" tabindex="-1"></a>      kessler_6_sum,</span>
<span id="cb85-50"><a href="#cb85-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">24</span>),</span>
<span id="cb85-51"><a href="#cb85-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"not_depressed"</span>,</span>
<span id="cb85-52"><a href="#cb85-52" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"mildly_to_severely_depressed"</span>),</span>
<span id="cb85-53"><a href="#cb85-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">include.lowest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb85-54"><a href="#cb85-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">include.highest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb85-55"><a href="#cb85-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb85-56"><a href="#cb85-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">right =</span> <span class="cn">FALSE</span></span>
<span id="cb85-57"><a href="#cb85-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb85-58"><a href="#cb85-58" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb85-59"><a href="#cb85-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform 'hours_exercise' by applying the log function to compress its scale</span></span>
<span id="cb85-60"><a href="#cb85-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hours_exercise_log =</span> <span class="fu">log</span>(hours_exercise <span class="sc">+</span> <span class="dv">1</span>)) <span class="co"># Add 1 to avoid undefined log(0). Hours spent exercising/physical activity</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>Take Home: estimate whether exercise causally affects nervousness, using the single item of the kessler 6 score. Briefly write up your results.</li>
</ol>
<p><em>To be reviewed next week.</em></p>


<!-- -->


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-vanderweele2020" class="csl-entry" role="listitem">
VanderWeele, Tyler J, Maya B Mathur, and Ying Chen. 2020. <span>“Outcome-Wide Longitudinal Designs for Causal Inference: A New Template for Empirical Studies.”</span> <em>Statistical Science</em> 35 (3): 437466.
</div>
</div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>MIT</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb86" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Causal Inference: reconsidering cross-cultural experiments"</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2023-MAY-23"</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> references.bib</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="co">    html-math-method: katex</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="co">    warnings: false</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="co">    error: false</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="co">    messages: false</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="co">    highlight-style: dracula</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools:</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a><span class="co">      source: true</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="co">      toggle: false</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a><span class="co">      caption: none</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>Today, we dive deep into data analysis for causal inference ast it applies to observational cultural psychology. By the end, you will:</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Better understand how to integrate measurement theory with causal inference</span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Enhance your proficiency in causal analysis using doubly robust methods</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Gain insights into the application of sensitivity analysis using E-Values</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a><span class="fu">## Set up your workspace Preparing for the Journey</span></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>To kick things off, we will set up our environment. We'll source essential functions, load necessary libraries, and import synthetic data for our exploration.</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load_libraries</span></span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false </span></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Before running this source code, make sure to update to the current version of R, and to update all existing packages.</span></span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a><span class="co"># functions</span></span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"https://raw.githubusercontent.com/go-bayes/templates/main/functions/funs.R"</span>)</span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a><span class="co"># experimental functions (more functions)</span></span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(</span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"https://raw.githubusercontent.com/go-bayes/templates/main/functions/experimental_funs.R"</span></span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a><span class="co">#  If you haven't already, you should have created a folder called "data", in your Rstudio project. If not, download this file, add it to your the folder called "data" in your Rstudio project. # "https://www.dropbox.com/s/vwqijg4ha17hbs1/nzavs_dat_synth_t10_t12?dl=0"</span></span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a><span class="co"># A function we will use for our tables.</span></span>
<span id="cb86-54"><a href="#cb86-54" aria-hidden="true" tabindex="-1"></a>tab_ate_subgroup_rd <span class="ot">&lt;-</span> <span class="cf">function</span>(x,</span>
<span id="cb86-55"><a href="#cb86-55" aria-hidden="true" tabindex="-1"></a>                                new_name,</span>
<span id="cb86-56"><a href="#cb86-56" aria-hidden="true" tabindex="-1"></a>                                <span class="at">delta =</span> <span class="dv">1</span>,</span>
<span id="cb86-57"><a href="#cb86-57" aria-hidden="true" tabindex="-1"></a>                                <span class="at">sd =</span> <span class="dv">1</span>) {</span>
<span id="cb86-58"><a href="#cb86-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if required packages are installed</span></span>
<span id="cb86-59"><a href="#cb86-59" aria-hidden="true" tabindex="-1"></a>  required_packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"EValue"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb86-60"><a href="#cb86-60" aria-hidden="true" tabindex="-1"></a>  new_packages <span class="ot">&lt;-</span></span>
<span id="cb86-61"><a href="#cb86-61" aria-hidden="true" tabindex="-1"></a>    required_packages[<span class="sc">!</span>(required_packages <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[, <span class="st">"Package"</span>])]</span>
<span id="cb86-62"><a href="#cb86-62" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(new_packages))</span>
<span id="cb86-63"><a href="#cb86-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Missing packages: "</span>, <span class="fu">paste</span>(new_packages, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb86-64"><a href="#cb86-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-65"><a href="#cb86-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">require</span>(EValue)</span>
<span id="cb86-66"><a href="#cb86-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">require</span>(dplyr)</span>
<span id="cb86-67"><a href="#cb86-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-68"><a href="#cb86-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check if input data is a dataframe</span></span>
<span id="cb86-69"><a href="#cb86-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.data.frame</span>(x))</span>
<span id="cb86-70"><a href="#cb86-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Input x must be a dataframe"</span>)</span>
<span id="cb86-71"><a href="#cb86-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-72"><a href="#cb86-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if required columns are in the dataframe</span></span>
<span id="cb86-73"><a href="#cb86-73" aria-hidden="true" tabindex="-1"></a>  required_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"estimate"</span>, <span class="st">"lower_ci"</span>, <span class="st">"upper_ci"</span>)</span>
<span id="cb86-74"><a href="#cb86-74" aria-hidden="true" tabindex="-1"></a>  missing_cols <span class="ot">&lt;-</span> required_cols[<span class="sc">!</span>(required_cols <span class="sc">%in%</span> <span class="fu">colnames</span>(x))]</span>
<span id="cb86-75"><a href="#cb86-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(missing_cols) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb86-76"><a href="#cb86-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Missing columns in dataframe: "</span>,</span>
<span id="cb86-77"><a href="#cb86-77" aria-hidden="true" tabindex="-1"></a>         <span class="fu">paste</span>(missing_cols, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb86-78"><a href="#cb86-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-79"><a href="#cb86-79" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if lower_ci and upper_ci do not contain NA values</span></span>
<span id="cb86-80"><a href="#cb86-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">is.na</span>(x<span class="sc">$</span>lower_ci), <span class="fu">is.na</span>(x<span class="sc">$</span>upper_ci)))</span>
<span id="cb86-81"><a href="#cb86-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Columns 'lower_ci' and 'upper_ci' should not contain NA values"</span>)</span>
<span id="cb86-82"><a href="#cb86-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-83"><a href="#cb86-83" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> x <span class="sc">%&gt;%</span></span>
<span id="cb86-84"><a href="#cb86-84" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), round, <span class="at">digits =</span> <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb86-85"><a href="#cb86-85" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="st">"E[Y(1)]-E[Y(0)]"</span> <span class="ot">=</span> estimate)</span>
<span id="cb86-86"><a href="#cb86-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-87"><a href="#cb86-87" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>standard_error <span class="ot">&lt;-</span> <span class="fu">abs</span>(x<span class="sc">$</span>lower_ci <span class="sc">-</span> x<span class="sc">$</span>upper_ci) <span class="sc">/</span> <span class="fl">3.92</span></span>
<span id="cb86-88"><a href="#cb86-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-89"><a href="#cb86-89" aria-hidden="true" tabindex="-1"></a>  evalues_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(x)), <span class="cf">function</span>(i) {</span>
<span id="cb86-90"><a href="#cb86-90" aria-hidden="true" tabindex="-1"></a>    row_evalue <span class="ot">&lt;-</span> EValue<span class="sc">::</span><span class="fu">evalues.OLS</span>(</span>
<span id="cb86-91"><a href="#cb86-91" aria-hidden="true" tabindex="-1"></a>      x[i, <span class="st">"E[Y(1)]-E[Y(0)]"</span>],</span>
<span id="cb86-92"><a href="#cb86-92" aria-hidden="true" tabindex="-1"></a>      <span class="at">se =</span> x[i, <span class="st">"standard_error"</span>],</span>
<span id="cb86-93"><a href="#cb86-93" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd =</span> sd,</span>
<span id="cb86-94"><a href="#cb86-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">delta =</span> delta,</span>
<span id="cb86-95"><a href="#cb86-95" aria-hidden="true" tabindex="-1"></a>      <span class="at">true =</span> <span class="dv">0</span></span>
<span id="cb86-96"><a href="#cb86-96" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-97"><a href="#cb86-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If E_value is NA, set it to 1</span></span>
<span id="cb86-98"><a href="#cb86-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(row_evalue[<span class="dv">2</span>, <span class="st">"lower"</span>])) {</span>
<span id="cb86-99"><a href="#cb86-99" aria-hidden="true" tabindex="-1"></a>      row_evalue[<span class="dv">2</span>, <span class="st">"lower"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb86-100"><a href="#cb86-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb86-101"><a href="#cb86-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(row_evalue[<span class="dv">2</span>, <span class="st">"upper"</span>])) {</span>
<span id="cb86-102"><a href="#cb86-102" aria-hidden="true" tabindex="-1"></a>      row_evalue[<span class="dv">2</span>, <span class="st">"upper"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb86-103"><a href="#cb86-103" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb86-104"><a href="#cb86-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="fu">round</span>(<span class="fu">as.data.frame</span>(row_evalue)[<span class="dv">2</span>, ], <span class="dv">3</span>)) <span class="co"># exclude the NA column</span></span>
<span id="cb86-105"><a href="#cb86-105" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb86-106"><a href="#cb86-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-107"><a href="#cb86-107" aria-hidden="true" tabindex="-1"></a>  evalues_df <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, evalues_list)</span>
<span id="cb86-108"><a href="#cb86-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(evalues_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"E_Value"</span>, <span class="st">"E_Val_bound"</span>)</span>
<span id="cb86-109"><a href="#cb86-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-110"><a href="#cb86-110" aria-hidden="true" tabindex="-1"></a>  tab_p <span class="ot">&lt;-</span> <span class="fu">cbind</span>(x, evalues_df)</span>
<span id="cb86-111"><a href="#cb86-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-112"><a href="#cb86-112" aria-hidden="true" tabindex="-1"></a>  tab <span class="ot">&lt;-</span></span>
<span id="cb86-113"><a href="#cb86-113" aria-hidden="true" tabindex="-1"></a>    tab_p <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">c</span>(</span>
<span id="cb86-114"><a href="#cb86-114" aria-hidden="true" tabindex="-1"></a>      <span class="st">"E[Y(1)]-E[Y(0)]"</span>,</span>
<span id="cb86-115"><a href="#cb86-115" aria-hidden="true" tabindex="-1"></a>      <span class="st">"lower_ci"</span>,</span>
<span id="cb86-116"><a href="#cb86-116" aria-hidden="true" tabindex="-1"></a>      <span class="st">"upper_ci"</span>,</span>
<span id="cb86-117"><a href="#cb86-117" aria-hidden="true" tabindex="-1"></a>      <span class="st">"E_Value"</span>,</span>
<span id="cb86-118"><a href="#cb86-118" aria-hidden="true" tabindex="-1"></a>      <span class="st">"E_Val_bound"</span></span>
<span id="cb86-119"><a href="#cb86-119" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb86-120"><a href="#cb86-120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-121"><a href="#cb86-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(tab)</span>
<span id="cb86-122"><a href="#cb86-122" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-123"><a href="#cb86-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-124"><a href="#cb86-124" aria-hidden="true" tabindex="-1"></a><span class="co"># extra packages we need</span></span>
<span id="cb86-125"><a href="#cb86-125" aria-hidden="true" tabindex="-1"></a><span class="co"># for efa/cfa</span></span>
<span id="cb86-126"><a href="#cb86-126" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(psych)) {</span>
<span id="cb86-127"><a href="#cb86-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"psych"</span>)</span>
<span id="cb86-128"><a href="#cb86-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"psych"</span>)</span>
<span id="cb86-129"><a href="#cb86-129" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-130"><a href="#cb86-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-131"><a href="#cb86-131" aria-hidden="true" tabindex="-1"></a><span class="co"># for reporting</span></span>
<span id="cb86-132"><a href="#cb86-132" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(parameters)) {</span>
<span id="cb86-133"><a href="#cb86-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"parameters"</span>)</span>
<span id="cb86-134"><a href="#cb86-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"parameters"</span>)</span>
<span id="cb86-135"><a href="#cb86-135" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-136"><a href="#cb86-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-137"><a href="#cb86-137" aria-hidden="true" tabindex="-1"></a><span class="co"># for graphing</span></span>
<span id="cb86-138"><a href="#cb86-138" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(see)) {</span>
<span id="cb86-139"><a href="#cb86-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"see"</span>)</span>
<span id="cb86-140"><a href="#cb86-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"see"</span>)</span>
<span id="cb86-141"><a href="#cb86-141" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-142"><a href="#cb86-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-143"><a href="#cb86-143" aria-hidden="true" tabindex="-1"></a><span class="co"># for graphing</span></span>
<span id="cb86-144"><a href="#cb86-144" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(lavaan)) {</span>
<span id="cb86-145"><a href="#cb86-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"lavaan"</span>)</span>
<span id="cb86-146"><a href="#cb86-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"lavaan"</span>)</span>
<span id="cb86-147"><a href="#cb86-147" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-148"><a href="#cb86-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-149"><a href="#cb86-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-150"><a href="#cb86-150" aria-hidden="true" tabindex="-1"></a><span class="co"># for graphing</span></span>
<span id="cb86-151"><a href="#cb86-151" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(datawizard)) {</span>
<span id="cb86-152"><a href="#cb86-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"datawizard"</span>)</span>
<span id="cb86-153"><a href="#cb86-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(<span class="st">"datawizard"</span>)</span>
<span id="cb86-154"><a href="#cb86-154" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-155"><a href="#cb86-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-156"><a href="#cb86-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-157"><a href="#cb86-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-158"><a href="#cb86-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-159"><a href="#cb86-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-160"><a href="#cb86-160" aria-hidden="true" tabindex="-1"></a><span class="fu">### Import the data</span></span>
<span id="cb86-161"><a href="#cb86-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-164"><a href="#cb86-164" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-165"><a href="#cb86-165" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: import_data</span></span>
<span id="cb86-166"><a href="#cb86-166" aria-hidden="true" tabindex="-1"></a><span class="co"># This will read the synthetic data into Rstudio.  Note that the arrow package allows us to have lower memory demands in the storage and retrieval of data.</span></span>
<span id="cb86-167"><a href="#cb86-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-168"><a href="#cb86-168" aria-hidden="true" tabindex="-1"></a>nzavs_synth <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"nzavs_dat_synth_t10_t12"</span>))</span>
<span id="cb86-169"><a href="#cb86-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-170"><a href="#cb86-170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-171"><a href="#cb86-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-172"><a href="#cb86-172" aria-hidden="true" tabindex="-1"></a>Next, we will inspect column names.</span>
<span id="cb86-173"><a href="#cb86-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-174"><a href="#cb86-174" aria-hidden="true" tabindex="-1"></a>Make sure to familiarise your self with the variable names <span class="co">[</span><span class="ot">here</span><span class="co">](https://github.com/go-bayes/psych-434-2023/blob/main/data/readme.qmd)</span></span>
<span id="cb86-175"><a href="#cb86-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-176"><a href="#cb86-176" aria-hidden="true" tabindex="-1"></a>It is alwasy a good idea to plot the data (do on your own time.)</span>
<span id="cb86-177"><a href="#cb86-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-180"><a href="#cb86-180" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-181"><a href="#cb86-181" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: colnames</span></span>
<span id="cb86-182"><a href="#cb86-182" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb86-183"><a href="#cb86-183" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb86-184"><a href="#cb86-184" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb86-185"><a href="#cb86-185" aria-hidden="true" tabindex="-1"></a><span class="do">## use colnames to inspect the variables</span></span>
<span id="cb86-186"><a href="#cb86-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-187"><a href="#cb86-187" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(nzavs_synth)</span>
<span id="cb86-188"><a href="#cb86-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-189"><a href="#cb86-189" aria-hidden="true" tabindex="-1"></a><span class="co"># more about the variables here: </span></span>
<span id="cb86-190"><a href="#cb86-190" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/go-bayes/psych-434-2023/blob/main/data/readme.qmd</span></span>
<span id="cb86-191"><a href="#cb86-191" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-192"><a href="#cb86-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-193"><a href="#cb86-193" aria-hidden="true" tabindex="-1"></a><span class="fu">## Revisit the checklist</span></span>
<span id="cb86-194"><a href="#cb86-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-195"><a href="#cb86-195" aria-hidden="true" tabindex="-1"></a>As we delve deeper, it's essential to remember our checklist:</span>
<span id="cb86-196"><a href="#cb86-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-197"><a href="#cb86-197" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Clearly state your question.</span>
<span id="cb86-198"><a href="#cb86-198" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Explain its relevance.</span>
<span id="cb86-199"><a href="#cb86-199" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Ensure your question is causal.</span>
<span id="cb86-200"><a href="#cb86-200" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>Develop a subgroup analysis question if applicable.</span>
<span id="cb86-201"><a href="#cb86-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-202"><a href="#cb86-202" aria-hidden="true" tabindex="-1"></a>Our discussion today revolves around two main questions:</span>
<span id="cb86-203"><a href="#cb86-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-204"><a href="#cb86-204" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Does exercise influence anxiety/depression?</span>
<span id="cb86-205"><a href="#cb86-205" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Do these effects differ among NZ Europeans and Māori?</span>
<span id="cb86-206"><a href="#cb86-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-207"><a href="#cb86-207" aria-hidden="true" tabindex="-1"></a>While these questions offer a starting point, they lack specificity. We need to clarify:</span>
<span id="cb86-208"><a href="#cb86-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-209"><a href="#cb86-209" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The amount, regularity, and duration of exercise</span>
<span id="cb86-210"><a href="#cb86-210" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The measures of depression to be used</span>
<span id="cb86-211"><a href="#cb86-211" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The expected timeline for observing the effects</span>
<span id="cb86-212"><a href="#cb86-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-213"><a href="#cb86-213" aria-hidden="true" tabindex="-1"></a>Remember, we can clarify these by emulating a hypothetical experiment, a concept we call the **Target Trial**.</span>
<span id="cb86-214"><a href="#cb86-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-215"><a href="#cb86-215" aria-hidden="true" tabindex="-1"></a>Our initial responses will be guided by the NZAVS measure of exercise, focusing on the hours of activity per week, the 1-year effect on Kessler-6 depression after initiating a change in exercise, and a particular emphasis on effect-modification by NZ European and Māori ethnic identification.</span>
<span id="cb86-216"><a href="#cb86-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-217"><a href="#cb86-217" aria-hidden="true" tabindex="-1"></a>This analysis has practical motivation, as the effects of exercise on mental health and possible differences between cultural groups remain largely uncharted territory.</span>
<span id="cb86-218"><a href="#cb86-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-219"><a href="#cb86-219" aria-hidden="true" tabindex="-1"></a>Our initial responses will be guided by the NZAVS measure of exercise, focusing on the hours of activity per week, the 1-year effect on Kessler-6 depression after initiating a change in exercise, and a particular emphasis on effect-modification by NZ European and Māori ethnic identification. This analysis has practical motivation, as the effects of exercise on mental health and possible differences between cultural groups remain largely uncharted territory.</span>
<span id="cb86-220"><a href="#cb86-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-221"><a href="#cb86-221" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sculpting the Data: A Hands-On Approach</span></span>
<span id="cb86-222"><a href="#cb86-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-223"><a href="#cb86-223" aria-hidden="true" tabindex="-1"></a>As we venture further, we'll perform a series of transformations to shape our data according to our needs. Our process will involve:</span>
<span id="cb86-224"><a href="#cb86-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-225"><a href="#cb86-225" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Constructing a Kessler 6 average score</span>
<span id="cb86-226"><a href="#cb86-226" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Building a Kessler 6 sum score</span>
<span id="cb86-227"><a href="#cb86-227" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Coarsening the Exercise score</span>
<span id="cb86-228"><a href="#cb86-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-229"><a href="#cb86-229" aria-hidden="true" tabindex="-1"></a>Consider the ambiguity in the NZAVS exercise question: "During the past week, list 'Hours spent exercising/physical activity'." Different people interpret physical activity differently; John may consider any wakeful time as physical activity, while Jane counts only aerobic exercise. Such variation underlines the importance of the consistency assumption in causal inference. But we'll delve deeper into that later.</span>
<span id="cb86-230"><a href="#cb86-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-231"><a href="#cb86-231" aria-hidden="true" tabindex="-1"></a>For now, let's transform our indicators.</span>
<span id="cb86-232"><a href="#cb86-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-235"><a href="#cb86-235" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-236"><a href="#cb86-236" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data_wrangling</span></span>
<span id="cb86-237"><a href="#cb86-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-238"><a href="#cb86-238" aria-hidden="true" tabindex="-1"></a><span class="co"># create sum score of kessler 6</span></span>
<span id="cb86-239"><a href="#cb86-239" aria-hidden="true" tabindex="-1"></a>dt_start <span class="ot">&lt;-</span> nzavs_synth <span class="sc">%&gt;%</span></span>
<span id="cb86-240"><a href="#cb86-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">%&gt;%</span></span>
<span id="cb86-241"><a href="#cb86-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-242"><a href="#cb86-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lifesat_composite  =</span> <span class="fu">mean</span>(</span>
<span id="cb86-243"><a href="#cb86-243" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(lifesat_satlife,                         </span>
<span id="cb86-244"><a href="#cb86-244" aria-hidden="true" tabindex="-1"></a>    lifesat_ideal) ))<span class="sc">|&gt;</span> </span>
<span id="cb86-245"><a href="#cb86-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">kessler_6  =</span> <span class="fu">mean</span>(</span>
<span id="cb86-246"><a href="#cb86-246" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Specify the Kessler scale items</span></span>
<span id="cb86-247"><a href="#cb86-247" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb86-248"><a href="#cb86-248" aria-hidden="true" tabindex="-1"></a>      kessler_depressed,</span>
<span id="cb86-249"><a href="#cb86-249" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel so depressed that nothing could cheer you up?</span></span>
<span id="cb86-250"><a href="#cb86-250" aria-hidden="true" tabindex="-1"></a>      kessler_hopeless,</span>
<span id="cb86-251"><a href="#cb86-251" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel hopeless?</span></span>
<span id="cb86-252"><a href="#cb86-252" aria-hidden="true" tabindex="-1"></a>      kessler_nervous,</span>
<span id="cb86-253"><a href="#cb86-253" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel nervous?</span></span>
<span id="cb86-254"><a href="#cb86-254" aria-hidden="true" tabindex="-1"></a>      kessler_effort,</span>
<span id="cb86-255"><a href="#cb86-255" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel that everything was an effort?</span></span>
<span id="cb86-256"><a href="#cb86-256" aria-hidden="true" tabindex="-1"></a>      kessler_restless,</span>
<span id="cb86-257"><a href="#cb86-257" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel restless or fidgety ?</span></span>
<span id="cb86-258"><a href="#cb86-258" aria-hidden="true" tabindex="-1"></a>      kessler_worthless  <span class="co"># During the last 30 days, how often did you feel worthless?</span></span>
<span id="cb86-259"><a href="#cb86-259" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-260"><a href="#cb86-260" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">|&gt;</span></span>
<span id="cb86-261"><a href="#cb86-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">kessler_6_sum =</span> <span class="fu">round</span>(<span class="fu">sum</span>(</span>
<span id="cb86-262"><a href="#cb86-262" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span> (</span>
<span id="cb86-263"><a href="#cb86-263" aria-hidden="true" tabindex="-1"></a>      kessler_depressed,</span>
<span id="cb86-264"><a href="#cb86-264" aria-hidden="true" tabindex="-1"></a>      kessler_hopeless,</span>
<span id="cb86-265"><a href="#cb86-265" aria-hidden="true" tabindex="-1"></a>      kessler_nervous,</span>
<span id="cb86-266"><a href="#cb86-266" aria-hidden="true" tabindex="-1"></a>      kessler_effort,</span>
<span id="cb86-267"><a href="#cb86-267" aria-hidden="true" tabindex="-1"></a>      kessler_restless,</span>
<span id="cb86-268"><a href="#cb86-268" aria-hidden="true" tabindex="-1"></a>      kessler_worthless</span>
<span id="cb86-269"><a href="#cb86-269" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-270"><a href="#cb86-270" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb86-271"><a href="#cb86-271" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">0</span>)) <span class="sc">|&gt;</span>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb86-272"><a href="#cb86-272" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Coarsen 'hours_exercise' into categories</span></span>
<span id="cb86-273"><a href="#cb86-273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb86-274"><a href="#cb86-274" aria-hidden="true" tabindex="-1"></a>    <span class="at">hours_exercise_coarsen =</span> <span class="fu">cut</span>(</span>
<span id="cb86-275"><a href="#cb86-275" aria-hidden="true" tabindex="-1"></a>      hours_exercise,</span>
<span id="cb86-276"><a href="#cb86-276" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Hours spent exercising/ physical activity</span></span>
<span id="cb86-277"><a href="#cb86-277" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">8</span>, <span class="dv">200</span>),</span>
<span id="cb86-278"><a href="#cb86-278" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"inactive"</span>,</span>
<span id="cb86-279"><a href="#cb86-279" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"active"</span>,</span>
<span id="cb86-280"><a href="#cb86-280" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"very_active"</span>),</span>
<span id="cb86-281"><a href="#cb86-281" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Define thresholds for categories</span></span>
<span id="cb86-282"><a href="#cb86-282" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"(-1,3]"</span>, <span class="st">"(3,8]"</span>, <span class="st">"(8,200]"</span>),</span>
<span id="cb86-283"><a href="#cb86-283" aria-hidden="true" tabindex="-1"></a>      <span class="at">ordered =</span> <span class="cn">TRUE</span></span>
<span id="cb86-284"><a href="#cb86-284" aria-hidden="true" tabindex="-1"></a>    ))<span class="sc">|&gt;</span></span>
<span id="cb86-285"><a href="#cb86-285" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a binary 'urban' variable based on the 'rural_gch2018' variable</span></span>
<span id="cb86-286"><a href="#cb86-286" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">urban =</span> <span class="fu">factor</span>(</span>
<span id="cb86-287"><a href="#cb86-287" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(</span>
<span id="cb86-288"><a href="#cb86-288" aria-hidden="true" tabindex="-1"></a>      rural_gch2018 <span class="sc">==</span> <span class="st">"medium_urban_accessibility"</span> <span class="sc">|</span></span>
<span id="cb86-289"><a href="#cb86-289" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define urban condition</span></span>
<span id="cb86-290"><a href="#cb86-290" aria-hidden="true" tabindex="-1"></a>        rural_gch2018 <span class="sc">==</span> <span class="st">"high_urban_accessibility"</span>,</span>
<span id="cb86-291"><a href="#cb86-291" aria-hidden="true" tabindex="-1"></a>      <span class="st">"urban"</span>,</span>
<span id="cb86-292"><a href="#cb86-292" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Label 'urban' if condition is met</span></span>
<span id="cb86-293"><a href="#cb86-293" aria-hidden="true" tabindex="-1"></a>      <span class="st">"rural"</span>  <span class="co"># Label 'rural' if condition is not met</span></span>
<span id="cb86-294"><a href="#cb86-294" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-295"><a href="#cb86-295" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb86-296"><a href="#cb86-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-297"><a href="#cb86-297" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-298"><a href="#cb86-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-299"><a href="#cb86-299" aria-hidden="true" tabindex="-1"></a>Why do we coarsen the exposure? Recall the consistency assumption of causal inference:</span>
<span id="cb86-300"><a href="#cb86-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-301"><a href="#cb86-301" aria-hidden="true" tabindex="-1"></a>**Consistency:** Can I interpret what it means to intervene on the exposure? I should be able to.</span>
<span id="cb86-302"><a href="#cb86-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-303"><a href="#cb86-303" aria-hidden="true" tabindex="-1"></a>**What is th hypothetical experiment here for change in exercise?**</span>
<span id="cb86-304"><a href="#cb86-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-305"><a href="#cb86-305" aria-hidden="true" tabindex="-1"></a>Through data wrangling, we can answer our research questions more effectively by manipulating variables into more meaningful and digestible forms. We imagine an experiment in which people were within one band of the coarsened exercise band and we</span>
<span id="cb86-306"><a href="#cb86-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-307"><a href="#cb86-307" aria-hidden="true" tabindex="-1"></a>These data checks will ensure the accuracy and reliability of our transformations, setting the foundation for solid data analysis.</span>
<span id="cb86-308"><a href="#cb86-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-311"><a href="#cb86-311" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-312"><a href="#cb86-312" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb86-313"><a href="#cb86-313" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb86-314"><a href="#cb86-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-315"><a href="#cb86-315" aria-hidden="true" tabindex="-1"></a><span class="co"># do some checks</span></span>
<span id="cb86-316"><a href="#cb86-316" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(dt_start<span class="sc">$</span>hours_exercise_coarsen)</span>
<span id="cb86-317"><a href="#cb86-317" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dt_start<span class="sc">$</span>hours_exercise_coarsen)</span>
<span id="cb86-318"><a href="#cb86-318" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(dt_start<span class="sc">$</span>hours_exercise)</span>
<span id="cb86-319"><a href="#cb86-319" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(dt_start<span class="sc">$</span>hours_exercise)</span>
<span id="cb86-320"><a href="#cb86-320" aria-hidden="true" tabindex="-1"></a><span class="co"># checks</span></span>
<span id="cb86-321"><a href="#cb86-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-322"><a href="#cb86-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-323"><a href="#cb86-323" aria-hidden="true" tabindex="-1"></a><span class="co"># justification for transforming exercise" has a very long tail</span></span>
<span id="cb86-324"><a href="#cb86-324" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dt_start<span class="sc">$</span>hours_exercise, <span class="at">breaks =</span> <span class="dv">1000</span>)</span>
<span id="cb86-325"><a href="#cb86-325" aria-hidden="true" tabindex="-1"></a><span class="co"># consider only those cases below &lt; or = to 20</span></span>
<span id="cb86-326"><a href="#cb86-326" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">subset</span>(dt_start, hours_exercise <span class="sc">&lt;=</span> <span class="dv">20</span>)<span class="sc">$</span>hours_exercise)</span>
<span id="cb86-327"><a href="#cb86-327" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">as.numeric</span>(dt_start<span class="sc">$</span>hours_exercise_coarsen))</span>
<span id="cb86-328"><a href="#cb86-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-329"><a href="#cb86-329" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-330"><a href="#cb86-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-331"><a href="#cb86-331" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create variables for the latent factors</span></span>
<span id="cb86-332"><a href="#cb86-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-333"><a href="#cb86-333" aria-hidden="true" tabindex="-1"></a>Let's next get the data into shape for analysis. Here we create a variable for the two factors (see Appendix)</span>
<span id="cb86-334"><a href="#cb86-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-337"><a href="#cb86-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-338"><a href="#cb86-338" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: extract_two_factors</span></span>
<span id="cb86-339"><a href="#cb86-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-340"><a href="#cb86-340" aria-hidden="true" tabindex="-1"></a><span class="co"># get two factors from data</span></span>
<span id="cb86-341"><a href="#cb86-341" aria-hidden="true" tabindex="-1"></a>dt_start2 <span class="ot">&lt;-</span> dt_start <span class="sc">|&gt;</span></span>
<span id="cb86-342"><a href="#cb86-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb86-343"><a href="#cb86-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb86-344"><a href="#cb86-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb86-345"><a href="#cb86-345" aria-hidden="true" tabindex="-1"></a>    <span class="at">kessler_latent_depression =</span> <span class="fu">mean</span>(<span class="fu">c</span>(kessler_depressed, kessler_hopeless, kessler_effort), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb86-346"><a href="#cb86-346" aria-hidden="true" tabindex="-1"></a>    <span class="at">kessler_latent_anxiety  =</span> <span class="fu">mean</span>(<span class="fu">c</span>(kessler_effort, kessler_nervous, kessler_restless), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb86-347"><a href="#cb86-347" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb86-348"><a href="#cb86-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb86-349"><a href="#cb86-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-350"><a href="#cb86-350" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-351"><a href="#cb86-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-352"><a href="#cb86-352" aria-hidden="true" tabindex="-1"></a>Inspect the data: anxiety</span>
<span id="cb86-353"><a href="#cb86-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-356"><a href="#cb86-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-357"><a href="#cb86-357" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: histogram_kessler_anxiety</span></span>
<span id="cb86-358"><a href="#cb86-358" aria-hidden="true" tabindex="-1"></a><span class="co">#hist(dt_start2$kessler_latent_anxiety, by = dt_start2$eth_cat)</span></span>
<span id="cb86-359"><a href="#cb86-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-360"><a href="#cb86-360" aria-hidden="true" tabindex="-1"></a>create_histograms_anxiety <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb86-361"><a href="#cb86-361" aria-hidden="true" tabindex="-1"></a>  <span class="co"># require patchwork</span></span>
<span id="cb86-362"><a href="#cb86-362" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(patchwork)</span>
<span id="cb86-363"><a href="#cb86-363" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-364"><a href="#cb86-364" aria-hidden="true" tabindex="-1"></a>  <span class="co"># separate the data by eth_cat</span></span>
<span id="cb86-365"><a href="#cb86-365" aria-hidden="true" tabindex="-1"></a>  df1 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(eth_cat <span class="sc">==</span> <span class="st">"euro"</span>) <span class="co"># replace "level_1" with actual level</span></span>
<span id="cb86-366"><a href="#cb86-366" aria-hidden="true" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(eth_cat <span class="sc">==</span> <span class="st">"māori"</span>) <span class="co"># replace "level_2" with actual level</span></span>
<span id="cb86-367"><a href="#cb86-367" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-368"><a href="#cb86-368" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create the histograms</span></span>
<span id="cb86-369"><a href="#cb86-369" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df1, <span class="fu">aes</span>(<span class="at">x=</span>kessler_latent_anxiety)) <span class="sc">+</span></span>
<span id="cb86-370"><a href="#cb86-370" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"dodgerblue"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb86-371"><a href="#cb86-371" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Kessler Latent Anxiety: NZ Euro"</span>) <span class="sc">+</span></span>
<span id="cb86-372"><a href="#cb86-372" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"kessler_latent_anxiety"</span>) <span class="sc">+</span></span>
<span id="cb86-373"><a href="#cb86-373" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Count"</span>)</span>
<span id="cb86-374"><a href="#cb86-374" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-375"><a href="#cb86-375" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(<span class="at">x=</span>kessler_latent_anxiety)) <span class="sc">+</span></span>
<span id="cb86-376"><a href="#cb86-376" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"brown"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb86-377"><a href="#cb86-377" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Kessler Latent Anxiety: Māori"</span>) <span class="sc">+</span></span>
<span id="cb86-378"><a href="#cb86-378" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"kessler_latent_anxiety"</span>) <span class="sc">+</span></span>
<span id="cb86-379"><a href="#cb86-379" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Count"</span>)</span>
<span id="cb86-380"><a href="#cb86-380" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-381"><a href="#cb86-381" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot the histograms</span></span>
<span id="cb86-382"><a href="#cb86-382" aria-hidden="true" tabindex="-1"></a> p1 <span class="sc">+</span> p2 <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"a"</span>, <span class="at">title =</span> <span class="st">"comparison of anxiety histograms"</span>)</span>
<span id="cb86-383"><a href="#cb86-383" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-384"><a href="#cb86-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-385"><a href="#cb86-385" aria-hidden="true" tabindex="-1"></a><span class="fu">create_histograms_anxiety</span>(dt_start2)</span>
<span id="cb86-386"><a href="#cb86-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-387"><a href="#cb86-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-388"><a href="#cb86-388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-389"><a href="#cb86-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-392"><a href="#cb86-392" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-393"><a href="#cb86-393" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: histogram_kessler_depression</span></span>
<span id="cb86-394"><a href="#cb86-394" aria-hidden="true" tabindex="-1"></a>create_histograms_depression <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb86-395"><a href="#cb86-395" aria-hidden="true" tabindex="-1"></a>  <span class="co"># require patchwork</span></span>
<span id="cb86-396"><a href="#cb86-396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(patchwork)</span>
<span id="cb86-397"><a href="#cb86-397" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-398"><a href="#cb86-398" aria-hidden="true" tabindex="-1"></a>  <span class="co"># separate the data by eth_cat</span></span>
<span id="cb86-399"><a href="#cb86-399" aria-hidden="true" tabindex="-1"></a>  df11 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(eth_cat <span class="sc">==</span> <span class="st">"euro"</span>) <span class="co"># replace "level_1" with actual level</span></span>
<span id="cb86-400"><a href="#cb86-400" aria-hidden="true" tabindex="-1"></a>  df22 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(eth_cat <span class="sc">==</span> <span class="st">"māori"</span>) <span class="co"># replace "level_2" with actual level</span></span>
<span id="cb86-401"><a href="#cb86-401" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-402"><a href="#cb86-402" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create the histograms</span></span>
<span id="cb86-403"><a href="#cb86-403" aria-hidden="true" tabindex="-1"></a>  p11 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df11, <span class="fu">aes</span>(<span class="at">x=</span>kessler_latent_depression)) <span class="sc">+</span></span>
<span id="cb86-404"><a href="#cb86-404" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"dodgerblue"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb86-405"><a href="#cb86-405" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Kessler Latent Depression: NZ Euro"</span>) <span class="sc">+</span></span>
<span id="cb86-406"><a href="#cb86-406" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"kessler_latent_depression"</span>) <span class="sc">+</span></span>
<span id="cb86-407"><a href="#cb86-407" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Count"</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span>
<span id="cb86-408"><a href="#cb86-408" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-409"><a href="#cb86-409" aria-hidden="true" tabindex="-1"></a>  p22 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df22, <span class="fu">aes</span>(<span class="at">x=</span>kessler_latent_depression)) <span class="sc">+</span></span>
<span id="cb86-410"><a href="#cb86-410" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"brown"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb86-411"><a href="#cb86-411" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Kessler Latent Depression: Māori"</span>) <span class="sc">+</span></span>
<span id="cb86-412"><a href="#cb86-412" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"kessler_latent_depression"</span>) <span class="sc">+</span></span>
<span id="cb86-413"><a href="#cb86-413" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Count"</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span>
<span id="cb86-414"><a href="#cb86-414" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-415"><a href="#cb86-415" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot the histograms</span></span>
<span id="cb86-416"><a href="#cb86-416" aria-hidden="true" tabindex="-1"></a> p11 <span class="sc">+</span> p22 <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">tag_levels =</span> <span class="st">"a"</span>, <span class="at">title =</span> <span class="st">"comparison of depression histograms"</span>)</span>
<span id="cb86-417"><a href="#cb86-417" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-418"><a href="#cb86-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-419"><a href="#cb86-419" aria-hidden="true" tabindex="-1"></a><span class="fu">create_histograms_depression</span>(dt_start2)</span>
<span id="cb86-420"><a href="#cb86-420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-421"><a href="#cb86-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-422"><a href="#cb86-422" aria-hidden="true" tabindex="-1"></a>What do you make of these histograms?</span>
<span id="cb86-423"><a href="#cb86-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-424"><a href="#cb86-424" aria-hidden="true" tabindex="-1"></a><span class="fu">## Investigate assumption of positivity:</span></span>
<span id="cb86-425"><a href="#cb86-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-426"><a href="#cb86-426" aria-hidden="true" tabindex="-1"></a>Recall the positive assumption:</span>
<span id="cb86-427"><a href="#cb86-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-428"><a href="#cb86-428" aria-hidden="true" tabindex="-1"></a>**Positivity:** Can we intervene on the exposure at all levels of the covariates? We should be able to.</span>
<span id="cb86-429"><a href="#cb86-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-430"><a href="#cb86-430" aria-hidden="true" tabindex="-1"></a>Not this is just a description of the the summary scores. We do not assess change within indivuals</span>
<span id="cb86-431"><a href="#cb86-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-434"><a href="#cb86-434" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-435"><a href="#cb86-435" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: prepare_exposure_data</span></span>
<span id="cb86-436"><a href="#cb86-436" aria-hidden="true" tabindex="-1"></a><span class="co">#  select only the baseline year and the exposure year.  That will give us change in the exposure. ()</span></span>
<span id="cb86-437"><a href="#cb86-437" aria-hidden="true" tabindex="-1"></a>dt_exposure <span class="ot">&lt;-</span> dt_start2 <span class="sc">|&gt;</span></span>
<span id="cb86-438"><a href="#cb86-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-439"><a href="#cb86-439" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select baseline year and exposure year</span></span>
<span id="cb86-440"><a href="#cb86-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(wave <span class="sc">==</span> <span class="st">"2018"</span> <span class="sc">|</span> wave <span class="sc">==</span> <span class="st">"2019"</span>) <span class="sc">|&gt;</span></span>
<span id="cb86-441"><a href="#cb86-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-442"><a href="#cb86-442" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select variables of interest</span></span>
<span id="cb86-443"><a href="#cb86-443" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, wave, hours_exercise_coarsen,  eth_cat) <span class="sc">|&gt;</span></span>
<span id="cb86-444"><a href="#cb86-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-445"><a href="#cb86-445" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the categorical variable needs to be numeric for us to use msm package to investigate change</span></span>
<span id="cb86-446"><a href="#cb86-446" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hours_exercise_coarsen_n =</span> <span class="fu">as.numeric</span>(hours_exercise_coarsen)) <span class="sc">|&gt;</span></span>
<span id="cb86-447"><a href="#cb86-447" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb86-448"><a href="#cb86-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-449"><a href="#cb86-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-450"><a href="#cb86-450" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb86-451"><a href="#cb86-451" aria-hidden="true" tabindex="-1"></a>dt_exposure <span class="sc">|&gt;</span></span>
<span id="cb86-452"><a href="#cb86-452" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabyl</span>(hours_exercise_coarsen_n, eth_cat,  wave )</span>
<span id="cb86-453"><a href="#cb86-453" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-454"><a href="#cb86-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-455"><a href="#cb86-455" aria-hidden="true" tabindex="-1"></a>I've written a function called <span class="in">`transition_table`</span> that will help us assess change in the exposure at the individual level.</span>
<span id="cb86-456"><a href="#cb86-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-459"><a href="#cb86-459" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-460"><a href="#cb86-460" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: transition_table</span></span>
<span id="cb86-461"><a href="#cb86-461" aria-hidden="true" tabindex="-1"></a><span class="co">#   consider people going from active to vary active</span></span>
<span id="cb86-462"><a href="#cb86-462" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> msm<span class="sc">::</span><span class="fu">statetable.msm</span>(<span class="fu">round</span>(hours_exercise_coarsen_n, <span class="dv">0</span>), id, <span class="at">data =</span> dt_exposure)</span>
<span id="cb86-463"><a href="#cb86-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-464"><a href="#cb86-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-465"><a href="#cb86-465" aria-hidden="true" tabindex="-1"></a><span class="co"># for a function I wrote to create state tables</span></span>
<span id="cb86-466"><a href="#cb86-466" aria-hidden="true" tabindex="-1"></a>state_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Inactive"</span>, <span class="st">"Somewhat Active"</span>, <span class="st">"Active"</span>, <span class="st">"Extremely Active"</span>)</span>
<span id="cb86-467"><a href="#cb86-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-468"><a href="#cb86-468" aria-hidden="true" tabindex="-1"></a><span class="co"># transition table</span></span>
<span id="cb86-469"><a href="#cb86-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-470"><a href="#cb86-470" aria-hidden="true" tabindex="-1"></a><span class="fu">transition_table</span>(out, state_names)</span>
<span id="cb86-471"><a href="#cb86-471" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-472"><a href="#cb86-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-473"><a href="#cb86-473" aria-hidden="true" tabindex="-1"></a>Next consider Māori only</span>
<span id="cb86-474"><a href="#cb86-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-477"><a href="#cb86-477" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-478"><a href="#cb86-478" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: maori_only_transition</span></span>
<span id="cb86-479"><a href="#cb86-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-480"><a href="#cb86-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-481"><a href="#cb86-481" aria-hidden="true" tabindex="-1"></a><span class="co"># Maori only</span></span>
<span id="cb86-482"><a href="#cb86-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-483"><a href="#cb86-483" aria-hidden="true" tabindex="-1"></a>dt_exposure_maori <span class="ot">&lt;-</span> dt_exposure <span class="sc">|&gt;</span></span>
<span id="cb86-484"><a href="#cb86-484" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eth_cat <span class="sc">==</span> <span class="st">"māori"</span>)</span>
<span id="cb86-485"><a href="#cb86-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-486"><a href="#cb86-486" aria-hidden="true" tabindex="-1"></a>out_m <span class="ot">&lt;-</span> msm<span class="sc">::</span><span class="fu">statetable.msm</span>(<span class="fu">round</span>(hours_exercise_coarsen_n, <span class="dv">0</span>), id, <span class="at">data =</span> dt_exposure_maori)</span>
<span id="cb86-487"><a href="#cb86-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-488"><a href="#cb86-488" aria-hidden="true" tabindex="-1"></a><span class="co"># with this little support we might consider parametric models</span></span>
<span id="cb86-489"><a href="#cb86-489" aria-hidden="true" tabindex="-1"></a>t_tab_m<span class="ot">&lt;-</span> <span class="fu">transition_table</span>( out_m, state_names)</span>
<span id="cb86-490"><a href="#cb86-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-491"><a href="#cb86-491" aria-hidden="true" tabindex="-1"></a><span class="co">#interpretation</span></span>
<span id="cb86-492"><a href="#cb86-492" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(t_tab_m<span class="sc">$</span>explanation)</span>
<span id="cb86-493"><a href="#cb86-493" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(t_tab_m<span class="sc">$</span>table)</span>
<span id="cb86-494"><a href="#cb86-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-495"><a href="#cb86-495" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-496"><a href="#cb86-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-499"><a href="#cb86-499" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-500"><a href="#cb86-500" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: euro_only_transition</span></span>
<span id="cb86-501"><a href="#cb86-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-502"><a href="#cb86-502" aria-hidden="true" tabindex="-1"></a><span class="co"># filter euro</span></span>
<span id="cb86-503"><a href="#cb86-503" aria-hidden="true" tabindex="-1"></a>dt_exposure_euro <span class="ot">&lt;-</span> dt_exposure <span class="sc">|&gt;</span></span>
<span id="cb86-504"><a href="#cb86-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eth_cat <span class="sc">==</span> <span class="st">"euro"</span>)</span>
<span id="cb86-505"><a href="#cb86-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-506"><a href="#cb86-506" aria-hidden="true" tabindex="-1"></a><span class="co"># model change</span></span>
<span id="cb86-507"><a href="#cb86-507" aria-hidden="true" tabindex="-1"></a>out_e <span class="ot">&lt;-</span> msm<span class="sc">::</span><span class="fu">statetable.msm</span>(<span class="fu">round</span>(hours_exercise_coarsen_n, <span class="dv">0</span>), id, <span class="at">data =</span> dt_exposure_euro)</span>
<span id="cb86-508"><a href="#cb86-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-509"><a href="#cb86-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-510"><a href="#cb86-510" aria-hidden="true" tabindex="-1"></a><span class="co"># creat transition table.</span></span>
<span id="cb86-511"><a href="#cb86-511" aria-hidden="true" tabindex="-1"></a>t_tab_e <span class="ot">&lt;-</span> <span class="fu">transition_table</span>( out_e, state_names)</span>
<span id="cb86-512"><a href="#cb86-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-513"><a href="#cb86-513" aria-hidden="true" tabindex="-1"></a><span class="co">#interpretation</span></span>
<span id="cb86-514"><a href="#cb86-514" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(t_tab_e<span class="sc">$</span>explanation)</span>
<span id="cb86-515"><a href="#cb86-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-516"><a href="#cb86-516" aria-hidden="true" tabindex="-1"></a><span class="co"># table</span></span>
<span id="cb86-517"><a href="#cb86-517" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(t_tab_e<span class="sc">$</span>table)</span>
<span id="cb86-518"><a href="#cb86-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-519"><a href="#cb86-519" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-520"><a href="#cb86-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-521"><a href="#cb86-521" aria-hidden="true" tabindex="-1"></a>Overall we find evidence for change in the exposure variable. This suggest that we are ready to proceed with the next step of causal estimation.</span>
<span id="cb86-522"><a href="#cb86-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-523"><a href="#cb86-523" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create wide data frame for analysis</span></span>
<span id="cb86-524"><a href="#cb86-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-525"><a href="#cb86-525" aria-hidden="true" tabindex="-1"></a>Recall, I wrote a function for you that will put the data into temporal order such that measurement of the exposure and outcome appear at baseline, along with a rich set of baseline confounders, the exposure appears in the following wave, and the outcome appears in the wave following the exposure.</span>
<span id="cb86-526"><a href="#cb86-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-529"><a href="#cb86-529" aria-hidden="true" tabindex="-1"></a><span class="in">```{tikz}</span></span>
<span id="cb86-530"><a href="#cb86-530" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: fig-dag-6</span></span>
<span id="cb86-531"><a href="#cb86-531" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Causal graph: three-wave panel design"</span></span>
<span id="cb86-532"><a href="#cb86-532" aria-hidden="true" tabindex="-1"></a><span class="in">#| out-width: 100%</span></span>
<span id="cb86-533"><a href="#cb86-533" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb86-534"><a href="#cb86-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-535"><a href="#cb86-535" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{positioning}</span></span>
<span id="cb86-536"><a href="#cb86-536" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{shapes.geometric}</span></span>
<span id="cb86-537"><a href="#cb86-537" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{arrows}</span></span>
<span id="cb86-538"><a href="#cb86-538" aria-hidden="true" tabindex="-1"></a><span class="in">\usetikzlibrary{decorations}</span></span>
<span id="cb86-539"><a href="#cb86-539" aria-hidden="true" tabindex="-1"></a><span class="in">\tikzstyle{Arrow} = [-&gt;, thin, preaction = {decorate}]</span></span>
<span id="cb86-540"><a href="#cb86-540" aria-hidden="true" tabindex="-1"></a><span class="in">\tikzset{&gt;=latex}</span></span>
<span id="cb86-541"><a href="#cb86-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-542"><a href="#cb86-542" aria-hidden="true" tabindex="-1"></a><span class="in">\begin{tikzpicture}[{every node/.append style}=draw]</span></span>
<span id="cb86-543"><a href="#cb86-543" aria-hidden="true" tabindex="-1"></a><span class="in">\node [rectangle, draw=white] (U) at (0, 0) {U};</span></span>
<span id="cb86-544"><a href="#cb86-544" aria-hidden="true" tabindex="-1"></a><span class="in">\node [rectangle, draw=black, align=left] (L) at (2, 0) {t0/L \\t0/A \\t0/Y};</span></span>
<span id="cb86-545"><a href="#cb86-545" aria-hidden="true" tabindex="-1"></a><span class="in">\node [rectangle, draw=white] (A) at (4, 0) {t1/A};</span></span>
<span id="cb86-546"><a href="#cb86-546" aria-hidden="true" tabindex="-1"></a><span class="in">\node [ellipse, draw=white] (Y) at (6, 0) {t2/Y};</span></span>
<span id="cb86-547"><a href="#cb86-547" aria-hidden="true" tabindex="-1"></a><span class="in">\draw [-latex, draw=black] (U) to (L);</span></span>
<span id="cb86-548"><a href="#cb86-548" aria-hidden="true" tabindex="-1"></a><span class="in">\draw [-latex, draw=black] (L) to (A);</span></span>
<span id="cb86-549"><a href="#cb86-549" aria-hidden="true" tabindex="-1"></a><span class="in">\draw [-latex, draw=red, dotted] (A) to (Y);</span></span>
<span id="cb86-550"><a href="#cb86-550" aria-hidden="true" tabindex="-1"></a><span class="in">\draw [-latex, bend left=50, draw =black] (L) to (Y);</span></span>
<span id="cb86-551"><a href="#cb86-551" aria-hidden="true" tabindex="-1"></a><span class="in">\draw [-latex, bend right=50, draw =black, dotted] (U) to (Y);</span></span>
<span id="cb86-552"><a href="#cb86-552" aria-hidden="true" tabindex="-1"></a><span class="in">\draw [-latex, bend left=50, draw =black, dotted] (U) to (A);</span></span>
<span id="cb86-553"><a href="#cb86-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-554"><a href="#cb86-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-555"><a href="#cb86-555" aria-hidden="true" tabindex="-1"></a><span class="in">\end{tikzpicture}</span></span>
<span id="cb86-556"><a href="#cb86-556" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-557"><a href="#cb86-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-558"><a href="#cb86-558" aria-hidden="true" tabindex="-1"></a>The graph encodes our assumptions about the world. It is a qualitative instrument to help us understand how to move from our assumptions to decisions about our analysis, in the first instance, the decision about whether to proceed with an analysis.</span>
<span id="cb86-559"><a href="#cb86-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-560"><a href="#cb86-560" aria-hidden="true" tabindex="-1"></a>It is perhaps useful here to stop and consider what does this graph implies.</span>
<span id="cb86-561"><a href="#cb86-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-562"><a href="#cb86-562" aria-hidden="true" tabindex="-1"></a>Question: 1. Does the graph imply unmeasured confounding?</span>
<span id="cb86-563"><a href="#cb86-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-564"><a href="#cb86-564" aria-hidden="true" tabindex="-1"></a>Question 2. If there is unmeasured confounding, should we proceed?</span>
<span id="cb86-565"><a href="#cb86-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-566"><a href="#cb86-566" aria-hidden="true" tabindex="-1"></a><span class="fu">### E-value</span></span>
<span id="cb86-567"><a href="#cb86-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-568"><a href="#cb86-568" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; The minimum strength of association on the risk ratio scale that an unmeasured confounder would need to have with both the exposure and the outcome, conditional on the measured covariates, to fully explain away a specific exposure-outcome association</span></span>
<span id="cb86-569"><a href="#cb86-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-570"><a href="#cb86-570" aria-hidden="true" tabindex="-1"></a>See: <span class="co">[</span><span class="ot">@vanderweele2020</span><span class="co">]</span></span>
<span id="cb86-571"><a href="#cb86-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-572"><a href="#cb86-572" aria-hidden="true" tabindex="-1"></a>For example, suppose that the lower bound of the the E-value was 1.3 with the lower bound of the confidence interval = 1.12, we might then write:</span>
<span id="cb86-573"><a href="#cb86-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-574"><a href="#cb86-574" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; With an observed risk ratio of RR=1.3, an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of 1.3-fold each (or 30%), above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of 1.12-fold (or 12%) each could do so, but weaker joint confounder associations could not.</span></span>
<span id="cb86-575"><a href="#cb86-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-576"><a href="#cb86-576" aria-hidden="true" tabindex="-1"></a>The equations are as follows (for risk ratios)</span>
<span id="cb86-577"><a href="#cb86-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-578"><a href="#cb86-578" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-579"><a href="#cb86-579" aria-hidden="true" tabindex="-1"></a>E-value_{RR} = RR + \sqrt{RR \times (RR - 1)}</span>
<span id="cb86-580"><a href="#cb86-580" aria-hidden="true" tabindex="-1"></a>$$ $$</span>
<span id="cb86-581"><a href="#cb86-581" aria-hidden="true" tabindex="-1"></a>E-value_{LCL} = LCL + \sqrt{LCL \times (LCL - 1)}</span>
<span id="cb86-582"><a href="#cb86-582" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb86-583"><a href="#cb86-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-584"><a href="#cb86-584" aria-hidden="true" tabindex="-1"></a>Here is an R function that will calculate E-values</span>
<span id="cb86-585"><a href="#cb86-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-588"><a href="#cb86-588" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-589"><a href="#cb86-589" aria-hidden="true" tabindex="-1"></a>calculate_e_value <span class="ot">&lt;-</span> <span class="cf">function</span>(rr, lcl) {</span>
<span id="cb86-590"><a href="#cb86-590" aria-hidden="true" tabindex="-1"></a>  e_value_rr <span class="ot">=</span> rr <span class="sc">+</span> <span class="fu">sqrt</span>(rr<span class="sc">*</span>(rr <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb86-591"><a href="#cb86-591" aria-hidden="true" tabindex="-1"></a>  e_value_lcl <span class="ot">=</span> lcl <span class="sc">+</span> <span class="fu">sqrt</span>(lcl<span class="sc">*</span>(lcl <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb86-592"><a href="#cb86-592" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-593"><a href="#cb86-593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">e_value_rr =</span> e_value_rr, <span class="at">e_value_lcl =</span> e_value_lcl)</span>
<span id="cb86-594"><a href="#cb86-594" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-595"><a href="#cb86-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-596"><a href="#cb86-596" aria-hidden="true" tabindex="-1"></a><span class="co"># e.g. smoking causes cancer</span></span>
<span id="cb86-597"><a href="#cb86-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-598"><a href="#cb86-598" aria-hidden="true" tabindex="-1"></a><span class="co"># finding   RR = 10.73 (95% CI: 8.02, 14.36)</span></span>
<span id="cb86-599"><a href="#cb86-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-600"><a href="#cb86-600" aria-hidden="true" tabindex="-1"></a><span class="fu">calculate_e_value</span>(<span class="fl">10.73</span>, <span class="fl">8.02</span>)</span>
<span id="cb86-601"><a href="#cb86-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-602"><a href="#cb86-602" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-603"><a href="#cb86-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-604"><a href="#cb86-604" aria-hidden="true" tabindex="-1"></a>We write:</span>
<span id="cb86-605"><a href="#cb86-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-606"><a href="#cb86-606" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; With an observed risk ratio of RR=10.7, an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of 20.9-fold each, above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of 15.5-fold each could do so, but weaker joint confounder associations could not.</span></span>
<span id="cb86-607"><a href="#cb86-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-608"><a href="#cb86-608" aria-hidden="true" tabindex="-1"></a>Note that in this class, most of the outcomes will be (standardised) continuous outcomes. Here's a function and LaTeX code to describe the approximation.</span>
<span id="cb86-609"><a href="#cb86-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-610"><a href="#cb86-610" aria-hidden="true" tabindex="-1"></a>This function takes a linear regression coefficient estimate (<span class="in">`est`</span>), its standard error (<span class="in">`se`</span>), the standard deviation of the outcome (<span class="in">`sd`</span>), a contrast of interest in the exposure (<span class="in">`delta`</span>, which defaults to 1), and a "true" standardized mean difference (true, which defaults to 0). It calculates the odds ratio using the formula from Chinn (2000) and VanderWeele (2017), and then uses this to calculate the E-value.</span>
<span id="cb86-611"><a href="#cb86-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-614"><a href="#cb86-614" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-615"><a href="#cb86-615" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: evalue_ols</span></span>
<span id="cb86-616"><a href="#cb86-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-617"><a href="#cb86-617" aria-hidden="true" tabindex="-1"></a>compute_evalue_ols <span class="ot">&lt;-</span> <span class="cf">function</span>(est, se, <span class="at">delta =</span> <span class="dv">1</span>, <span class="at">true =</span> <span class="dv">0</span>) {</span>
<span id="cb86-618"><a href="#cb86-618" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rescale estimate and SE to reflect a contrast of size delta</span></span>
<span id="cb86-619"><a href="#cb86-619" aria-hidden="true" tabindex="-1"></a>  est <span class="ot">&lt;-</span> est <span class="sc">/</span> delta</span>
<span id="cb86-620"><a href="#cb86-620" aria-hidden="true" tabindex="-1"></a>  se <span class="ot">&lt;-</span> se <span class="sc">/</span> delta</span>
<span id="cb86-621"><a href="#cb86-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-622"><a href="#cb86-622" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute transformed odds ratio and confidence intervals</span></span>
<span id="cb86-623"><a href="#cb86-623" aria-hidden="true" tabindex="-1"></a>  odds_ratio <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fl">0.91</span> <span class="sc">*</span> est)</span>
<span id="cb86-624"><a href="#cb86-624" aria-hidden="true" tabindex="-1"></a>  lo <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fl">0.91</span> <span class="sc">*</span> est <span class="sc">-</span> <span class="fl">1.78</span> <span class="sc">*</span> se)</span>
<span id="cb86-625"><a href="#cb86-625" aria-hidden="true" tabindex="-1"></a>  hi <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fl">0.91</span> <span class="sc">*</span> est <span class="sc">+</span> <span class="fl">1.78</span> <span class="sc">*</span> se)</span>
<span id="cb86-626"><a href="#cb86-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-627"><a href="#cb86-627" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute E-Values based on the RR values</span></span>
<span id="cb86-628"><a href="#cb86-628" aria-hidden="true" tabindex="-1"></a>  evalue_point_estimate <span class="ot">&lt;-</span> odds_ratio <span class="sc">*</span> <span class="fu">sqrt</span>(odds_ratio <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb86-629"><a href="#cb86-629" aria-hidden="true" tabindex="-1"></a>  evalue_lower_ci <span class="ot">&lt;-</span> lo <span class="sc">*</span> <span class="fu">sqrt</span>(lo <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb86-630"><a href="#cb86-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-631"><a href="#cb86-631" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return the E-values</span></span>
<span id="cb86-632"><a href="#cb86-632" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">EValue_PointEstimate =</span> evalue_point_estimate,</span>
<span id="cb86-633"><a href="#cb86-633" aria-hidden="true" tabindex="-1"></a>              <span class="at">EValue_LowerCI =</span> evalue_lower_ci))</span>
<span id="cb86-634"><a href="#cb86-634" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-635"><a href="#cb86-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-636"><a href="#cb86-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-637"><a href="#cb86-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-638"><a href="#cb86-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-639"><a href="#cb86-639" aria-hidden="true" tabindex="-1"></a><span class="co"># exampl:</span></span>
<span id="cb86-640"><a href="#cb86-640" aria-hidden="true" tabindex="-1"></a><span class="co"># suppose we have an estimate of 0.5, a standard error of 0.1, and a standard deviation of 1.</span></span>
<span id="cb86-641"><a href="#cb86-641" aria-hidden="true" tabindex="-1"></a><span class="co"># This would correspond to a half a standard deviation increase in the outcome per unit increase in the exposure.</span></span>
<span id="cb86-642"><a href="#cb86-642" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">compute_evalue_ols</span>(<span class="at">est =</span> <span class="fl">0.5</span>, <span class="at">se =</span> <span class="fl">0.1</span>, <span class="at">delta =</span> <span class="dv">1</span>)</span>
<span id="cb86-643"><a href="#cb86-643" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(results)</span>
<span id="cb86-644"><a href="#cb86-644" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-645"><a href="#cb86-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-646"><a href="#cb86-646" aria-hidden="true" tabindex="-1"></a>We write:</span>
<span id="cb86-647"><a href="#cb86-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-648"><a href="#cb86-648" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; With an observed risk ratio of RR=2.92, an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of 2.92-fold each, above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of 2.23-fold each could do so, but weaker joint confounder associations could not.</span></span>
<span id="cb86-649"><a href="#cb86-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-650"><a href="#cb86-650" aria-hidden="true" tabindex="-1"></a>Note the E-values package will do the computational work for us (note we get slightly different estimates)</span>
<span id="cb86-651"><a href="#cb86-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-652"><a href="#cb86-652" aria-hidden="true" tabindex="-1"></a>Note:</span>
<span id="cb86-653"><a href="#cb86-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-654"><a href="#cb86-654" aria-hidden="true" tabindex="-1"></a>First, the fucntion converts the estimate to an odds ratio:</span>
<span id="cb86-655"><a href="#cb86-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-656"><a href="#cb86-656" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Odds Ratio Conversion**:</span>
<span id="cb86-657"><a href="#cb86-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-658"><a href="#cb86-658" aria-hidden="true" tabindex="-1"></a>    (OddsRatio = e\^{\frac{Estimate}{SD} \cdot \sqrt{\frac{3}{\pi}}})</span>
<span id="cb86-659"><a href="#cb86-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-660"><a href="#cb86-660" aria-hidden="true" tabindex="-1"></a>Then, it calculates the confidence intervals for the odds ratio:</span>
<span id="cb86-661"><a href="#cb86-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-662"><a href="#cb86-662" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Confidence Intervals**:</span>
<span id="cb86-663"><a href="#cb86-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-664"><a href="#cb86-664" aria-hidden="true" tabindex="-1"></a>    (LowerConfidenceInterval = e\^{log(OddsRatio) - 1.78 \cdot SE})</span>
<span id="cb86-665"><a href="#cb86-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-666"><a href="#cb86-666" aria-hidden="true" tabindex="-1"></a>    (UpperConfidenceInterval = e\^{log(OddsRatio) + 1.78 \cdot SE})</span>
<span id="cb86-667"><a href="#cb86-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-668"><a href="#cb86-668" aria-hidden="true" tabindex="-1"></a>Finally, it calculates the E-value for the point estimate and the lower confidence interval:</span>
<span id="cb86-669"><a href="#cb86-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-670"><a href="#cb86-670" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**E-Values Calculation**:</span>
<span id="cb86-671"><a href="#cb86-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-672"><a href="#cb86-672" aria-hidden="true" tabindex="-1"></a>    (EValue<span class="sc">\_</span>{PointEstimate} = OddsRatio + \sqrt{OddsRatio^2 - 1})</span>
<span id="cb86-673"><a href="#cb86-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-674"><a href="#cb86-674" aria-hidden="true" tabindex="-1"></a>    (EValue<span class="sc">\_</span>{LowerCI} = LowerConfidenceInterval + \sqrt{LowerConfidenceInterval^2 - 1})</span>
<span id="cb86-675"><a href="#cb86-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-676"><a href="#cb86-676" aria-hidden="true" tabindex="-1"></a><span class="sc">\[\[</span>JB: NEED TO CHECK<span class="sc">\]\]</span></span>
<span id="cb86-677"><a href="#cb86-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-678"><a href="#cb86-678" aria-hidden="true" tabindex="-1"></a>Generally, best to use the EValue function.</span>
<span id="cb86-679"><a href="#cb86-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-682"><a href="#cb86-682" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-683"><a href="#cb86-683" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: evalue-package</span></span>
<span id="cb86-684"><a href="#cb86-684" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(EValue)</span>
<span id="cb86-685"><a href="#cb86-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-686"><a href="#cb86-686" aria-hidden="true" tabindex="-1"></a>EValue<span class="sc">::</span><span class="fu">evalues.OLS</span>(<span class="at">est =</span> <span class="fl">0.5</span>, <span class="at">se =</span> <span class="fl">0.1</span>, <span class="at">sd =</span> <span class="dv">1</span>, <span class="at">delta =</span> <span class="dv">1</span>, <span class="at">true =</span> <span class="dv">0</span>)</span>
<span id="cb86-687"><a href="#cb86-687" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-688"><a href="#cb86-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-691"><a href="#cb86-691" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-692"><a href="#cb86-692" aria-hidden="true" tabindex="-1"></a><span class="co">#| table: wide_data</span></span>
<span id="cb86-693"><a href="#cb86-693" aria-hidden="true" tabindex="-1"></a><span class="do">############## ############## ############## ############## ############## ############## ############## ########</span></span>
<span id="cb86-694"><a href="#cb86-694" aria-hidden="true" tabindex="-1"></a><span class="do">####  ####  ####  CREATE DATA FRAME FOR ANALYSIS ####  ####  ################## ############## ######## #########</span></span>
<span id="cb86-695"><a href="#cb86-695" aria-hidden="true" tabindex="-1"></a><span class="do">############## ############## ############## ############## ############## ############## ############# #########</span></span>
<span id="cb86-696"><a href="#cb86-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-697"><a href="#cb86-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-698"><a href="#cb86-698" aria-hidden="true" tabindex="-1"></a><span class="co"># I have created a function that will put the data into the correct shape. Here are the steps.</span></span>
<span id="cb86-699"><a href="#cb86-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-700"><a href="#cb86-700" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: choose baseline variables (confounders).  here we select standard demographic variablees plus personality variables.</span></span>
<span id="cb86-701"><a href="#cb86-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-702"><a href="#cb86-702" aria-hidden="true" tabindex="-1"></a><span class="co"># Note again that the function will automatically include the baseline exposure and basline outcome in the baseline variable confounder set so you don't need to include these. </span></span>
<span id="cb86-703"><a href="#cb86-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-704"><a href="#cb86-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-705"><a href="#cb86-705" aria-hidden="true" tabindex="-1"></a><span class="co"># here are some plausible baseline confounders</span></span>
<span id="cb86-706"><a href="#cb86-706" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb86-707"><a href="#cb86-707" aria-hidden="true" tabindex="-1"></a>  <span class="st">"edu"</span>,</span>
<span id="cb86-708"><a href="#cb86-708" aria-hidden="true" tabindex="-1"></a>  <span class="st">"male"</span>,</span>
<span id="cb86-709"><a href="#cb86-709" aria-hidden="true" tabindex="-1"></a>  <span class="st">"eth_cat"</span>,</span>
<span id="cb86-710"><a href="#cb86-710" aria-hidden="true" tabindex="-1"></a>  <span class="st">"employed"</span>,</span>
<span id="cb86-711"><a href="#cb86-711" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gen_cohort"</span>,</span>
<span id="cb86-712"><a href="#cb86-712" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nz_dep2018"</span>, <span class="co"># nz dep</span></span>
<span id="cb86-713"><a href="#cb86-713" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nzsei13"</span>, <span class="co"># occupational prestige</span></span>
<span id="cb86-714"><a href="#cb86-714" aria-hidden="true" tabindex="-1"></a>  <span class="st">"partner"</span>,</span>
<span id="cb86-715"><a href="#cb86-715" aria-hidden="true" tabindex="-1"></a>  <span class="st">"parent"</span>,</span>
<span id="cb86-716"><a href="#cb86-716" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pol_orient"</span>,</span>
<span id="cb86-717"><a href="#cb86-717" aria-hidden="true" tabindex="-1"></a> <span class="co"># "rural_gch2018",</span></span>
<span id="cb86-718"><a href="#cb86-718" aria-hidden="true" tabindex="-1"></a>   <span class="st">"urban"</span>, <span class="co"># use the two level urban varaible. </span></span>
<span id="cb86-719"><a href="#cb86-719" aria-hidden="true" tabindex="-1"></a>  <span class="st">"agreeableness"</span>,</span>
<span id="cb86-720"><a href="#cb86-720" aria-hidden="true" tabindex="-1"></a>  <span class="st">"conscientiousness"</span>,</span>
<span id="cb86-721"><a href="#cb86-721" aria-hidden="true" tabindex="-1"></a>  <span class="st">"extraversion"</span>,</span>
<span id="cb86-722"><a href="#cb86-722" aria-hidden="true" tabindex="-1"></a>  <span class="st">"honesty_humility"</span>,</span>
<span id="cb86-723"><a href="#cb86-723" aria-hidden="true" tabindex="-1"></a>  <span class="st">"openness"</span>,</span>
<span id="cb86-724"><a href="#cb86-724" aria-hidden="true" tabindex="-1"></a>  <span class="st">"neuroticism"</span>,</span>
<span id="cb86-725"><a href="#cb86-725" aria-hidden="true" tabindex="-1"></a>  <span class="st">"modesty"</span>,</span>
<span id="cb86-726"><a href="#cb86-726" aria-hidden="true" tabindex="-1"></a>  <span class="st">"religion_identification_level"</span></span>
<span id="cb86-727"><a href="#cb86-727" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-728"><a href="#cb86-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-729"><a href="#cb86-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-730"><a href="#cb86-730" aria-hidden="true" tabindex="-1"></a><span class="do">## Step 2, select the exposure variable.  This is the "cause"</span></span>
<span id="cb86-731"><a href="#cb86-731" aria-hidden="true" tabindex="-1"></a>exposure_var <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"hours_exercise_coarsen"</span>)</span>
<span id="cb86-732"><a href="#cb86-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-733"><a href="#cb86-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-734"><a href="#cb86-734" aria-hidden="true" tabindex="-1"></a><span class="do">## step 3. select the outcome variable.  These are the outcomes.</span></span>
<span id="cb86-735"><a href="#cb86-735" aria-hidden="true" tabindex="-1"></a>outcome_vars_reflective <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"kessler_latent_anxiety"</span>,</span>
<span id="cb86-736"><a href="#cb86-736" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"kessler_latent_depression"</span>)</span>
<span id="cb86-737"><a href="#cb86-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-738"><a href="#cb86-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-739"><a href="#cb86-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-740"><a href="#cb86-740" aria-hidden="true" tabindex="-1"></a><span class="co"># the function "create_wide_data" should be in your environment.</span></span>
<span id="cb86-741"><a href="#cb86-741" aria-hidden="true" tabindex="-1"></a><span class="co"># If not, make sure to run the first line of code in this script once more.  You may ignore the warnings. or uncomment and run the code below</span></span>
<span id="cb86-742"><a href="#cb86-742" aria-hidden="true" tabindex="-1"></a><span class="co"># source("https://raw.githubusercontent.com/go-bayes/templates/main/functions/funs.R")</span></span>
<span id="cb86-743"><a href="#cb86-743" aria-hidden="true" tabindex="-1"></a>dt_prepare <span class="ot">&lt;-</span></span>
<span id="cb86-744"><a href="#cb86-744" aria-hidden="true" tabindex="-1"></a>  <span class="fu">create_wide_data</span>(</span>
<span id="cb86-745"><a href="#cb86-745" aria-hidden="true" tabindex="-1"></a>    <span class="at">dat_long =</span> dt_start2,</span>
<span id="cb86-746"><a href="#cb86-746" aria-hidden="true" tabindex="-1"></a>    <span class="at">baseline_vars =</span> baseline_vars,</span>
<span id="cb86-747"><a href="#cb86-747" aria-hidden="true" tabindex="-1"></a>    <span class="at">exposure_var =</span> exposure_var,</span>
<span id="cb86-748"><a href="#cb86-748" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome_vars =</span> outcome_vars_reflective</span>
<span id="cb86-749"><a href="#cb86-749" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-750"><a href="#cb86-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-751"><a href="#cb86-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-752"><a href="#cb86-752" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-753"><a href="#cb86-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-754"><a href="#cb86-754" aria-hidden="true" tabindex="-1"></a><span class="fu">## Descriptive table</span></span>
<span id="cb86-755"><a href="#cb86-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-758"><a href="#cb86-758" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-759"><a href="#cb86-759" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: simple_table</span></span>
<span id="cb86-760"><a href="#cb86-760" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb86-761"><a href="#cb86-761" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb86-762"><a href="#cb86-762" aria-hidden="true" tabindex="-1"></a><span class="co"># I have created a function that will allow you to take a data frame and</span></span>
<span id="cb86-763"><a href="#cb86-763" aria-hidden="true" tabindex="-1"></a><span class="co"># create a table</span></span>
<span id="cb86-764"><a href="#cb86-764" aria-hidden="true" tabindex="-1"></a><span class="fu">baseline_table</span>(dt_prepare, <span class="at">output_format =</span> <span class="st">"markdown"</span>)</span>
<span id="cb86-765"><a href="#cb86-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-766"><a href="#cb86-766" aria-hidden="true" tabindex="-1"></a><span class="co"># but it is not very nice. Next up, is a better table</span></span>
<span id="cb86-767"><a href="#cb86-767" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-768"><a href="#cb86-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-771"><a href="#cb86-771" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-772"><a href="#cb86-772" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: table_better</span></span>
<span id="cb86-773"><a href="#cb86-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-774"><a href="#cb86-774" aria-hidden="true" tabindex="-1"></a><span class="co"># get data into shape</span></span>
<span id="cb86-775"><a href="#cb86-775" aria-hidden="true" tabindex="-1"></a>dt_new <span class="ot">&lt;-</span> dt_prepare <span class="sc">%&gt;%</span></span>
<span id="cb86-776"><a href="#cb86-776" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"t0"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb86-777"><a href="#cb86-777" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_all</span>( <span class="sc">~</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(., <span class="st">"^t0_"</span>, <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb86-778"><a href="#cb86-778" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">wave =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="st">"baseline"</span>, <span class="fu">nrow</span>(dt_prepare)))) <span class="sc">|&gt;</span></span>
<span id="cb86-779"><a href="#cb86-779" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>(<span class="at">case =</span> <span class="st">"screaming_snake"</span>)</span>
<span id="cb86-780"><a href="#cb86-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-781"><a href="#cb86-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-782"><a href="#cb86-782" aria-hidden="true" tabindex="-1"></a><span class="co"># create a formula string</span></span>
<span id="cb86-783"><a href="#cb86-783" aria-hidden="true" tabindex="-1"></a>baseline_vars_names <span class="ot">&lt;-</span> dt_new <span class="sc">%&gt;%</span></span>
<span id="cb86-784"><a href="#cb86-784" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>WAVE) <span class="sc">%&gt;%</span></span>
<span id="cb86-785"><a href="#cb86-785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>()</span>
<span id="cb86-786"><a href="#cb86-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-787"><a href="#cb86-787" aria-hidden="true" tabindex="-1"></a>table_baseline_vars <span class="ot">&lt;-</span></span>
<span id="cb86-788"><a href="#cb86-788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(baseline_vars_names, <span class="at">collapse =</span> <span class="st">"+"</span>)</span>
<span id="cb86-789"><a href="#cb86-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-790"><a href="#cb86-790" aria-hidden="true" tabindex="-1"></a>formula_string_table_baseline <span class="ot">&lt;-</span></span>
<span id="cb86-791"><a href="#cb86-791" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="st">"~"</span>, table_baseline_vars, <span class="st">"|WAVE"</span>)</span>
<span id="cb86-792"><a href="#cb86-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-793"><a href="#cb86-793" aria-hidden="true" tabindex="-1"></a>table1<span class="sc">::</span><span class="fu">table1</span>(<span class="fu">as.formula</span>(formula_string_table_baseline),</span>
<span id="cb86-794"><a href="#cb86-794" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> dt_new,</span>
<span id="cb86-795"><a href="#cb86-795" aria-hidden="true" tabindex="-1"></a>               <span class="at">overall =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-796"><a href="#cb86-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-797"><a href="#cb86-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-798"><a href="#cb86-798" aria-hidden="true" tabindex="-1"></a><span class="co"># another method for making a table</span></span>
<span id="cb86-799"><a href="#cb86-799" aria-hidden="true" tabindex="-1"></a><span class="co"># x &lt;- table1::table1(as.formula(formula_string_table_baseline),</span></span>
<span id="cb86-800"><a href="#cb86-800" aria-hidden="true" tabindex="-1"></a><span class="co">#                     data = dt_new,</span></span>
<span id="cb86-801"><a href="#cb86-801" aria-hidden="true" tabindex="-1"></a><span class="co">#                     overall = FALSE)</span></span>
<span id="cb86-802"><a href="#cb86-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-803"><a href="#cb86-803" aria-hidden="true" tabindex="-1"></a><span class="co"># # some options, see: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html</span></span>
<span id="cb86-804"><a href="#cb86-804" aria-hidden="true" tabindex="-1"></a><span class="co"># table1::t1kable(x, format = "html", booktabs = TRUE) |&gt;</span></span>
<span id="cb86-805"><a href="#cb86-805" aria-hidden="true" tabindex="-1"></a><span class="co">#   kable_material(c("striped", "hover"))</span></span>
<span id="cb86-806"><a href="#cb86-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-807"><a href="#cb86-807" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-808"><a href="#cb86-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-809"><a href="#cb86-809" aria-hidden="true" tabindex="-1"></a>We need to do some more data wrangling, alas! Data wrangling is the majority of data analysis. The good news is that R makes wrangling relatively straightforward.</span>
<span id="cb86-810"><a href="#cb86-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-811"><a href="#cb86-811" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span><span class="in">`mutate(id = factor(1:nrow(dt_prepare)))`</span>: This creates a new column called <span class="in">`id`</span> that has unique identification factors for each row in the dataset. It ranges from 1 to the number of rows in the dataset.</span>
<span id="cb86-812"><a href="#cb86-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-813"><a href="#cb86-813" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>The next <span class="in">`mutate`</span> operation is used to convert the <span class="in">`t0_eth_cat`</span>, <span class="in">`t0_urban`</span>, and <span class="in">`t0_gen_cohort`</span> variables to factor type, if they are not already.</span>
<span id="cb86-814"><a href="#cb86-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-815"><a href="#cb86-815" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>The <span class="in">`filter`</span> command is used to subset the dataset to only include rows where the <span class="in">`t0_eth_cat`</span> is either "euro" or "māori". The original dataset includes data with four different ethnic categories. This command filters out any row not related to these two groups.</span>
<span id="cb86-816"><a href="#cb86-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-817"><a href="#cb86-817" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span><span class="in">`ungroup()`</span> ensures that there's no grouping in the dataframe.</span>
<span id="cb86-818"><a href="#cb86-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-819"><a href="#cb86-819" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>The <span class="in">`mutate(across(where(is.numeric), ~ scale(.x), .names = "{col}_z"))`</span> step standardizes all numeric columns in the dataset by subtracting the mean and dividing by the standard deviation (a z-score transformation). The resulting columns are renamed to include "<span class="sc">\_</span>z" at the end of their original names.</span>
<span id="cb86-820"><a href="#cb86-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-821"><a href="#cb86-821" aria-hidden="true" tabindex="-1"></a><span class="ss">6.  </span>The <span class="in">`select`</span> function is used to keep only specific columns: the <span class="in">`id`</span> column, any columns that are factors, and any columns that end in "<span class="sc">\_</span>z".</span>
<span id="cb86-822"><a href="#cb86-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-823"><a href="#cb86-823" aria-hidden="true" tabindex="-1"></a><span class="ss">7.  </span>The <span class="in">`relocate`</span> functions re-order columns. The first <span class="in">`relocate`</span> places the <span class="in">`id`</span> column at the beginning. The next three <span class="in">`relocate`</span> functions order the rest of the columns based on their names: those starting with "t0<span class="sc">\_</span>" are placed before "t1<span class="sc">\_</span>" columns, and those starting with "t2<span class="sc">\_</span>" are placed after "t1<span class="sc">\_</span>" columns.</span>
<span id="cb86-824"><a href="#cb86-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-825"><a href="#cb86-825" aria-hidden="true" tabindex="-1"></a><span class="ss">8.  </span><span class="in">`droplevels()`</span> removes unused factor levels in the dataframe.</span>
<span id="cb86-826"><a href="#cb86-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-827"><a href="#cb86-827" aria-hidden="true" tabindex="-1"></a><span class="ss">9.  </span>Finally, <span class="in">`skimr::skim(dt)`</span> will print out a summary of the data in the <span class="in">`dt`</span> object using the skimr package. This provides a useful overview of the data, including data types and summary statistics.</span>
<span id="cb86-828"><a href="#cb86-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-829"><a href="#cb86-829" aria-hidden="true" tabindex="-1"></a>This function seems to be part of a data preparation pipeline in a longitudinal or panel analysis, where observations are ordered over time (indicated by t0<span class="sc">\_</span>, t1<span class="sc">\_</span>, t2<span class="sc">\_</span>, etc.).</span>
<span id="cb86-830"><a href="#cb86-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-833"><a href="#cb86-833" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-834"><a href="#cb86-834" aria-hidden="true" tabindex="-1"></a><span class="do">### </span><span class="al">###</span><span class="do"> </span><span class="al">###</span><span class="do"> </span><span class="al">###</span><span class="do"> </span><span class="al">###</span><span class="do"> </span><span class="al">###</span><span class="do"> SUBGROUP DATA ANALYSIS: DATA WRANGLING  </span><span class="al">###</span><span class="do"> </span><span class="al">###</span><span class="do"> </span><span class="al">###</span><span class="do"> </span><span class="al">###</span></span>
<span id="cb86-835"><a href="#cb86-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-836"><a href="#cb86-836" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> dt_prepare<span class="sc">|&gt;</span></span>
<span id="cb86-837"><a href="#cb86-837" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">factor</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(dt_prepare))) <span class="sc">|&gt;</span></span>
<span id="cb86-838"><a href="#cb86-838" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb86-839"><a href="#cb86-839" aria-hidden="true" tabindex="-1"></a>  <span class="at">t0_eth_cat =</span> <span class="fu">as.factor</span>(t0_eth_cat),</span>
<span id="cb86-840"><a href="#cb86-840" aria-hidden="true" tabindex="-1"></a>  <span class="at">t0_urban =</span> <span class="fu">as.factor</span>(t0_urban),</span>
<span id="cb86-841"><a href="#cb86-841" aria-hidden="true" tabindex="-1"></a>  <span class="at">t0_gen_cohort =</span> <span class="fu">as.factor</span>(t0_gen_cohort)</span>
<span id="cb86-842"><a href="#cb86-842" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb86-843"><a href="#cb86-843" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(t0_eth_cat <span class="sc">==</span> <span class="st">"euro"</span> <span class="sc">|</span></span>
<span id="cb86-844"><a href="#cb86-844" aria-hidden="true" tabindex="-1"></a>                t0_eth_cat <span class="sc">==</span> <span class="st">"māori"</span>) <span class="sc">|&gt;</span> <span class="co"># Too few asian and pacific</span></span>
<span id="cb86-845"><a href="#cb86-845" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb86-846"><a href="#cb86-846" aria-hidden="true" tabindex="-1"></a>  <span class="co"># transform numeric variables into z scores (improves estimation)</span></span>
<span id="cb86-847"><a href="#cb86-847" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">scale</span>(.x), <span class="at">.names =</span> <span class="st">"{col}_z"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb86-848"><a href="#cb86-848" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select only factors and numeric values that are z-scores</span></span>
<span id="cb86-849"><a href="#cb86-849" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, <span class="co"># category is too sparse</span></span>
<span id="cb86-850"><a href="#cb86-850" aria-hidden="true" tabindex="-1"></a>         <span class="fu">where</span>(is.factor),</span>
<span id="cb86-851"><a href="#cb86-851" aria-hidden="true" tabindex="-1"></a>         <span class="fu">ends_with</span>(<span class="st">"_z"</span>), ) <span class="sc">|&gt;</span></span>
<span id="cb86-852"><a href="#cb86-852" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tidy data frame so that the columns are ordered by time (useful for more complex models)</span></span>
<span id="cb86-853"><a href="#cb86-853" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(id, <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>))   <span class="sc">|&gt;</span></span>
<span id="cb86-854"><a href="#cb86-854" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"t0_"</span>), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>))  <span class="sc">|&gt;</span></span>
<span id="cb86-855"><a href="#cb86-855" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"t2_"</span>), <span class="at">.after =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb86-856"><a href="#cb86-856" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb86-857"><a href="#cb86-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-858"><a href="#cb86-858" aria-hidden="true" tabindex="-1"></a><span class="co"># view object</span></span>
<span id="cb86-859"><a href="#cb86-859" aria-hidden="true" tabindex="-1"></a>skimr<span class="sc">::</span><span class="fu">skim</span>(dt)</span>
<span id="cb86-860"><a href="#cb86-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-861"><a href="#cb86-861" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-862"><a href="#cb86-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-865"><a href="#cb86-865" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-866"><a href="#cb86-866" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: more-data-checks</span></span>
<span id="cb86-867"><a href="#cb86-867" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb86-868"><a href="#cb86-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-869"><a href="#cb86-869" aria-hidden="true" tabindex="-1"></a><span class="co"># quick cross table</span></span>
<span id="cb86-870"><a href="#cb86-870" aria-hidden="true" tabindex="-1"></a><span class="co">#table( dt$t1_hours_exercise_coarsen, dt$t0_eth_cat )</span></span>
<span id="cb86-871"><a href="#cb86-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-872"><a href="#cb86-872" aria-hidden="true" tabindex="-1"></a><span class="co"># checks</span></span>
<span id="cb86-873"><a href="#cb86-873" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dt<span class="sc">$</span>t2_kessler_latent_depression_z)</span>
<span id="cb86-874"><a href="#cb86-874" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(dt<span class="sc">$</span>t2_kessler_latent_anxiety_z)</span>
<span id="cb86-875"><a href="#cb86-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-876"><a href="#cb86-876" aria-hidden="true" tabindex="-1"></a>dt <span class="sc">|&gt;</span></span>
<span id="cb86-877"><a href="#cb86-877" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabyl</span>(t0_eth_cat, t1_hours_exercise_coarsen ) <span class="sc">|&gt;</span></span>
<span id="cb86-878"><a href="#cb86-878" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span>
<span id="cb86-879"><a href="#cb86-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-880"><a href="#cb86-880" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualise missingness</span></span>
<span id="cb86-881"><a href="#cb86-881" aria-hidden="true" tabindex="-1"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(dt)</span>
<span id="cb86-882"><a href="#cb86-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-883"><a href="#cb86-883" aria-hidden="true" tabindex="-1"></a><span class="co"># save your dataframe for future use</span></span>
<span id="cb86-884"><a href="#cb86-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-885"><a href="#cb86-885" aria-hidden="true" tabindex="-1"></a><span class="co"># make dataframe</span></span>
<span id="cb86-886"><a href="#cb86-886" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">as.data.frame</span>(dt)</span>
<span id="cb86-887"><a href="#cb86-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-888"><a href="#cb86-888" aria-hidden="true" tabindex="-1"></a><span class="co"># save data</span></span>
<span id="cb86-889"><a href="#cb86-889" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dt, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"dt"</span>))</span>
<span id="cb86-890"><a href="#cb86-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-891"><a href="#cb86-891" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-892"><a href="#cb86-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-893"><a href="#cb86-893" aria-hidden="true" tabindex="-1"></a><span class="fu">## Propensity scores</span></span>
<span id="cb86-894"><a href="#cb86-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-895"><a href="#cb86-895" aria-hidden="true" tabindex="-1"></a>Next we generate propensity scores. Instead of modelling the outcome (t2_y) we will model the exposure (t1_x) as predicted by baseline indicators (t0_c) that we assume may be associated with the outcome and the exposure.</span>
<span id="cb86-896"><a href="#cb86-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-897"><a href="#cb86-897" aria-hidden="true" tabindex="-1"></a>The first step is to obtain the baseline variables. note that we must remove "t0_eth_cat" because we are performing separate weighting for each stratum within this variable.</span>
<span id="cb86-898"><a href="#cb86-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-901"><a href="#cb86-901" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-902"><a href="#cb86-902" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: propensity_score prepare</span></span>
<span id="cb86-903"><a href="#cb86-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-904"><a href="#cb86-904" aria-hidden="true" tabindex="-1"></a><span class="co"># read  data -- you may start here if you need to repeat the analysis</span></span>
<span id="cb86-905"><a href="#cb86-905" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"dt"</span>))</span>
<span id="cb86-906"><a href="#cb86-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-907"><a href="#cb86-907" aria-hidden="true" tabindex="-1"></a><span class="co"># get column names</span></span>
<span id="cb86-908"><a href="#cb86-908" aria-hidden="true" tabindex="-1"></a>baseline_vars_reflective_propensity <span class="ot">&lt;-</span> dt<span class="sc">|&gt;</span></span>
<span id="cb86-909"><a href="#cb86-909" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"t0"</span>), <span class="sc">-</span>t0_eth_cat) <span class="sc">|&gt;</span> <span class="fu">colnames</span>()</span>
<span id="cb86-910"><a href="#cb86-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-911"><a href="#cb86-911" aria-hidden="true" tabindex="-1"></a><span class="co"># define our exposure</span></span>
<span id="cb86-912"><a href="#cb86-912" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="st">"t1_hours_exercise_coarsen"</span></span>
<span id="cb86-913"><a href="#cb86-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-914"><a href="#cb86-914" aria-hidden="true" tabindex="-1"></a><span class="co"># define subclasses</span></span>
<span id="cb86-915"><a href="#cb86-915" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="st">"t0_eth_cat"</span></span>
<span id="cb86-916"><a href="#cb86-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-917"><a href="#cb86-917" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure data is in a data frame format</span></span>
<span id="cb86-918"><a href="#cb86-918" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(dt)</span>
<span id="cb86-919"><a href="#cb86-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-920"><a href="#cb86-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-921"><a href="#cb86-921" aria-hidden="true" tabindex="-1"></a><span class="co"># next we use our trick for creating a formula string, which will reduce our work</span></span>
<span id="cb86-922"><a href="#cb86-922" aria-hidden="true" tabindex="-1"></a>formula_str_prop <span class="ot">&lt;-</span></span>
<span id="cb86-923"><a href="#cb86-923" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(X,</span>
<span id="cb86-924"><a href="#cb86-924" aria-hidden="true" tabindex="-1"></a>        <span class="st">"~"</span>,</span>
<span id="cb86-925"><a href="#cb86-925" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste</span>(baseline_vars_reflective_propensity, <span class="at">collapse =</span> <span class="st">"+"</span>))</span>
<span id="cb86-926"><a href="#cb86-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-927"><a href="#cb86-927" aria-hidden="true" tabindex="-1"></a><span class="co"># this shows the exposure variable as predicted by the baseline confounders.</span></span>
<span id="cb86-928"><a href="#cb86-928" aria-hidden="true" tabindex="-1"></a>formula_str_prop</span>
<span id="cb86-929"><a href="#cb86-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-930"><a href="#cb86-930" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-931"><a href="#cb86-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-932"><a href="#cb86-932" aria-hidden="true" tabindex="-1"></a>For propensity score analysis, we will try several different approaches. We will want to select the method that produces the best balance.</span>
<span id="cb86-933"><a href="#cb86-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-934"><a href="#cb86-934" aria-hidden="true" tabindex="-1"></a>I typically use <span class="in">`ps`</span> (classical propensity scores), <span class="in">`ebal`</span> and <span class="in">`energy`</span>. The latter two in my experience yeild good balance. Also <span class="in">`energy`</span> will work with *continuous* exposures.</span>
<span id="cb86-935"><a href="#cb86-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-936"><a href="#cb86-936" aria-hidden="true" tabindex="-1"></a>For more information, see <span class="ot">&lt;https://ngreifer.github.io/WeightIt/&gt;</span></span>
<span id="cb86-937"><a href="#cb86-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-940"><a href="#cb86-940" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-941"><a href="#cb86-941" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: propensity_scores</span></span>
<span id="cb86-942"><a href="#cb86-942" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb86-943"><a href="#cb86-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-944"><a href="#cb86-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-945"><a href="#cb86-945" aria-hidden="true" tabindex="-1"></a><span class="co"># traditional propensity scores-- note we select the ATT and we have a subgroup </span></span>
<span id="cb86-946"><a href="#cb86-946" aria-hidden="true" tabindex="-1"></a>dt_match_ps <span class="ot">&lt;-</span> <span class="fu">match_mi_general</span>(</span>
<span id="cb86-947"><a href="#cb86-947" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dt,</span>
<span id="cb86-948"><a href="#cb86-948" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb86-949"><a href="#cb86-949" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_vars =</span> baseline_vars_reflective_propensity,</span>
<span id="cb86-950"><a href="#cb86-950" aria-hidden="true" tabindex="-1"></a>  <span class="at">subgroup =</span> <span class="st">"t0_eth_cat"</span>,</span>
<span id="cb86-951"><a href="#cb86-951" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb86-952"><a href="#cb86-952" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"ps"</span></span>
<span id="cb86-953"><a href="#cb86-953" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-954"><a href="#cb86-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-955"><a href="#cb86-955" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dt_match_ps, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"dt_match_ps"</span>))</span>
<span id="cb86-956"><a href="#cb86-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-957"><a href="#cb86-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-958"><a href="#cb86-958" aria-hidden="true" tabindex="-1"></a><span class="co"># ebalance</span></span>
<span id="cb86-959"><a href="#cb86-959" aria-hidden="true" tabindex="-1"></a>dt_match_ebal <span class="ot">&lt;-</span> <span class="fu">match_mi_general</span>(</span>
<span id="cb86-960"><a href="#cb86-960" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dt,</span>
<span id="cb86-961"><a href="#cb86-961" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb86-962"><a href="#cb86-962" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_vars =</span> baseline_vars_reflective_propensity,</span>
<span id="cb86-963"><a href="#cb86-963" aria-hidden="true" tabindex="-1"></a>  <span class="at">subgroup =</span> <span class="st">"t0_eth_cat"</span>,</span>
<span id="cb86-964"><a href="#cb86-964" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb86-965"><a href="#cb86-965" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"ebal"</span></span>
<span id="cb86-966"><a href="#cb86-966" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-967"><a href="#cb86-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-968"><a href="#cb86-968" aria-hidden="true" tabindex="-1"></a><span class="co"># save output</span></span>
<span id="cb86-969"><a href="#cb86-969" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dt_match_ebal, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"dt_match_ebal"</span>))</span>
<span id="cb86-970"><a href="#cb86-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-971"><a href="#cb86-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-972"><a href="#cb86-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-973"><a href="#cb86-973" aria-hidden="true" tabindex="-1"></a><span class="do">## energy balance method</span></span>
<span id="cb86-974"><a href="#cb86-974" aria-hidden="true" tabindex="-1"></a>dt_match_energy <span class="ot">&lt;-</span> <span class="fu">match_mi_general</span>(</span>
<span id="cb86-975"><a href="#cb86-975" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dt,</span>
<span id="cb86-976"><a href="#cb86-976" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb86-977"><a href="#cb86-977" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_vars =</span> baseline_vars_reflective_propensity,</span>
<span id="cb86-978"><a href="#cb86-978" aria-hidden="true" tabindex="-1"></a>  <span class="at">subgroup =</span> <span class="st">"t0_eth_cat"</span>,</span>
<span id="cb86-979"><a href="#cb86-979" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb86-980"><a href="#cb86-980" aria-hidden="true" tabindex="-1"></a>  <span class="co">#focal = "high", # for use with ATT</span></span>
<span id="cb86-981"><a href="#cb86-981" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"energy"</span></span>
<span id="cb86-982"><a href="#cb86-982" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-983"><a href="#cb86-983" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dt_match_energy, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"dt_match_energy"</span>))</span>
<span id="cb86-984"><a href="#cb86-984" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-985"><a href="#cb86-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-986"><a href="#cb86-986" aria-hidden="true" tabindex="-1"></a>Results, first for Europeans</span>
<span id="cb86-987"><a href="#cb86-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-990"><a href="#cb86-990" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-991"><a href="#cb86-991" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: results_ps_analysis</span></span>
<span id="cb86-992"><a href="#cb86-992" aria-hidden="true" tabindex="-1"></a><span class="co">#| </span></span>
<span id="cb86-993"><a href="#cb86-993" aria-hidden="true" tabindex="-1"></a><span class="co">#dt_match_energy &lt;- readRDS(here::here("data", "dt_match_energy"))</span></span>
<span id="cb86-994"><a href="#cb86-994" aria-hidden="true" tabindex="-1"></a>dt_match_ebal <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"dt_match_ebal"</span>))</span>
<span id="cb86-995"><a href="#cb86-995" aria-hidden="true" tabindex="-1"></a><span class="co">#dt_match_ps &lt;- readRDS(here::here("data", "dt_match_ps"))</span></span>
<span id="cb86-996"><a href="#cb86-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-997"><a href="#cb86-997" aria-hidden="true" tabindex="-1"></a><span class="co"># next we inspect balance. "Max.Diff.Adj" should ideally be less than .05, but less than .1 is ok. This is the standardised mean difference. The variance ratio should be less than 2. </span></span>
<span id="cb86-998"><a href="#cb86-998" aria-hidden="true" tabindex="-1"></a><span class="co"># note that if the variables are unlikely to influence the outcome we can be less strict. </span></span>
<span id="cb86-999"><a href="#cb86-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1000"><a href="#cb86-1000" aria-hidden="true" tabindex="-1"></a><span class="co">#See: Hainmueller, J. 2012. “Entropy Balancing for Causal Effects: A Multivariate Reweighting Method to Produce Balanced Samples in Observational Studies.” Political Analysis 20 (1): 25–46. https://doi.org/10.1093/pan/mpr025.</span></span>
<span id="cb86-1001"><a href="#cb86-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1002"><a href="#cb86-1002" aria-hidden="true" tabindex="-1"></a><span class="co"># Cole SR, Hernan MA. Constructing inverse probability weights for marginal structural models. American Journal of</span></span>
<span id="cb86-1003"><a href="#cb86-1003" aria-hidden="true" tabindex="-1"></a><span class="co"># Epidemiology 2008; 168(6):656–664.</span></span>
<span id="cb86-1004"><a href="#cb86-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1005"><a href="#cb86-1005" aria-hidden="true" tabindex="-1"></a><span class="co"># Moving towards best practice when using inverse probability of treatment weighting (IPTW) using the propensity score to estimate causal treatment effects in observational studies</span></span>
<span id="cb86-1006"><a href="#cb86-1006" aria-hidden="true" tabindex="-1"></a><span class="co"># Peter C. Austin, Elizabeth A. Stuart</span></span>
<span id="cb86-1007"><a href="#cb86-1007" aria-hidden="true" tabindex="-1"></a><span class="co"># https://onlinelibrary.wiley.com/doi/10.1002/sim.6607</span></span>
<span id="cb86-1008"><a href="#cb86-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1009"><a href="#cb86-1009" aria-hidden="true" tabindex="-1"></a><span class="co">#bal.tab(dt_match_energy$euro)   #  good</span></span>
<span id="cb86-1010"><a href="#cb86-1010" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(dt_match_ebal<span class="sc">$</span>euro)   <span class="co">#  best</span></span>
<span id="cb86-1011"><a href="#cb86-1011" aria-hidden="true" tabindex="-1"></a><span class="co">#bal.tab(dt_match_ps$euro)   #  not as good</span></span>
<span id="cb86-1012"><a href="#cb86-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1013"><a href="#cb86-1013" aria-hidden="true" tabindex="-1"></a><span class="co"># here we show only the best tab, but you should put all information into an appendix</span></span>
<span id="cb86-1014"><a href="#cb86-1014" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1015"><a href="#cb86-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1016"><a href="#cb86-1016" aria-hidden="true" tabindex="-1"></a>Results for Maori</span>
<span id="cb86-1017"><a href="#cb86-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1020"><a href="#cb86-1020" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1021"><a href="#cb86-1021" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: balance_tab_maori</span></span>
<span id="cb86-1022"><a href="#cb86-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1023"><a href="#cb86-1023" aria-hidden="true" tabindex="-1"></a><span class="co"># who only Ebal</span></span>
<span id="cb86-1024"><a href="#cb86-1024" aria-hidden="true" tabindex="-1"></a><span class="co">#bal.tab(dt_match_energy$māori)   #  good</span></span>
<span id="cb86-1025"><a href="#cb86-1025" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(dt_match_ebal<span class="sc">$</span>māori)   <span class="co">#  best</span></span>
<span id="cb86-1026"><a href="#cb86-1026" aria-hidden="true" tabindex="-1"></a><span class="co">#bal.tab(dt_match_ps$māori)   #  not good</span></span>
<span id="cb86-1027"><a href="#cb86-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1028"><a href="#cb86-1028" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1029"><a href="#cb86-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1032"><a href="#cb86-1032" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1033"><a href="#cb86-1033" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: love_plots</span></span>
<span id="cb86-1034"><a href="#cb86-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1035"><a href="#cb86-1035" aria-hidden="true" tabindex="-1"></a><span class="co"># code for summar</span></span>
<span id="cb86-1036"><a href="#cb86-1036" aria-hidden="true" tabindex="-1"></a>sum_e <span class="ot">&lt;-</span> <span class="fu">summary</span>(dt_match_ebal<span class="sc">$</span>euro)</span>
<span id="cb86-1037"><a href="#cb86-1037" aria-hidden="true" tabindex="-1"></a>sum_m <span class="ot">&lt;-</span> <span class="fu">summary</span>(dt_match_ebal<span class="sc">$</span>māori)</span>
<span id="cb86-1038"><a href="#cb86-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1039"><a href="#cb86-1039" aria-hidden="true" tabindex="-1"></a><span class="co"># summary euro</span></span>
<span id="cb86-1040"><a href="#cb86-1040" aria-hidden="true" tabindex="-1"></a>sum_e</span>
<span id="cb86-1041"><a href="#cb86-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1042"><a href="#cb86-1042" aria-hidden="true" tabindex="-1"></a><span class="co"># summary maori</span></span>
<span id="cb86-1043"><a href="#cb86-1043" aria-hidden="true" tabindex="-1"></a>sum_m</span>
<span id="cb86-1044"><a href="#cb86-1044" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1045"><a href="#cb86-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1048"><a href="#cb86-1048" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1049"><a href="#cb86-1049" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: love_plot_euro</span></span>
<span id="cb86-1050"><a href="#cb86-1050" aria-hidden="true" tabindex="-1"></a><span class="co">#| column: page-right</span></span>
<span id="cb86-1051"><a href="#cb86-1051" aria-hidden="true" tabindex="-1"></a>love_plot_e <span class="ot">&lt;-</span> <span class="fu">love.plot</span>(dt_match_ebal<span class="sc">$</span>euro,</span>
<span id="cb86-1052"><a href="#cb86-1052" aria-hidden="true" tabindex="-1"></a>          <span class="at">binary =</span> <span class="st">"std"</span>,</span>
<span id="cb86-1053"><a href="#cb86-1053" aria-hidden="true" tabindex="-1"></a>          <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> .<span class="dv">1</span>))<span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"NZ Euro Weighting: method e-balance"</span>)</span>
<span id="cb86-1054"><a href="#cb86-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1055"><a href="#cb86-1055" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb86-1056"><a href="#cb86-1056" aria-hidden="true" tabindex="-1"></a>love_plot_e </span>
<span id="cb86-1057"><a href="#cb86-1057" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1058"><a href="#cb86-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1061"><a href="#cb86-1061" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1062"><a href="#cb86-1062" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: love_plot_maori</span></span>
<span id="cb86-1063"><a href="#cb86-1063" aria-hidden="true" tabindex="-1"></a><span class="co">#| column: page-right</span></span>
<span id="cb86-1064"><a href="#cb86-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1065"><a href="#cb86-1065" aria-hidden="true" tabindex="-1"></a>love_plot_m <span class="ot">&lt;-</span> <span class="fu">love.plot</span>(dt_match_ebal<span class="sc">$</span>māori,</span>
<span id="cb86-1066"><a href="#cb86-1066" aria-hidden="true" tabindex="-1"></a>          <span class="at">binary =</span> <span class="st">"std"</span>,</span>
<span id="cb86-1067"><a href="#cb86-1067" aria-hidden="true" tabindex="-1"></a>          <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> .<span class="dv">1</span>)) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Māori Weighting: method e-balance"</span>)</span>
<span id="cb86-1068"><a href="#cb86-1068" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb86-1069"><a href="#cb86-1069" aria-hidden="true" tabindex="-1"></a>love_plot_m</span>
<span id="cb86-1070"><a href="#cb86-1070" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1071"><a href="#cb86-1071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1072"><a href="#cb86-1072" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example Summary NZ Euro Propensity scores.</span></span>
<span id="cb86-1073"><a href="#cb86-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1074"><a href="#cb86-1074" aria-hidden="true" tabindex="-1"></a>*We estimated propensity score analysis using entropy balancing, energy balancing and traditional propensity scores. Of these approaches, entropy balancing provided the best balance. The results indicate an excellent balance across all variables, with Max.Diff.Adj values significantly below the target threshold of 0.05 across a range of binary and continuous baseline confounders, including gender, generation cohort, urban_location, exercise hours (coarsened, baseline), education, employment status, depression, anxiety, and various personality traits. The Max.Diff.Adj values for all variables were well below the target threshold of 0.05, with most variables achieving a Max.Diff.Adj of 0.0001 or lower. This indicates a high level of balance across all treatment pairs.*</span>
<span id="cb86-1075"><a href="#cb86-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1076"><a href="#cb86-1076" aria-hidden="true" tabindex="-1"></a>*The effective sample sizes were also adjusted using entropy balancing. The unadjusted sample sizes for the inactive, active, and very active groups were 2880, 3927, and 1834, respectively. After adjustment, the effective sample sizes were reduced to 1855.89, 3659.59, and 1052.01, respectively.*</span>
<span id="cb86-1077"><a href="#cb86-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1078"><a href="#cb86-1078" aria-hidden="true" tabindex="-1"></a>*The weight ranges for the inactive, active, and very active groups varied, with the inactive group showing the widest range (0.2310 to 7.0511) and the active group showing the narrowest range (0.5769 to 1.9603). Despite these variations, the coefficient of variation, mean absolute deviation (MAD), and entropy were all within acceptable limits for each group, indicating a good balance of weights.*</span>
<span id="cb86-1079"><a href="#cb86-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1080"><a href="#cb86-1080" aria-hidden="true" tabindex="-1"></a>*We also identified the units with the five most extreme weights by group. These units exhibited higher weights compared to the rest of the units in their respective groups, but they did not significantly affect the overall balance of weights.*</span>
<span id="cb86-1081"><a href="#cb86-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1082"><a href="#cb86-1082" aria-hidden="true" tabindex="-1"></a>*We plotted these results using love plots, visually confirming both the balance in the propensity score model using entropy balanced weights, and the imbalance in the model that does not adjust for baseline confounders.*</span>
<span id="cb86-1083"><a href="#cb86-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1084"><a href="#cb86-1084" aria-hidden="true" tabindex="-1"></a>*Overall, these findings support the use of entropy balancing in propensity score analysis to ensure a balanced distribution of covariates across treatment groups, conditional on the measured covariates included in the model.*</span>
<span id="cb86-1085"><a href="#cb86-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1086"><a href="#cb86-1086" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example Summary Maori Propensity scores.</span></span>
<span id="cb86-1087"><a href="#cb86-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1088"><a href="#cb86-1088" aria-hidden="true" tabindex="-1"></a>Results:</span>
<span id="cb86-1089"><a href="#cb86-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1090"><a href="#cb86-1090" aria-hidden="true" tabindex="-1"></a>*The entropy balancing method was also the best performing method that was applied to a subgroup analysis of the Māori population. Similar to the NZ European subgroup analysis, the method achieved a high level of balance across all treatment pairs for the Māori subgroup. The Max.Diff.Adj values for all variables were well below the target threshold of 0.05, with most variables achieving a Max.Diff.Adj of 0.0001 or lower. This indicates a high level of balance across all treatment pairs for the Māori subgroup.*</span>
<span id="cb86-1091"><a href="#cb86-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1092"><a href="#cb86-1092" aria-hidden="true" tabindex="-1"></a>*The effective sample sizes for the Māori subgroup were also adjusted using entropy balancing. The unadjusted sample sizes for the inactive, active, and very active groups were 307, 354, and 160, respectively. After adjustment, the effective sample sizes were reduced to 220.54, 321.09, and 76.39, respectively*</span>
<span id="cb86-1093"><a href="#cb86-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1094"><a href="#cb86-1094" aria-hidden="true" tabindex="-1"></a>*The weight ranges for the inactive, active, and very active groups in the Māori subgroup varied, with the inactive group showing the widest range (0.2213 to 3.8101) and the active group showing the narrowest range (0.3995 to 1.9800). Despite these variations, the coefficient of variation, mean absolute deviation (MAD), and entropy were all within acceptable limits for each group, indicating a good balance of weights.*</span>
<span id="cb86-1095"><a href="#cb86-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1096"><a href="#cb86-1096" aria-hidden="true" tabindex="-1"></a>*The study also identified the units with the five most extreme weights by group for the Māori subgroup. These units exhibited higher weights compared to the rest of the units in their respective groups, but they did not significantly affect the overall balance of weights.*</span>
<span id="cb86-1097"><a href="#cb86-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1098"><a href="#cb86-1098" aria-hidden="true" tabindex="-1"></a>*In conclusion, the results of the Māori subgroup analysis are consistent with the overall analysis. The entropy balancing method achieved a high level of balance across all treatment pairs, with Max.Diff.Adj values significantly below the target threshold. These findings support the use of entropy balancing in propensity score analysis to ensure a balanced distribution of covariates across treatment groups, even in subgroup analyses.*</span>
<span id="cb86-1099"><a href="#cb86-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1100"><a href="#cb86-1100" aria-hidden="true" tabindex="-1"></a><span class="fu">### More data wrangling</span></span>
<span id="cb86-1101"><a href="#cb86-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1102"><a href="#cb86-1102" aria-hidden="true" tabindex="-1"></a>Note that we need to attach the <span class="in">`weights`</span> from the propensity score model back to the data.</span>
<span id="cb86-1103"><a href="#cb86-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1104"><a href="#cb86-1104" aria-hidden="true" tabindex="-1"></a>However, because our weighting analysis estimates a model for the *exposure*, we only need to do this analysis once, no matter how many outcomes we investigate. So there's a little good news.</span>
<span id="cb86-1105"><a href="#cb86-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1108"><a href="#cb86-1108" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1109"><a href="#cb86-1109" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: yet_more_wrangling</span></span>
<span id="cb86-1110"><a href="#cb86-1110" aria-hidden="true" tabindex="-1"></a><span class="co">#| </span></span>
<span id="cb86-1111"><a href="#cb86-1111" aria-hidden="true" tabindex="-1"></a><span class="co"># prepare nz_euro data</span></span>
<span id="cb86-1112"><a href="#cb86-1112" aria-hidden="true" tabindex="-1"></a>dt_ref_e <span class="ot">&lt;-</span> <span class="fu">subset</span>(dt, t0_eth_cat <span class="sc">==</span> <span class="st">"euro"</span>) <span class="co"># original data subset only nz europeans</span></span>
<span id="cb86-1113"><a href="#cb86-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1114"><a href="#cb86-1114" aria-hidden="true" tabindex="-1"></a><span class="co"># add weights</span></span>
<span id="cb86-1115"><a href="#cb86-1115" aria-hidden="true" tabindex="-1"></a>dt_ref_e<span class="sc">$</span>weights <span class="ot">&lt;-</span> dt_match_ebal<span class="sc">$</span>euro<span class="sc">$</span>weights <span class="co"># get weights from the ps matching model,add to data</span></span>
<span id="cb86-1116"><a href="#cb86-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1117"><a href="#cb86-1117" aria-hidden="true" tabindex="-1"></a><span class="co"># prepare maori data</span></span>
<span id="cb86-1118"><a href="#cb86-1118" aria-hidden="true" tabindex="-1"></a>dt_ref_m <span class="ot">&lt;-</span> <span class="fu">subset</span>(dt, t0_eth_cat <span class="sc">==</span> <span class="st">"māori"</span>)<span class="co"># original data subset only maori</span></span>
<span id="cb86-1119"><a href="#cb86-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1120"><a href="#cb86-1120" aria-hidden="true" tabindex="-1"></a><span class="co"># add weights</span></span>
<span id="cb86-1121"><a href="#cb86-1121" aria-hidden="true" tabindex="-1"></a>dt_ref_m<span class="sc">$</span>weights <span class="ot">&lt;-</span> dt_match_ebal<span class="sc">$</span>māori<span class="sc">$</span>weights <span class="co"># get weights from the ps matching model, add to data</span></span>
<span id="cb86-1122"><a href="#cb86-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1123"><a href="#cb86-1123" aria-hidden="true" tabindex="-1"></a><span class="co"># combine data into one data frame</span></span>
<span id="cb86-1124"><a href="#cb86-1124" aria-hidden="true" tabindex="-1"></a>dt_ref_all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dt_ref_e, dt_ref_m) <span class="co"># combine the data into one dataframe. </span></span>
<span id="cb86-1125"><a href="#cb86-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1126"><a href="#cb86-1126" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1127"><a href="#cb86-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1128"><a href="#cb86-1128" aria-hidden="true" tabindex="-1"></a><span class="fu">## Anxiety Analysis and Results</span></span>
<span id="cb86-1129"><a href="#cb86-1129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1130"><a href="#cb86-1130" aria-hidden="true" tabindex="-1"></a>Let's consider a pseudo experiment where someone moves from inactive to active.</span>
<span id="cb86-1131"><a href="#cb86-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1132"><a href="#cb86-1132" aria-hidden="true" tabindex="-1"></a>We will use doubly robust analysis. This means that we estimate a model using both propensity score weights (obtained using the ebalance algortithm) and regression stratification.</span>
<span id="cb86-1133"><a href="#cb86-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1134"><a href="#cb86-1134" aria-hidden="true" tabindex="-1"></a>I wrote a function that will caluclate "E-values." An E-value is defined as the</span>
<span id="cb86-1135"><a href="#cb86-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1136"><a href="#cb86-1136" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; E-values represent the minimum strength or magnitude of association that an unmeasured confounder would need to have with both treatment and outcome in order to explain the observed effect estimates conditional on measured covariates.</span></span>
<span id="cb86-1137"><a href="#cb86-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1140"><a href="#cb86-1140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1141"><a href="#cb86-1141" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: model_anxiety</span></span>
<span id="cb86-1142"><a href="#cb86-1142" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb86-1143"><a href="#cb86-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1144"><a href="#cb86-1144" aria-hidden="true" tabindex="-1"></a><span class="co"># we do not evaluate to save time</span></span>
<span id="cb86-1145"><a href="#cb86-1145" aria-hidden="true" tabindex="-1"></a><span class="do">### SUBGROUP analysis</span></span>
<span id="cb86-1146"><a href="#cb86-1146" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span>  dt_ref_all</span>
<span id="cb86-1147"><a href="#cb86-1147" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span>  <span class="st">"t2_kessler_latent_anxiety_z"</span></span>
<span id="cb86-1148"><a href="#cb86-1148" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="st">"t1_hours_exercise_coarsen"</span> <span class="co"># already defined above</span></span>
<span id="cb86-1149"><a href="#cb86-1149" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">=</span> baseline_vars_reflective_propensity</span>
<span id="cb86-1150"><a href="#cb86-1150" aria-hidden="true" tabindex="-1"></a>treat_0 <span class="ot">=</span> <span class="st">"inactive"</span></span>
<span id="cb86-1151"><a href="#cb86-1151" aria-hidden="true" tabindex="-1"></a>treat_1 <span class="ot">=</span> <span class="st">"very_active"</span></span>
<span id="cb86-1152"><a href="#cb86-1152" aria-hidden="true" tabindex="-1"></a>estimand <span class="ot">=</span> <span class="st">"ATE"</span></span>
<span id="cb86-1153"><a href="#cb86-1153" aria-hidden="true" tabindex="-1"></a>scale <span class="ot">=</span> <span class="st">"RD"</span></span>
<span id="cb86-1154"><a href="#cb86-1154" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb86-1155"><a href="#cb86-1155" aria-hidden="true" tabindex="-1"></a>family <span class="ot">=</span> <span class="st">"gaussian"</span></span>
<span id="cb86-1156"><a href="#cb86-1156" aria-hidden="true" tabindex="-1"></a>continuous_X <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb86-1157"><a href="#cb86-1157" aria-hidden="true" tabindex="-1"></a>splines <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb86-1158"><a href="#cb86-1158" aria-hidden="true" tabindex="-1"></a>cores <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()</span>
<span id="cb86-1159"><a href="#cb86-1159" aria-hidden="true" tabindex="-1"></a>S <span class="ot">=</span> <span class="st">"t0_eth_cat"</span></span>
<span id="cb86-1160"><a href="#cb86-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1161"><a href="#cb86-1161" aria-hidden="true" tabindex="-1"></a><span class="co"># not we interact the subclass X treatment X covariates</span></span>
<span id="cb86-1162"><a href="#cb86-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1163"><a href="#cb86-1163" aria-hidden="true" tabindex="-1"></a>formula_str <span class="ot">&lt;-</span></span>
<span id="cb86-1164"><a href="#cb86-1164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(</span>
<span id="cb86-1165"><a href="#cb86-1165" aria-hidden="true" tabindex="-1"></a>    Y,</span>
<span id="cb86-1166"><a href="#cb86-1166" aria-hidden="true" tabindex="-1"></a>    <span class="st">"~"</span>,</span>
<span id="cb86-1167"><a href="#cb86-1167" aria-hidden="true" tabindex="-1"></a>    S,</span>
<span id="cb86-1168"><a href="#cb86-1168" aria-hidden="true" tabindex="-1"></a>    <span class="st">"*"</span>,</span>
<span id="cb86-1169"><a href="#cb86-1169" aria-hidden="true" tabindex="-1"></a>    <span class="st">"("</span>,</span>
<span id="cb86-1170"><a href="#cb86-1170" aria-hidden="true" tabindex="-1"></a>    X ,</span>
<span id="cb86-1171"><a href="#cb86-1171" aria-hidden="true" tabindex="-1"></a>    <span class="st">"*"</span>,</span>
<span id="cb86-1172"><a href="#cb86-1172" aria-hidden="true" tabindex="-1"></a>    <span class="st">"("</span>,</span>
<span id="cb86-1173"><a href="#cb86-1173" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(baseline_vars_reflective_propensity, <span class="at">collapse =</span> <span class="st">"+"</span>),</span>
<span id="cb86-1174"><a href="#cb86-1174" aria-hidden="true" tabindex="-1"></a>    <span class="st">")"</span>,</span>
<span id="cb86-1175"><a href="#cb86-1175" aria-hidden="true" tabindex="-1"></a>    <span class="st">")"</span></span>
<span id="cb86-1176"><a href="#cb86-1176" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-1177"><a href="#cb86-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1178"><a href="#cb86-1178" aria-hidden="true" tabindex="-1"></a><span class="co"># formula_str. # inspect on our own time </span></span>
<span id="cb86-1179"><a href="#cb86-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1180"><a href="#cb86-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1181"><a href="#cb86-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1182"><a href="#cb86-1182" aria-hidden="true" tabindex="-1"></a><span class="co"># fit model</span></span>
<span id="cb86-1183"><a href="#cb86-1183" aria-hidden="true" tabindex="-1"></a>fit_all_all  <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb86-1184"><a href="#cb86-1184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>(formula_str),</span>
<span id="cb86-1185"><a href="#cb86-1185" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> weights,</span>
<span id="cb86-1186"><a href="#cb86-1186" aria-hidden="true" tabindex="-1"></a>  <span class="co"># weights = if (!is.null(weight_var)) weight_var else NULL,</span></span>
<span id="cb86-1187"><a href="#cb86-1187" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> family,</span>
<span id="cb86-1188"><a href="#cb86-1188" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df</span>
<span id="cb86-1189"><a href="#cb86-1189" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-1190"><a href="#cb86-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1191"><a href="#cb86-1191" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate coefficients</span></span>
<span id="cb86-1192"><a href="#cb86-1192" aria-hidden="true" tabindex="-1"></a><span class="fu">conflicts_prefer</span>(clarify<span class="sc">::</span>sim)</span>
<span id="cb86-1193"><a href="#cb86-1193" aria-hidden="true" tabindex="-1"></a>sim_model_all <span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_all_all, <span class="at">n =</span> nsims, <span class="at">vcov =</span> <span class="st">"HC0"</span>)</span>
<span id="cb86-1194"><a href="#cb86-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1195"><a href="#cb86-1195" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate effect as modified in europeans</span></span>
<span id="cb86-1196"><a href="#cb86-1196" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_e <span class="ot">&lt;-</span> <span class="fu">sim_ame</span>(</span>
<span id="cb86-1197"><a href="#cb86-1197" aria-hidden="true" tabindex="-1"></a>  sim_model_all,</span>
<span id="cb86-1198"><a href="#cb86-1198" aria-hidden="true" tabindex="-1"></a>  <span class="at">var =</span> X,</span>
<span id="cb86-1199"><a href="#cb86-1199" aria-hidden="true" tabindex="-1"></a>  <span class="at">cl =</span> cores,</span>
<span id="cb86-1200"><a href="#cb86-1200" aria-hidden="true" tabindex="-1"></a>  <span class="at">subset =</span> t0_eth_cat <span class="sc">==</span> <span class="st">"euro"</span>,</span>
<span id="cb86-1201"><a href="#cb86-1201" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb86-1202"><a href="#cb86-1202" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-1203"><a href="#cb86-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1204"><a href="#cb86-1204" aria-hidden="true" tabindex="-1"></a><span class="co">#rm(sim_estimand_all_e)</span></span>
<span id="cb86-1205"><a href="#cb86-1205" aria-hidden="true" tabindex="-1"></a><span class="co"># note contrast of interest</span></span>
<span id="cb86-1206"><a href="#cb86-1206" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_e <span class="ot">&lt;-</span></span>
<span id="cb86-1207"><a href="#cb86-1207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transform</span>(sim_estimand_all_e, <span class="at">RD =</span> <span class="st">`</span><span class="at">E[Y(very_active)]</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">E[Y(inactive)]</span><span class="st">`</span>)</span>
<span id="cb86-1208"><a href="#cb86-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1209"><a href="#cb86-1209" aria-hidden="true" tabindex="-1"></a><span class="co">#rm(sim_estimand_all_m)</span></span>
<span id="cb86-1210"><a href="#cb86-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1211"><a href="#cb86-1211" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate effect as modified in māori</span></span>
<span id="cb86-1212"><a href="#cb86-1212" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_m <span class="ot">&lt;-</span> <span class="fu">sim_ame</span>(</span>
<span id="cb86-1213"><a href="#cb86-1213" aria-hidden="true" tabindex="-1"></a>  sim_model_all,</span>
<span id="cb86-1214"><a href="#cb86-1214" aria-hidden="true" tabindex="-1"></a>  <span class="at">var =</span> X,</span>
<span id="cb86-1215"><a href="#cb86-1215" aria-hidden="true" tabindex="-1"></a>  <span class="at">cl =</span> cores,</span>
<span id="cb86-1216"><a href="#cb86-1216" aria-hidden="true" tabindex="-1"></a>  <span class="at">subset =</span> t0_eth_cat <span class="sc">==</span> <span class="st">"māori"</span>,</span>
<span id="cb86-1217"><a href="#cb86-1217" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb86-1218"><a href="#cb86-1218" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-1219"><a href="#cb86-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1220"><a href="#cb86-1220" aria-hidden="true" tabindex="-1"></a><span class="co"># combine</span></span>
<span id="cb86-1221"><a href="#cb86-1221" aria-hidden="true" tabindex="-1"></a><span class="co">#m(sim_estimand_all_m)</span></span>
<span id="cb86-1222"><a href="#cb86-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1223"><a href="#cb86-1223" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_m <span class="ot">&lt;-</span></span>
<span id="cb86-1224"><a href="#cb86-1224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transform</span>(sim_estimand_all_m, <span class="at">RD =</span> <span class="st">`</span><span class="at">E[Y(very_active)]</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">E[Y(inactive)]</span><span class="st">`</span>)</span>
<span id="cb86-1225"><a href="#cb86-1225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1226"><a href="#cb86-1226" aria-hidden="true" tabindex="-1"></a><span class="co"># rearrange</span></span>
<span id="cb86-1227"><a href="#cb86-1227" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sim_estimand_all_e) <span class="ot">&lt;-</span></span>
<span id="cb86-1228"><a href="#cb86-1228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">names</span>(sim_estimand_all_e), <span class="st">"e"</span>, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb86-1229"><a href="#cb86-1229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1230"><a href="#cb86-1230" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sim_estimand_all_m) <span class="ot">&lt;-</span></span>
<span id="cb86-1231"><a href="#cb86-1231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">names</span>(sim_estimand_all_m), <span class="st">"m"</span>, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb86-1232"><a href="#cb86-1232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1233"><a href="#cb86-1233" aria-hidden="true" tabindex="-1"></a>est_all_anxiety <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sim_estimand_all_m, sim_estimand_all_e)</span>
<span id="cb86-1234"><a href="#cb86-1234" aria-hidden="true" tabindex="-1"></a>est_all_anxiety <span class="ot">&lt;-</span> <span class="fu">transform</span>(est_all_anxiety, <span class="st">`</span><span class="at">RD_m - RD_e</span><span class="st">`</span> <span class="ot">=</span> RD_m <span class="sc">-</span> RD_e)</span>
<span id="cb86-1235"><a href="#cb86-1235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1236"><a href="#cb86-1236" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(est_all_anxiety, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>,<span class="st">"est_all_anxiety"</span>))</span>
<span id="cb86-1237"><a href="#cb86-1237" aria-hidden="true" tabindex="-1"></a><span class="co"># view summary</span></span>
<span id="cb86-1238"><a href="#cb86-1238" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1239"><a href="#cb86-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1240"><a href="#cb86-1240" aria-hidden="true" tabindex="-1"></a>Calculate E-values</span>
<span id="cb86-1241"><a href="#cb86-1241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1244"><a href="#cb86-1244" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1245"><a href="#cb86-1245" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: summary_anxiety</span></span>
<span id="cb86-1246"><a href="#cb86-1246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1247"><a href="#cb86-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1248"><a href="#cb86-1248" aria-hidden="true" tabindex="-1"></a><span class="co"># read data</span></span>
<span id="cb86-1249"><a href="#cb86-1249" aria-hidden="true" tabindex="-1"></a>est_all_anxiety <span class="ot">&lt;-</span> <span class="fu">readRDS</span>( here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>,<span class="st">"est_all_anxiety"</span>))</span>
<span id="cb86-1250"><a href="#cb86-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1251"><a href="#cb86-1251" aria-hidden="true" tabindex="-1"></a><span class="co"># make dataframe</span></span>
<span id="cb86-1252"><a href="#cb86-1252" aria-hidden="true" tabindex="-1"></a>df_anxiety_all <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="fu">summary</span>(est_all_anxiety) )</span>
<span id="cb86-1253"><a href="#cb86-1253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1254"><a href="#cb86-1254" aria-hidden="true" tabindex="-1"></a>table_estimates_anxiety <span class="ot">&lt;-</span> df_anxiety_all <span class="sc">|&gt;</span> </span>
<span id="cb86-1255"><a href="#cb86-1255" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">row.names</span>(df_anxiety_all) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"RD_m"</span>, <span class="st">"RD_e"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb86-1256"><a href="#cb86-1256" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">lower_ci =</span> <span class="st">`</span><span class="at">X2.5..</span><span class="st">`</span>,</span>
<span id="cb86-1257"><a href="#cb86-1257" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper_ci =</span> <span class="st">`</span><span class="at">X97.5..</span><span class="st">`</span>,</span>
<span id="cb86-1258"><a href="#cb86-1258" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> Estimate) <span class="sc">|&gt;</span> </span>
<span id="cb86-1259"><a href="#cb86-1259" aria-hidden="true" tabindex="-1"></a> <span class="co"># dplyr::mutate(standard_error = abs(`2.5 %` - `97.5 %`) / 3.92) |&gt; </span></span>
<span id="cb86-1260"><a href="#cb86-1260" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), round, <span class="at">digits =</span> <span class="dv">3</span>))</span>
<span id="cb86-1261"><a href="#cb86-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1262"><a href="#cb86-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1263"><a href="#cb86-1263" aria-hidden="true" tabindex="-1"></a><span class="co"># note that I made a function to calculate the Evalue, load this with "experimental functions"</span></span>
<span id="cb86-1264"><a href="#cb86-1264" aria-hidden="true" tabindex="-1"></a>test_tab <span class="ot">&lt;-</span> <span class="fu">tab_ate_subgroup_rd</span>(table_estimates_anxiety, <span class="at">delta =</span> <span class="dv">1</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb86-1265"><a href="#cb86-1265" aria-hidden="true" tabindex="-1"></a>test_tab <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span>
<span id="cb86-1266"><a href="#cb86-1266" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1267"><a href="#cb86-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1270"><a href="#cb86-1270" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1271"><a href="#cb86-1271" aria-hidden="true" tabindex="-1"></a>df_anxiety_all_plot <span class="ot">&lt;-</span> df_anxiety_all <span class="sc">|&gt;</span> </span>
<span id="cb86-1272"><a href="#cb86-1272" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(row.names(df_anxiety_all) %in% c("RD_m - RD_e")) |&gt; </span></span>
<span id="cb86-1273"><a href="#cb86-1273" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">lower_ci =</span> <span class="st">`</span><span class="at">X2.5..</span><span class="st">`</span>,</span>
<span id="cb86-1274"><a href="#cb86-1274" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper_ci =</span> <span class="st">`</span><span class="at">X97.5..</span><span class="st">`</span>,</span>
<span id="cb86-1275"><a href="#cb86-1275" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> Estimate) <span class="sc">|&gt;</span> </span>
<span id="cb86-1276"><a href="#cb86-1276" aria-hidden="true" tabindex="-1"></a> <span class="co"># dplyr::mutate(standard_error = abs(`2.5 %` - `97.5 %`) / 3.92) |&gt; </span></span>
<span id="cb86-1277"><a href="#cb86-1277" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), round, <span class="at">digits =</span> <span class="dv">3</span>)) </span>
<span id="cb86-1278"><a href="#cb86-1278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1279"><a href="#cb86-1279" aria-hidden="true" tabindex="-1"></a>df_anxiety_all_plot</span>
<span id="cb86-1280"><a href="#cb86-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1281"><a href="#cb86-1281" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_sub_forest</span>(df_anxiety_all_plot)</span>
<span id="cb86-1282"><a href="#cb86-1282" aria-hidden="true" tabindex="-1"></a>df_anxiety_all_plot<span class="sc">|&gt;</span> </span>
<span id="cb86-1283"><a href="#cb86-1283" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"html"</span>)</span>
<span id="cb86-1284"><a href="#cb86-1284" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1285"><a href="#cb86-1285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1286"><a href="#cb86-1286" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpretation</span></span>
<span id="cb86-1287"><a href="#cb86-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1288"><a href="#cb86-1288" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Increase in activity among NZ Europeans would be expected to lower anxiety.</span>
<span id="cb86-1289"><a href="#cb86-1289" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Increase in activity among Māori is not reliable.\</span>
<span id="cb86-1290"><a href="#cb86-1290" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>No reliable differences in these effects between the groups.</span>
<span id="cb86-1291"><a href="#cb86-1291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1292"><a href="#cb86-1292" aria-hidden="true" tabindex="-1"></a><span class="fu">## Depression Analysis and Results</span></span>
<span id="cb86-1293"><a href="#cb86-1293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1296"><a href="#cb86-1296" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1297"><a href="#cb86-1297" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb86-1298"><a href="#cb86-1298" aria-hidden="true" tabindex="-1"></a><span class="do">### SUBGROUP analysis</span></span>
<span id="cb86-1299"><a href="#cb86-1299" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span>  dt_ref_all</span>
<span id="cb86-1300"><a href="#cb86-1300" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span>  <span class="st">"t2_kessler_latent_depression_z"</span></span>
<span id="cb86-1301"><a href="#cb86-1301" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="st">"t1_hours_exercise_coarsen"</span> <span class="co"># already defined above</span></span>
<span id="cb86-1302"><a href="#cb86-1302" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">=</span> baseline_vars_reflective_propensity</span>
<span id="cb86-1303"><a href="#cb86-1303" aria-hidden="true" tabindex="-1"></a>treat_0 <span class="ot">=</span> <span class="st">"inactive"</span></span>
<span id="cb86-1304"><a href="#cb86-1304" aria-hidden="true" tabindex="-1"></a>treat_1 <span class="ot">=</span> <span class="st">"very_active"</span></span>
<span id="cb86-1305"><a href="#cb86-1305" aria-hidden="true" tabindex="-1"></a>estimand <span class="ot">=</span> <span class="st">"ATE"</span></span>
<span id="cb86-1306"><a href="#cb86-1306" aria-hidden="true" tabindex="-1"></a>scale <span class="ot">=</span> <span class="st">"RD"</span></span>
<span id="cb86-1307"><a href="#cb86-1307" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb86-1308"><a href="#cb86-1308" aria-hidden="true" tabindex="-1"></a>family <span class="ot">=</span> <span class="st">"gaussian"</span></span>
<span id="cb86-1309"><a href="#cb86-1309" aria-hidden="true" tabindex="-1"></a>continuous_X <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb86-1310"><a href="#cb86-1310" aria-hidden="true" tabindex="-1"></a>splines <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb86-1311"><a href="#cb86-1311" aria-hidden="true" tabindex="-1"></a>cores <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()</span>
<span id="cb86-1312"><a href="#cb86-1312" aria-hidden="true" tabindex="-1"></a>S <span class="ot">=</span> <span class="st">"t0_eth_cat"</span></span>
<span id="cb86-1313"><a href="#cb86-1313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1314"><a href="#cb86-1314" aria-hidden="true" tabindex="-1"></a><span class="co"># not we interact the subclass X treatment X covariates</span></span>
<span id="cb86-1315"><a href="#cb86-1315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1316"><a href="#cb86-1316" aria-hidden="true" tabindex="-1"></a>formula_str <span class="ot">&lt;-</span></span>
<span id="cb86-1317"><a href="#cb86-1317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(</span>
<span id="cb86-1318"><a href="#cb86-1318" aria-hidden="true" tabindex="-1"></a>    Y,</span>
<span id="cb86-1319"><a href="#cb86-1319" aria-hidden="true" tabindex="-1"></a>    <span class="st">"~"</span>,</span>
<span id="cb86-1320"><a href="#cb86-1320" aria-hidden="true" tabindex="-1"></a>    S,</span>
<span id="cb86-1321"><a href="#cb86-1321" aria-hidden="true" tabindex="-1"></a>    <span class="st">"*"</span>,</span>
<span id="cb86-1322"><a href="#cb86-1322" aria-hidden="true" tabindex="-1"></a>    <span class="st">"("</span>,</span>
<span id="cb86-1323"><a href="#cb86-1323" aria-hidden="true" tabindex="-1"></a>    X ,</span>
<span id="cb86-1324"><a href="#cb86-1324" aria-hidden="true" tabindex="-1"></a>    <span class="st">"*"</span>,</span>
<span id="cb86-1325"><a href="#cb86-1325" aria-hidden="true" tabindex="-1"></a>    <span class="st">"("</span>,</span>
<span id="cb86-1326"><a href="#cb86-1326" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(baseline_vars_reflective_propensity, <span class="at">collapse =</span> <span class="st">"+"</span>),</span>
<span id="cb86-1327"><a href="#cb86-1327" aria-hidden="true" tabindex="-1"></a>    <span class="st">")"</span>,</span>
<span id="cb86-1328"><a href="#cb86-1328" aria-hidden="true" tabindex="-1"></a>    <span class="st">")"</span></span>
<span id="cb86-1329"><a href="#cb86-1329" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-1330"><a href="#cb86-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1331"><a href="#cb86-1331" aria-hidden="true" tabindex="-1"></a><span class="co"># fit model</span></span>
<span id="cb86-1332"><a href="#cb86-1332" aria-hidden="true" tabindex="-1"></a>fit_all_dep  <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb86-1333"><a href="#cb86-1333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>(formula_str),</span>
<span id="cb86-1334"><a href="#cb86-1334" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> weights,</span>
<span id="cb86-1335"><a href="#cb86-1335" aria-hidden="true" tabindex="-1"></a>  <span class="co"># weights = if (!is.null(weight_var)) weight_var else NULL,</span></span>
<span id="cb86-1336"><a href="#cb86-1336" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> family,</span>
<span id="cb86-1337"><a href="#cb86-1337" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df</span>
<span id="cb86-1338"><a href="#cb86-1338" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-1339"><a href="#cb86-1339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1340"><a href="#cb86-1340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1341"><a href="#cb86-1341" aria-hidden="true" tabindex="-1"></a><span class="co"># coefs &lt;- coef(fit_all_dep)</span></span>
<span id="cb86-1342"><a href="#cb86-1342" aria-hidden="true" tabindex="-1"></a><span class="co"># table(is.na(coefs))#   </span></span>
<span id="cb86-1343"><a href="#cb86-1343" aria-hidden="true" tabindex="-1"></a><span class="co"># insight::get_varcov(fit_all_all)</span></span>
<span id="cb86-1344"><a href="#cb86-1344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1345"><a href="#cb86-1345" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate coefficients</span></span>
<span id="cb86-1346"><a href="#cb86-1346" aria-hidden="true" tabindex="-1"></a><span class="fu">conflicts_prefer</span>(clarify<span class="sc">::</span>sim)</span>
<span id="cb86-1347"><a href="#cb86-1347" aria-hidden="true" tabindex="-1"></a>sim_model_all <span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_all_dep, <span class="at">n =</span> nsims, <span class="at">vcov =</span> <span class="st">"HC1"</span>)</span>
<span id="cb86-1348"><a href="#cb86-1348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1349"><a href="#cb86-1349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1350"><a href="#cb86-1350" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate effect as modified in europeans</span></span>
<span id="cb86-1351"><a href="#cb86-1351" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_e_d <span class="ot">&lt;-</span> <span class="fu">sim_ame</span>(</span>
<span id="cb86-1352"><a href="#cb86-1352" aria-hidden="true" tabindex="-1"></a>  sim_model_all,</span>
<span id="cb86-1353"><a href="#cb86-1353" aria-hidden="true" tabindex="-1"></a>  <span class="at">var =</span> X,</span>
<span id="cb86-1354"><a href="#cb86-1354" aria-hidden="true" tabindex="-1"></a>  <span class="at">cl =</span> cores,</span>
<span id="cb86-1355"><a href="#cb86-1355" aria-hidden="true" tabindex="-1"></a>  <span class="at">subset =</span> t0_eth_cat <span class="sc">==</span> <span class="st">"euro"</span>,</span>
<span id="cb86-1356"><a href="#cb86-1356" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb86-1357"><a href="#cb86-1357" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-1358"><a href="#cb86-1358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1359"><a href="#cb86-1359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1360"><a href="#cb86-1360" aria-hidden="true" tabindex="-1"></a><span class="co"># note contrast of interest</span></span>
<span id="cb86-1361"><a href="#cb86-1361" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_e_d <span class="ot">&lt;-</span></span>
<span id="cb86-1362"><a href="#cb86-1362" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transform</span>(sim_estimand_all_e_d, <span class="at">RD =</span> <span class="st">`</span><span class="at">E[Y(very_active)]</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">E[Y(inactive)]</span><span class="st">`</span>)</span>
<span id="cb86-1363"><a href="#cb86-1363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1364"><a href="#cb86-1364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1365"><a href="#cb86-1365" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate effect as modified in māori</span></span>
<span id="cb86-1366"><a href="#cb86-1366" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_m_d <span class="ot">&lt;-</span> <span class="fu">sim_ame</span>(</span>
<span id="cb86-1367"><a href="#cb86-1367" aria-hidden="true" tabindex="-1"></a>  sim_model_all,</span>
<span id="cb86-1368"><a href="#cb86-1368" aria-hidden="true" tabindex="-1"></a>  <span class="at">var =</span> X,</span>
<span id="cb86-1369"><a href="#cb86-1369" aria-hidden="true" tabindex="-1"></a>  <span class="at">cl =</span> cores,</span>
<span id="cb86-1370"><a href="#cb86-1370" aria-hidden="true" tabindex="-1"></a>  <span class="at">subset =</span> t0_eth_cat <span class="sc">==</span> <span class="st">"māori"</span>,</span>
<span id="cb86-1371"><a href="#cb86-1371" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb86-1372"><a href="#cb86-1372" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-1373"><a href="#cb86-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1374"><a href="#cb86-1374" aria-hidden="true" tabindex="-1"></a><span class="co"># combine</span></span>
<span id="cb86-1375"><a href="#cb86-1375" aria-hidden="true" tabindex="-1"></a>sim_estimand_all_m_d <span class="ot">&lt;-</span></span>
<span id="cb86-1376"><a href="#cb86-1376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transform</span>(sim_estimand_all_m_d, <span class="at">RD =</span> <span class="st">`</span><span class="at">E[Y(very_active)]</span><span class="st">`</span> <span class="sc">-</span> <span class="st">`</span><span class="at">E[Y(inactive)]</span><span class="st">`</span>)</span>
<span id="cb86-1377"><a href="#cb86-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1378"><a href="#cb86-1378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1379"><a href="#cb86-1379" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb86-1380"><a href="#cb86-1380" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(sim_estimand_all_e_d)</span></span>
<span id="cb86-1381"><a href="#cb86-1381" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(sim_estimand_all_m_d)</span></span>
<span id="cb86-1382"><a href="#cb86-1382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1383"><a href="#cb86-1383" aria-hidden="true" tabindex="-1"></a><span class="co"># rearrange</span></span>
<span id="cb86-1384"><a href="#cb86-1384" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sim_estimand_all_e_d) <span class="ot">&lt;-</span></span>
<span id="cb86-1385"><a href="#cb86-1385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">names</span>(sim_estimand_all_e_d), <span class="st">"e"</span>, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb86-1386"><a href="#cb86-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1387"><a href="#cb86-1387" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sim_estimand_all_m_d) <span class="ot">&lt;-</span></span>
<span id="cb86-1388"><a href="#cb86-1388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">names</span>(sim_estimand_all_m_d), <span class="st">"m"</span>, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb86-1389"><a href="#cb86-1389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1390"><a href="#cb86-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1391"><a href="#cb86-1391" aria-hidden="true" tabindex="-1"></a>est_all_d <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sim_estimand_all_m_d, sim_estimand_all_e_d)</span>
<span id="cb86-1392"><a href="#cb86-1392" aria-hidden="true" tabindex="-1"></a>est_all_d <span class="ot">&lt;-</span> <span class="fu">transform</span>(est_all_d, <span class="st">`</span><span class="at">RD_m - RD_e</span><span class="st">`</span> <span class="ot">=</span> RD_m <span class="sc">-</span> RD_e)</span>
<span id="cb86-1393"><a href="#cb86-1393" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(est_all_d, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"est_all_d"</span>))</span>
<span id="cb86-1394"><a href="#cb86-1394" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1395"><a href="#cb86-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1398"><a href="#cb86-1398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1399"><a href="#cb86-1399" aria-hidden="true" tabindex="-1"></a>est_all_d <span class="ot">&lt;-</span> <span class="fu">readRDS</span>( here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"est_all_d"</span>))</span>
<span id="cb86-1400"><a href="#cb86-1400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1401"><a href="#cb86-1401" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb86-1402"><a href="#cb86-1402" aria-hidden="true" tabindex="-1"></a><span class="co"># make dataframe</span></span>
<span id="cb86-1403"><a href="#cb86-1403" aria-hidden="true" tabindex="-1"></a>df_dep <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="fu">summary</span>(est_all_d) )</span>
<span id="cb86-1404"><a href="#cb86-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1405"><a href="#cb86-1405" aria-hidden="true" tabindex="-1"></a>table_estimates_depression <span class="ot">&lt;-</span> df_dep <span class="sc">|&gt;</span> </span>
<span id="cb86-1406"><a href="#cb86-1406" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">row.names</span>(df_dep) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"RD_m"</span>, <span class="st">"RD_e"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb86-1407"><a href="#cb86-1407" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">lower_ci =</span> <span class="st">`</span><span class="at">X2.5..</span><span class="st">`</span>,</span>
<span id="cb86-1408"><a href="#cb86-1408" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper_ci =</span> <span class="st">`</span><span class="at">X97.5..</span><span class="st">`</span>,</span>
<span id="cb86-1409"><a href="#cb86-1409" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> Estimate) <span class="sc">|&gt;</span> </span>
<span id="cb86-1410"><a href="#cb86-1410" aria-hidden="true" tabindex="-1"></a> <span class="co"># dplyr::mutate(standard_error = abs(`2.5 %` - `97.5 %`) / 3.92) |&gt; </span></span>
<span id="cb86-1411"><a href="#cb86-1411" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), round, <span class="at">digits =</span> <span class="dv">3</span>))</span>
<span id="cb86-1412"><a href="#cb86-1412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1413"><a href="#cb86-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1414"><a href="#cb86-1414" aria-hidden="true" tabindex="-1"></a><span class="co"># note that I made a function to calculate the Evalue, load this with "experimental functions"</span></span>
<span id="cb86-1415"><a href="#cb86-1415" aria-hidden="true" tabindex="-1"></a>table_depression <span class="ot">&lt;-</span> <span class="fu">tab_ate_subgroup_rd</span>(table_estimates_depression, <span class="at">delta =</span> <span class="dv">1</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb86-1416"><a href="#cb86-1416" aria-hidden="true" tabindex="-1"></a>table_depression <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span>
<span id="cb86-1417"><a href="#cb86-1417" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1418"><a href="#cb86-1418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1421"><a href="#cb86-1421" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1422"><a href="#cb86-1422" aria-hidden="true" tabindex="-1"></a><span class="co"># view summary</span></span>
<span id="cb86-1423"><a href="#cb86-1423" aria-hidden="true" tabindex="-1"></a>df_dep <span class="sc">|&gt;</span> </span>
<span id="cb86-1424"><a href="#cb86-1424" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, round, <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb86-1425"><a href="#cb86-1425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"html"</span>)</span>
<span id="cb86-1426"><a href="#cb86-1426" aria-hidden="true" tabindex="-1"></a><span class="co"># This table provides estimated levels of depression, in standard deviation units, for different levels of activity for two groups: Māori (indicated by "_m") and NZ Europeans (indicated by "_e").</span></span>
<span id="cb86-1427"><a href="#cb86-1427" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1428"><a href="#cb86-1428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1431"><a href="#cb86-1431" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1432"><a href="#cb86-1432" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: my_graph </span></span>
<span id="cb86-1433"><a href="#cb86-1433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1434"><a href="#cb86-1434" aria-hidden="true" tabindex="-1"></a>df_dep_plot_data <span class="ot">&lt;-</span> df_dep <span class="sc">|&gt;</span> </span>
<span id="cb86-1435"><a href="#cb86-1435" aria-hidden="true" tabindex="-1"></a> <span class="fu">rename</span>( <span class="at">lower_ci =</span> <span class="st">`</span><span class="at">X2.5..</span><span class="st">`</span>,</span>
<span id="cb86-1436"><a href="#cb86-1436" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper_ci =</span> <span class="st">`</span><span class="at">X97.5..</span><span class="st">`</span>,</span>
<span id="cb86-1437"><a href="#cb86-1437" aria-hidden="true" tabindex="-1"></a>         <span class="at">estimate =</span> Estimate) <span class="sc">|&gt;</span> </span>
<span id="cb86-1438"><a href="#cb86-1438" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, round, <span class="dv">3</span>) </span>
<span id="cb86-1439"><a href="#cb86-1439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1440"><a href="#cb86-1440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1441"><a href="#cb86-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1442"><a href="#cb86-1442" aria-hidden="true" tabindex="-1"></a>plot_sub_forest <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb86-1443"><a href="#cb86-1443" aria-hidden="true" tabindex="-1"></a>  <span class="fu">require</span>(ggplot2)</span>
<span id="cb86-1444"><a href="#cb86-1444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1445"><a href="#cb86-1445" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if required packages are installed</span></span>
<span id="cb86-1446"><a href="#cb86-1446" aria-hidden="true" tabindex="-1"></a>  required_packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb86-1447"><a href="#cb86-1447" aria-hidden="true" tabindex="-1"></a>  new_packages <span class="ot">&lt;-</span> required_packages[<span class="sc">!</span>(required_packages <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[, <span class="st">"Package"</span>])]</span>
<span id="cb86-1448"><a href="#cb86-1448" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(new_packages))</span>
<span id="cb86-1449"><a href="#cb86-1449" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Missing packages: "</span>, <span class="fu">paste</span>(new_packages, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb86-1450"><a href="#cb86-1450" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-1451"><a href="#cb86-1451" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if required columns are in the dataframe</span></span>
<span id="cb86-1452"><a href="#cb86-1452" aria-hidden="true" tabindex="-1"></a>  required_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"estimate"</span>, <span class="st">"lower_ci"</span>, <span class="st">"upper_ci"</span>)</span>
<span id="cb86-1453"><a href="#cb86-1453" aria-hidden="true" tabindex="-1"></a>  missing_cols <span class="ot">&lt;-</span> required_cols[<span class="sc">!</span>(required_cols <span class="sc">%in%</span> <span class="fu">colnames</span>(df))]</span>
<span id="cb86-1454"><a href="#cb86-1454" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(missing_cols) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb86-1455"><a href="#cb86-1455" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Missing columns in dataframe: "</span>, <span class="fu">paste</span>(missing_cols, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb86-1456"><a href="#cb86-1456" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-1457"><a href="#cb86-1457" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Order the factor levels by the estimate column in decreasing order</span></span>
<span id="cb86-1458"><a href="#cb86-1458" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-1459"><a href="#cb86-1459" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x=</span>estimate, <span class="at">y=</span><span class="fu">factor</span>(<span class="fu">row.names</span>(df)))) <span class="sc">+</span></span>
<span id="cb86-1460"><a href="#cb86-1460" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb86-1461"><a href="#cb86-1461" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower_ci, <span class="at">xmax =</span> upper_ci), <span class="at">height=</span><span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb86-1462"><a href="#cb86-1462" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype=</span><span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb86-1463"><a href="#cb86-1463" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb86-1464"><a href="#cb86-1464" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Estimate"</span>) <span class="sc">+</span></span>
<span id="cb86-1465"><a href="#cb86-1465" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">""</span>)</span>
<span id="cb86-1466"><a href="#cb86-1466" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-1467"><a href="#cb86-1467" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_sub_forest</span>(df_dep_plot_data)</span>
<span id="cb86-1468"><a href="#cb86-1468" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1469"><a href="#cb86-1469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1470"><a href="#cb86-1470" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpretation</span></span>
<span id="cb86-1471"><a href="#cb86-1471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1472"><a href="#cb86-1472" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Increase in activity among NZ Europeans would be expected to lower depression, but the effect is not reliable.</span>
<span id="cb86-1473"><a href="#cb86-1473" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Increase in activity among Māori does not reliably affect depression..</span>
<span id="cb86-1474"><a href="#cb86-1474" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>No reliable group differences.</span>
<span id="cb86-1475"><a href="#cb86-1475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1476"><a href="#cb86-1476" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb86-1477"><a href="#cb86-1477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1478"><a href="#cb86-1478" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Generate a Kessler 6 binary score (Not Depressed vs. Moderately or Severely Depressed)</span>
<span id="cb86-1479"><a href="#cb86-1479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1480"><a href="#cb86-1480" aria-hidden="true" tabindex="-1"></a>and also:</span>
<span id="cb86-1481"><a href="#cb86-1481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1482"><a href="#cb86-1482" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Create a variable for the log of exercise hour</span>
<span id="cb86-1483"><a href="#cb86-1483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1484"><a href="#cb86-1484" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Take Home: estimate whether exercise causally affects nervousness, using the single item of the kessler 6 score. Briefly write up your results.</span>
<span id="cb86-1485"><a href="#cb86-1485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1486"><a href="#cb86-1486" aria-hidden="true" tabindex="-1"></a><span class="fu">## Appendix: MG-CFA</span></span>
<span id="cb86-1487"><a href="#cb86-1487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1488"><a href="#cb86-1488" aria-hidden="true" tabindex="-1"></a><span class="fu">### CFA for Kessler 6</span></span>
<span id="cb86-1489"><a href="#cb86-1489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1490"><a href="#cb86-1490" aria-hidden="true" tabindex="-1"></a>We have learned how to do confirmatory factor analysis. Let's put this knowledge to use but clarifying the underlying factor structure of Kessler-6</span>
<span id="cb86-1491"><a href="#cb86-1491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1492"><a href="#cb86-1492" aria-hidden="true" tabindex="-1"></a>The code below will:</span>
<span id="cb86-1493"><a href="#cb86-1493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1494"><a href="#cb86-1494" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Load required packages.</span>
<span id="cb86-1495"><a href="#cb86-1495" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Select the Kessler 6 items</span>
<span id="cb86-1496"><a href="#cb86-1496" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Check whether there is sufficient correlation among the variables to support factor analysis.</span>
<span id="cb86-1497"><a href="#cb86-1497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1500"><a href="#cb86-1500" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1501"><a href="#cb86-1501" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cfa_factor_structure</span></span>
<span id="cb86-1502"><a href="#cb86-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1503"><a href="#cb86-1503" aria-hidden="true" tabindex="-1"></a><span class="co"># select the columns we need. </span></span>
<span id="cb86-1504"><a href="#cb86-1504" aria-hidden="true" tabindex="-1"></a>dt_only_k6 <span class="ot">&lt;-</span> dt_start <span class="sc">|&gt;</span> <span class="fu">select</span>(kessler_depressed, kessler_effort,kessler_hopeless,</span>
<span id="cb86-1505"><a href="#cb86-1505" aria-hidden="true" tabindex="-1"></a>                                 kessler_worthless, kessler_nervous,</span>
<span id="cb86-1506"><a href="#cb86-1506" aria-hidden="true" tabindex="-1"></a>                                 kessler_restless)</span>
<span id="cb86-1507"><a href="#cb86-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1508"><a href="#cb86-1508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1509"><a href="#cb86-1509" aria-hidden="true" tabindex="-1"></a><span class="co"># check factor structure</span></span>
<span id="cb86-1510"><a href="#cb86-1510" aria-hidden="true" tabindex="-1"></a>performance<span class="sc">::</span><span class="fu">check_factorstructure</span>(dt_only_k6)</span>
<span id="cb86-1511"><a href="#cb86-1511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1512"><a href="#cb86-1512" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1513"><a href="#cb86-1513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1514"><a href="#cb86-1514" aria-hidden="true" tabindex="-1"></a>The code below will allow us to explore the factor structure, on the assumption of n = 3 factors.</span>
<span id="cb86-1515"><a href="#cb86-1515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1518"><a href="#cb86-1518" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1519"><a href="#cb86-1519" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: efa_made_easy</span></span>
<span id="cb86-1520"><a href="#cb86-1520" aria-hidden="true" tabindex="-1"></a><span class="co"># exploratory factor analysis</span></span>
<span id="cb86-1521"><a href="#cb86-1521" aria-hidden="true" tabindex="-1"></a><span class="co"># explore a factor structure made of 3 latent variables</span></span>
<span id="cb86-1522"><a href="#cb86-1522" aria-hidden="true" tabindex="-1"></a>efa <span class="ot">&lt;-</span> psych<span class="sc">::</span><span class="fu">fa</span>(dt_only_k6, <span class="at">nfactors =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb86-1523"><a href="#cb86-1523" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model_parameters</span>(<span class="at">sort =</span> <span class="cn">TRUE</span>, <span class="at">threshold =</span> <span class="st">"max"</span>)</span>
<span id="cb86-1524"><a href="#cb86-1524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1525"><a href="#cb86-1525" aria-hidden="true" tabindex="-1"></a>efa</span>
<span id="cb86-1526"><a href="#cb86-1526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1527"><a href="#cb86-1527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1528"><a href="#cb86-1528" aria-hidden="true" tabindex="-1"></a>This output describes an exploratory factor analysis (EFA) with 3 factors conducted on the Kessler 6 (K6) scale data. The K6 scale is used to measure psychological distress.</span>
<span id="cb86-1529"><a href="#cb86-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1530"><a href="#cb86-1530" aria-hidden="true" tabindex="-1"></a>The analysis identifies three latent factors, labeled MR1, MR2, and MR3, which collectively account for 66.05% of the variance in the K6 data. The factors MR1, MR2, and MR3 explain 35.14%, 17.17%, and 13.73% of the variance respectively.</span>
<span id="cb86-1531"><a href="#cb86-1531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1532"><a href="#cb86-1532" aria-hidden="true" tabindex="-1"></a>Factor loadings, indicating the strength and direction of the relationship between the K6 items and the latent factors, are as follows:</span>
<span id="cb86-1533"><a href="#cb86-1533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1534"><a href="#cb86-1534" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Factor MR1 is strongly associated with 'kessler_depressed', 'kessler_worthless', and 'kessler_hopeless' with loadings of 0.85, 0.79, and 0.75 respectively.</span>
<span id="cb86-1535"><a href="#cb86-1535" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Factor MR2 is exclusively linked with 'kessler_nervous' with a loading of 1.00.</span>
<span id="cb86-1536"><a href="#cb86-1536" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Factor MR3 relates to 'kessler_restless' and 'kessler_effort' with loadings of 0.69 and 0.48 respectively.</span>
<span id="cb86-1537"><a href="#cb86-1537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1538"><a href="#cb86-1538" aria-hidden="true" tabindex="-1"></a>The 'Uniqueness' values show the proportion of each variable's variance that isn't shared with the other variables.</span>
<span id="cb86-1539"><a href="#cb86-1539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1540"><a href="#cb86-1540" aria-hidden="true" tabindex="-1"></a>The 'Complexity' values give a measure of how each item loads on more than one factor. All the items are either loading exclusively on one factor (complexity=1.00) or slightly more than one factor. 'kessler_effort' with complexity of 1.66 shows it's the item most shared between the factors.</span>
<span id="cb86-1541"><a href="#cb86-1541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1542"><a href="#cb86-1542" aria-hidden="true" tabindex="-1"></a>The analysis suggests these K6 items measure may measure three somewhat distinct, yet related, factors of psychological distress.</span>
<span id="cb86-1543"><a href="#cb86-1543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1544"><a href="#cb86-1544" aria-hidden="true" tabindex="-1"></a>However, the meaning of these factors would need to be interpreted in the context of the variables and the theoretical framework of the study.</span>
<span id="cb86-1545"><a href="#cb86-1545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1546"><a href="#cb86-1546" aria-hidden="true" tabindex="-1"></a>Notably, there are many many theoretical frameworks for in measurement theory. Here is a brief description of the different conclusions one might make, depending on one's preferred theory.</span>
<span id="cb86-1547"><a href="#cb86-1547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1550"><a href="#cb86-1550" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1551"><a href="#cb86-1551" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot_factors</span></span>
<span id="cb86-1552"><a href="#cb86-1552" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb86-1553"><a href="#cb86-1553" aria-hidden="true" tabindex="-1"></a><span class="co">#| column: page-right</span></span>
<span id="cb86-1554"><a href="#cb86-1554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1555"><a href="#cb86-1555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1556"><a href="#cb86-1556" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">n_factors</span>(dt_only_k6)</span>
<span id="cb86-1557"><a href="#cb86-1557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1558"><a href="#cb86-1558" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb86-1559"><a href="#cb86-1559" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(n) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span>
<span id="cb86-1560"><a href="#cb86-1560" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1561"><a href="#cb86-1561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1562"><a href="#cb86-1562" aria-hidden="true" tabindex="-1"></a><span class="fu">### Confirmatory factor analysis (ignoring groups)</span></span>
<span id="cb86-1563"><a href="#cb86-1563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1566"><a href="#cb86-1566" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1567"><a href="#cb86-1567" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cfa</span></span>
<span id="cb86-1568"><a href="#cb86-1568" aria-hidden="true" tabindex="-1"></a><span class="co"># first partition the data </span></span>
<span id="cb86-1569"><a href="#cb86-1569" aria-hidden="true" tabindex="-1"></a>part_data <span class="ot">&lt;-</span> datawizard<span class="sc">::</span><span class="fu">data_partition</span>(dt_only_k6, <span class="at">traing_proportion =</span> .<span class="dv">07</span>, <span class="at">seed =</span> <span class="dv">123</span>)</span>
<span id="cb86-1570"><a href="#cb86-1570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1571"><a href="#cb86-1571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1572"><a href="#cb86-1572" aria-hidden="true" tabindex="-1"></a><span class="co"># set up training data</span></span>
<span id="cb86-1573"><a href="#cb86-1573" aria-hidden="true" tabindex="-1"></a>training <span class="ot">&lt;-</span> part_data<span class="sc">$</span>p_0<span class="fl">.7</span></span>
<span id="cb86-1574"><a href="#cb86-1574" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> part_data<span class="sc">$</span>test</span>
<span id="cb86-1575"><a href="#cb86-1575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1576"><a href="#cb86-1576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1577"><a href="#cb86-1577" aria-hidden="true" tabindex="-1"></a><span class="co"># one factor model</span></span>
<span id="cb86-1578"><a href="#cb86-1578" aria-hidden="true" tabindex="-1"></a>structure_k6_one <span class="ot">&lt;-</span> psych<span class="sc">::</span><span class="fu">fa</span>(training, <span class="at">nfactors =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb86-1579"><a href="#cb86-1579" aria-hidden="true" tabindex="-1"></a>  <span class="fu">efa_to_cfa</span>()</span>
<span id="cb86-1580"><a href="#cb86-1580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1581"><a href="#cb86-1581" aria-hidden="true" tabindex="-1"></a><span class="co"># two factor model model</span></span>
<span id="cb86-1582"><a href="#cb86-1582" aria-hidden="true" tabindex="-1"></a>structure_k6_two <span class="ot">&lt;-</span> psych<span class="sc">::</span><span class="fu">fa</span>(training, <span class="at">nfactors =</span> <span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb86-1583"><a href="#cb86-1583" aria-hidden="true" tabindex="-1"></a>  <span class="fu">efa_to_cfa</span>()</span>
<span id="cb86-1584"><a href="#cb86-1584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1585"><a href="#cb86-1585" aria-hidden="true" tabindex="-1"></a><span class="co"># three factor model</span></span>
<span id="cb86-1586"><a href="#cb86-1586" aria-hidden="true" tabindex="-1"></a>structure_k6_three <span class="ot">&lt;-</span> psych<span class="sc">::</span><span class="fu">fa</span>(training, <span class="at">nfactors =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb86-1587"><a href="#cb86-1587" aria-hidden="true" tabindex="-1"></a>  <span class="fu">efa_to_cfa</span>()</span>
<span id="cb86-1588"><a href="#cb86-1588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1589"><a href="#cb86-1589" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect models</span></span>
<span id="cb86-1590"><a href="#cb86-1590" aria-hidden="true" tabindex="-1"></a>structure_k6_one</span>
<span id="cb86-1591"><a href="#cb86-1591" aria-hidden="true" tabindex="-1"></a>structure_k6_two</span>
<span id="cb86-1592"><a href="#cb86-1592" aria-hidden="true" tabindex="-1"></a>structure_k6_three</span>
<span id="cb86-1593"><a href="#cb86-1593" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1594"><a href="#cb86-1594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1595"><a href="#cb86-1595" aria-hidden="true" tabindex="-1"></a>Next we perform the confirmatory factor analysis.</span>
<span id="cb86-1596"><a href="#cb86-1596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1599"><a href="#cb86-1599" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1600"><a href="#cb86-1600" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fit-models</span></span>
<span id="cb86-1601"><a href="#cb86-1601" aria-hidden="true" tabindex="-1"></a><span class="co"># fit and compare models</span></span>
<span id="cb86-1602"><a href="#cb86-1602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1603"><a href="#cb86-1603" aria-hidden="true" tabindex="-1"></a><span class="co"># one latent model</span></span>
<span id="cb86-1604"><a href="#cb86-1604" aria-hidden="true" tabindex="-1"></a>one_latent <span class="ot">&lt;-</span></span>
<span id="cb86-1605"><a href="#cb86-1605" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_one, <span class="at">data =</span> test))</span>
<span id="cb86-1606"><a href="#cb86-1606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1607"><a href="#cb86-1607" aria-hidden="true" tabindex="-1"></a><span class="co"># two latents model</span></span>
<span id="cb86-1608"><a href="#cb86-1608" aria-hidden="true" tabindex="-1"></a>two_latents <span class="ot">&lt;-</span></span>
<span id="cb86-1609"><a href="#cb86-1609" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_two, <span class="at">data =</span> test))</span>
<span id="cb86-1610"><a href="#cb86-1610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1611"><a href="#cb86-1611" aria-hidden="true" tabindex="-1"></a><span class="co"># three latents model</span></span>
<span id="cb86-1612"><a href="#cb86-1612" aria-hidden="true" tabindex="-1"></a>three_latents <span class="ot">&lt;-</span></span>
<span id="cb86-1613"><a href="#cb86-1613" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_three, <span class="at">data =</span> test))</span>
<span id="cb86-1614"><a href="#cb86-1614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1615"><a href="#cb86-1615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1616"><a href="#cb86-1616" aria-hidden="true" tabindex="-1"></a><span class="co"># compare models</span></span>
<span id="cb86-1617"><a href="#cb86-1617" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span></span>
<span id="cb86-1618"><a href="#cb86-1618" aria-hidden="true" tabindex="-1"></a>  performance<span class="sc">::</span><span class="fu">compare_performance</span>(one_latent, two_latents, three_latents, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-1619"><a href="#cb86-1619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1620"><a href="#cb86-1620" aria-hidden="true" tabindex="-1"></a><span class="co"># view as html table</span></span>
<span id="cb86-1621"><a href="#cb86-1621" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(compare) <span class="sc">|&gt;</span></span>
<span id="cb86-1622"><a href="#cb86-1622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span>
<span id="cb86-1623"><a href="#cb86-1623" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1624"><a href="#cb86-1624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1625"><a href="#cb86-1625" aria-hidden="true" tabindex="-1"></a>This table provides the results of three different Confirmatory Factor Analysis (CFA) models: one that specifies a single latent factor, one that specifies two latent factors, and one that specifies three latent factors. The results include a number of goodness-of-fit statistics, which can be used to assess how well each model fits the data.</span>
<span id="cb86-1626"><a href="#cb86-1626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1627"><a href="#cb86-1627" aria-hidden="true" tabindex="-1"></a><span class="fu">#### One_latent CFA:</span></span>
<span id="cb86-1628"><a href="#cb86-1628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1629"><a href="#cb86-1629" aria-hidden="true" tabindex="-1"></a>This model assumes that there is only one underlying latent factor contributing to all variables. This model has a chi-square statistic of 1359.7 with 14 degrees of freedom, which is highly significant (p<span class="sc">\&lt;</span>0.001), indicating a poor fit of the model to the data. Other goodness-of-fit indices like GFI, AGFI, NFI, NNFI, and CFI are all high (above 0.9), generally indicating good fit, but these indices can be misleading in the presence of large sample sizes. RMSEA is above 0.1 which indicates a poor fit. The SRMR is less than 0.08 which suggests a good fit, but given the high Chi-square and RMSEA values, we can't solely rely on this index. The Akaike information criterion (AIC), Bayesian information criterion (BIC) and adjusted BIC are used for comparing models, with lower values indicating better fit.</span>
<span id="cb86-1630"><a href="#cb86-1630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1631"><a href="#cb86-1631" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Two_latents CFA</span></span>
<span id="cb86-1632"><a href="#cb86-1632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1633"><a href="#cb86-1633" aria-hidden="true" tabindex="-1"></a>This model assumes that there are two underlying latent factors. The chi-square statistic is lower than the one-factor model (317.97 with 13 df), suggesting a better fit. The p-value is still less than 0.05, indicating a statistically significant chi-square, which typically suggests a poor fit. However, all other fit indices (GFI, AGFI, NFI, NNFI, and CFI) are above 0.9 and the RMSEA is 0.051, which generally indicate good fit. The SRMR is also less than 0.08 which suggests a good fit. This model has the lowest AIC and BIC values among the three models, indicating the best fit according to these criteria.</span>
<span id="cb86-1634"><a href="#cb86-1634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1635"><a href="#cb86-1635" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Three_latents CFA</span></span>
<span id="cb86-1636"><a href="#cb86-1636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1637"><a href="#cb86-1637" aria-hidden="true" tabindex="-1"></a>This model assumes three underlying latent factors. The chi-square statistic is 747.87 with 12 df, higher than the two-factor model, suggesting a worse fit to the data. Other fit indices such as GFI, AGFI, NFI, NNFI, and CFI are below 0.97 and the RMSEA is 0.083, which generally indicate acceptable but not excellent fit. The SRMR is less than 0.08 which suggests a good fit. The AIC and BIC values are higher than the two-factor model but lower than the one-factor model, indicating a fit that is better than the one-factor model but worse than the two-factor model.</span>
<span id="cb86-1638"><a href="#cb86-1638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1639"><a href="#cb86-1639" aria-hidden="true" tabindex="-1"></a>Based on these results, the two-latents model seems to provide the best fit to the data among the three models, according to most of the fit indices and the AIC and BIC. Note, all models have significant chi-square statistics, which suggests some degree of misfit. It's also important to consider the substantive interpretation of the factors, to make sure the model makes sense theoretically.</span>
<span id="cb86-1640"><a href="#cb86-1640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1641"><a href="#cb86-1641" aria-hidden="true" tabindex="-1"></a><span class="fu">### Multi-group Confirmatory Factor Analysis</span></span>
<span id="cb86-1642"><a href="#cb86-1642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1643"><a href="#cb86-1643" aria-hidden="true" tabindex="-1"></a>This script runs multi-group confirmatory factor analysis (MG-CFA)</span>
<span id="cb86-1644"><a href="#cb86-1644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1647"><a href="#cb86-1647" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1648"><a href="#cb86-1648" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: group_by_cfa</span></span>
<span id="cb86-1649"><a href="#cb86-1649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1650"><a href="#cb86-1650" aria-hidden="true" tabindex="-1"></a><span class="co"># select needed columns plus 'ethnicity'</span></span>
<span id="cb86-1651"><a href="#cb86-1651" aria-hidden="true" tabindex="-1"></a><span class="co"># filter dataset for only 'euro' and 'maori' ethnic categories</span></span>
<span id="cb86-1652"><a href="#cb86-1652" aria-hidden="true" tabindex="-1"></a>dt_eth_k6_eth <span class="ot">&lt;-</span> dt_start <span class="sc">|&gt;</span> </span>
<span id="cb86-1653"><a href="#cb86-1653" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eth_cat <span class="sc">==</span> <span class="st">"euro"</span> <span class="sc">|</span> eth_cat <span class="sc">==</span> <span class="st">"maori"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb86-1654"><a href="#cb86-1654" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(kessler_depressed, kessler_effort,kessler_hopeless,</span>
<span id="cb86-1655"><a href="#cb86-1655" aria-hidden="true" tabindex="-1"></a>         kessler_worthless, kessler_nervous,</span>
<span id="cb86-1656"><a href="#cb86-1656" aria-hidden="true" tabindex="-1"></a>         kessler_restless, eth_cat)</span>
<span id="cb86-1657"><a href="#cb86-1657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1658"><a href="#cb86-1658" aria-hidden="true" tabindex="-1"></a><span class="co"># partition the dataset into training and test subsets</span></span>
<span id="cb86-1659"><a href="#cb86-1659" aria-hidden="true" tabindex="-1"></a><span class="co"># stratify by ethnic category to ensure balanced representation</span></span>
<span id="cb86-1660"><a href="#cb86-1660" aria-hidden="true" tabindex="-1"></a>part_data_eth <span class="ot">&lt;-</span> datawizard<span class="sc">::</span><span class="fu">data_partition</span>(dt_eth_k6_eth, <span class="at">traing_proportion =</span> .<span class="dv">07</span>, <span class="at">seed =</span> <span class="dv">123</span>, <span class="at">group =</span> <span class="st">"eth_cat"</span>)</span>
<span id="cb86-1661"><a href="#cb86-1661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1662"><a href="#cb86-1662" aria-hidden="true" tabindex="-1"></a>training_eth <span class="ot">&lt;-</span> part_data_eth<span class="sc">$</span>p_0<span class="fl">.7</span></span>
<span id="cb86-1663"><a href="#cb86-1663" aria-hidden="true" tabindex="-1"></a>test_eth <span class="ot">&lt;-</span> part_data_eth<span class="sc">$</span>test</span>
<span id="cb86-1664"><a href="#cb86-1664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1665"><a href="#cb86-1665" aria-hidden="true" tabindex="-1"></a><span class="co"># run confirmatory factor analysis (CFA) models for configural invariance across ethnic groups</span></span>
<span id="cb86-1666"><a href="#cb86-1666" aria-hidden="true" tabindex="-1"></a><span class="co"># models specify one, two, and three latent variables</span></span>
<span id="cb86-1667"><a href="#cb86-1667" aria-hidden="true" tabindex="-1"></a>one_latent_eth_configural <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_one, <span class="at">group =</span> <span class="st">"eth_cat"</span>, <span class="at">data =</span> test_eth))</span>
<span id="cb86-1668"><a href="#cb86-1668" aria-hidden="true" tabindex="-1"></a>two_latents_eth_configural <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_two, <span class="at">group =</span> <span class="st">"eth_cat"</span>, <span class="at">data =</span> test_eth))</span>
<span id="cb86-1669"><a href="#cb86-1669" aria-hidden="true" tabindex="-1"></a>three_latents_eth_configural <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_three, <span class="at">group =</span> <span class="st">"eth_cat"</span>, <span class="at">data =</span> test_eth))</span>
<span id="cb86-1670"><a href="#cb86-1670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1671"><a href="#cb86-1671" aria-hidden="true" tabindex="-1"></a><span class="co"># compare model performances for configural invariance</span></span>
<span id="cb86-1672"><a href="#cb86-1672" aria-hidden="true" tabindex="-1"></a>compare_eth_configural <span class="ot">&lt;-</span> performance<span class="sc">::</span><span class="fu">compare_performance</span>(one_latent_eth_configural, two_latents_eth_configural, three_latents_eth_configural, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-1673"><a href="#cb86-1673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1674"><a href="#cb86-1674" aria-hidden="true" tabindex="-1"></a><span class="co"># run CFA models for metric invariance, holding factor loadings equal across groups</span></span>
<span id="cb86-1675"><a href="#cb86-1675" aria-hidden="true" tabindex="-1"></a><span class="co"># models specify one, two, and three latent variables</span></span>
<span id="cb86-1676"><a href="#cb86-1676" aria-hidden="true" tabindex="-1"></a>one_latent_eth_metric <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_one, <span class="at">group =</span> <span class="st">"eth_cat"</span>, <span class="at">group.equal =</span> <span class="st">"loadings"</span>, <span class="at">data =</span> test_eth))</span>
<span id="cb86-1677"><a href="#cb86-1677" aria-hidden="true" tabindex="-1"></a>two_latents_eth_metric  <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_two, <span class="at">group =</span> <span class="st">"eth_cat"</span>, <span class="at">group.equal =</span> <span class="st">"loadings"</span>, <span class="at">data =</span> test_eth))</span>
<span id="cb86-1678"><a href="#cb86-1678" aria-hidden="true" tabindex="-1"></a>three_latents_eth_metric  <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_three, <span class="at">group =</span> <span class="st">"eth_cat"</span>,<span class="at">group.equal =</span> <span class="st">"loadings"</span>, <span class="at">data =</span> test_eth))</span>
<span id="cb86-1679"><a href="#cb86-1679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1680"><a href="#cb86-1680" aria-hidden="true" tabindex="-1"></a><span class="co"># compare model performances for metric invariance</span></span>
<span id="cb86-1681"><a href="#cb86-1681" aria-hidden="true" tabindex="-1"></a>compare_eth_metric  <span class="ot">&lt;-</span> performance<span class="sc">::</span><span class="fu">compare_performance</span>(one_latent_eth_metric, two_latents_eth_metric, three_latents_eth_metric, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-1682"><a href="#cb86-1682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1683"><a href="#cb86-1683" aria-hidden="true" tabindex="-1"></a><span class="co"># run CFA models for scalar invariance, holding factor loadings and intercepts equal across groups</span></span>
<span id="cb86-1684"><a href="#cb86-1684" aria-hidden="true" tabindex="-1"></a><span class="co"># models specify one, two, and three latent variables</span></span>
<span id="cb86-1685"><a href="#cb86-1685" aria-hidden="true" tabindex="-1"></a>one_latent_eth_scalar <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_one, <span class="at">group =</span> <span class="st">"eth_cat"</span>, <span class="at">group.equal =</span> <span class="fu">c</span>(<span class="st">"loadings"</span>,<span class="st">"intercepts"</span>), <span class="at">data =</span> test_eth))</span>
<span id="cb86-1686"><a href="#cb86-1686" aria-hidden="true" tabindex="-1"></a>two_latents_eth_scalar  <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_two, <span class="at">group =</span> <span class="st">"eth_cat"</span>, <span class="at">group.equal =</span>  <span class="fu">c</span>(<span class="st">"loadings"</span>,<span class="st">"intercepts"</span>), <span class="at">data =</span> test_eth))</span>
<span id="cb86-1687"><a href="#cb86-1687" aria-hidden="true" tabindex="-1"></a>three_latents_eth_scalar  <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(lavaan<span class="sc">::</span><span class="fu">cfa</span>(structure_k6_three, <span class="at">group =</span> <span class="st">"eth_cat"</span>,<span class="at">group.equal =</span>  <span class="fu">c</span>(<span class="st">"loadings"</span>,<span class="st">"intercepts"</span>), <span class="at">data =</span> test_eth))</span>
<span id="cb86-1688"><a href="#cb86-1688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1689"><a href="#cb86-1689" aria-hidden="true" tabindex="-1"></a><span class="co"># compare model performances for scalar invariance</span></span>
<span id="cb86-1690"><a href="#cb86-1690" aria-hidden="true" tabindex="-1"></a>compare_eth_scalar  <span class="ot">&lt;-</span> performance<span class="sc">::</span><span class="fu">compare_performance</span>(one_latent_eth_scalar, two_latents_eth_scalar, three_latents_eth_scalar, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-1691"><a href="#cb86-1691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1692"><a href="#cb86-1692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1693"><a href="#cb86-1693" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1694"><a href="#cb86-1694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1695"><a href="#cb86-1695" aria-hidden="true" tabindex="-1"></a>Recall, in the context of measurement and factor analysis, the concepts of *configural*, *metric*, and *scalar invariance* relate to the comparability of a measurement instrument, such as a survey or test, across different groups.</span>
<span id="cb86-1696"><a href="#cb86-1696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1697"><a href="#cb86-1697" aria-hidden="true" tabindex="-1"></a>We saw in part 1 of this course that these invariance concepts are frequently tested in the context of cross-cultural, multi-group, or longitudinal studies.</span>
<span id="cb86-1698"><a href="#cb86-1698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1699"><a href="#cb86-1699" aria-hidden="true" tabindex="-1"></a>Let's first define these concepts, and then apply them to the context of the Kessler 6 (K6) Distress Scale used among Maori and New Zealand Europeans.</span>
<span id="cb86-1700"><a href="#cb86-1700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1701"><a href="#cb86-1701" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Configural invariance** refers to the most basic level of measurement invariance, and it is established when the same pattern of factor loadings and structure is observed across groups. This means that the underlying or "latent" constructs (factors) are defined the same way for different groups. This doesn't mean the strength of relationship between items and factors (loadings) or the item means (intercepts) are the same, just that the items relate to the same factors in all groups.</span>
<span id="cb86-1702"><a href="#cb86-1702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1703"><a href="#cb86-1703" aria-hidden="true" tabindex="-1"></a>In the context of the K6 Distress Scale, configural invariance would suggest that the same six items are measuring the construct of psychological distress in the same way for both Māori and New Zealand Europeans, even though the strength of the relationship between the items and the construct (distress), or the average scores, might differ.</span>
<span id="cb86-1704"><a href="#cb86-1704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1705"><a href="#cb86-1705" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Metric invariance** (also known as "weak invariance") refers to the assumption that factor loadings are equivalent across groups, meaning that the relationship or association between the measured items and their underlying factor is the same in all groups. This is important when comparing the strength of relationships with other variables across groups.</span>
<span id="cb86-1706"><a href="#cb86-1706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1707"><a href="#cb86-1707" aria-hidden="true" tabindex="-1"></a>If metric invariance holds for the K6 Distress Scale, this would mean that a unit change in the latent distress factor would correspond to the same change in each item score (e.g., feeling nervous, hopeless, restless, etc.) for both Māori and New Zealand Europeans.</span>
<span id="cb86-1708"><a href="#cb86-1708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1709"><a href="#cb86-1709" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Scalar invariance** (also known as "strong invariance") involves equivalence of both factor loadings and intercepts (item means) across groups. This means that not only are the relationships between the items and the factors the same across groups (as with metric invariance), but also the zero-points or origins of the scales are the same. Scalar invariance is necessary when one wants to compare latent mean scores across groups.</span>
<span id="cb86-1710"><a href="#cb86-1710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1711"><a href="#cb86-1711" aria-hidden="true" tabindex="-1"></a>In the context of the K6 Distress Scale, if scalar invariance holds, it would mean that a specific score on the scale would correspond to the same level of the underlying distress factor for both Māori and New Zealand Europeans. It would mean that the groups do not differ systematically in how they interpret and respond to the items. If this holds, one can make meaningful comparisons of distress level between Maori and New Zealand Europeans based on the scale scores.</span>
<span id="cb86-1712"><a href="#cb86-1712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1713"><a href="#cb86-1713" aria-hidden="true" tabindex="-1"></a>Note: each of these levels of invariance is a progressively stricter test of the equivalence of the measurement instrument across groups. Demonstrating scalar invariance, for example, also demonstrates configural and metric invariance. On the other hand, failure to demonstrate metric invariance means that scalar invariance also does not hold. These tests are therefore usually conducted in sequence. The results of these tests should be considered when comparing group means or examining the relationship between a scale and other variables across groups.</span>
<span id="cb86-1714"><a href="#cb86-1714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1715"><a href="#cb86-1715" aria-hidden="true" tabindex="-1"></a><span class="fu">### Configural invariance</span></span>
<span id="cb86-1716"><a href="#cb86-1716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1719"><a href="#cb86-1719" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1720"><a href="#cb86-1720" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(compare_eth_configural)<span class="sc">|&gt;</span></span>
<span id="cb86-1721"><a href="#cb86-1721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span>
<span id="cb86-1722"><a href="#cb86-1722" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1723"><a href="#cb86-1723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1724"><a href="#cb86-1724" aria-hidden="true" tabindex="-1"></a>The table represents the comparison of three multi-group confirmatory factor analysis (CFA) models conducted to test for configural invariance across different ethnic categories (eth_cat). Configural invariance refers to whether the pattern of factor loadings is the same across groups. It's the most basic form of measurement invariance.</span>
<span id="cb86-1725"><a href="#cb86-1725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1726"><a href="#cb86-1726" aria-hidden="true" tabindex="-1"></a>Looking at the results, we can draw the following conclusions:</span>
<span id="cb86-1727"><a href="#cb86-1727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1728"><a href="#cb86-1728" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Chi2 (Chi-square)**: A lower value suggests a better model fit. In this case, the two_latents_eth_configural model exhibits the lowest Chi2 value, suggesting it has the best fit according to this metric.</span>
<span id="cb86-1729"><a href="#cb86-1729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1730"><a href="#cb86-1730" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**GFI (Goodness of Fit Index) and AGFI (Adjusted Goodness of Fit Index)**: These values range from 0 to 1, with values closer to 1 suggesting a better fit. The two_latents_eth_configural model has the highest GFI and AGFI values, indicating it is the best fit according to these indices.</span>
<span id="cb86-1731"><a href="#cb86-1731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1732"><a href="#cb86-1732" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**NFI (Normed Fit Index), NNFI (Non-Normed Fit Index, also called TLI), CFI (Comparative Fit Index)**: These range from 0 to 1, with values closer to 1 suggesting a better fit. The one_latent_eth_configural model has the highest values, suggesting it is the best fit according to these metrics.</span>
<span id="cb86-1733"><a href="#cb86-1733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1734"><a href="#cb86-1734" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**RMSEA (Root Mean Square Error of Approximation)**: Lower values are better, with values below 0.05 considered good and up to 0.08 considered acceptable. In this table, the two_latents_eth_configural model has an RMSEA of 0.05, which falls within the acceptable range.</span>
<span id="cb86-1735"><a href="#cb86-1735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1736"><a href="#cb86-1736" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>**RMR (Root Mean Square Residual) and SRMR (Standardized Root Mean Square Residual)**: Lower values are better, typically less than 0.08 is considered a good fit. All models exhibit acceptable RMR and SRMR values, with the two_latents_eth_configural model having the lowest.</span>
<span id="cb86-1737"><a href="#cb86-1737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1738"><a href="#cb86-1738" aria-hidden="true" tabindex="-1"></a><span class="ss">6.  </span>**RFI (Relative Fit Index), PNFI (Parsimonious Normed Fit Index), IFI (Incremental Fit Index), RNI (Relative Noncentrality Index)**: These range from 0 to 1, with values closer to 1 suggesting a better fit. The one_latent_eth_configural model has the highest values, suggesting the best fit according to these measures.</span>
<span id="cb86-1739"><a href="#cb86-1739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1740"><a href="#cb86-1740" aria-hidden="true" tabindex="-1"></a><span class="ss">7.  </span>**AIC (Akaike Information Criterion) and BIC (Bayesian Information Criterion)**: Lower values indicate a better fit when comparing models. The two_latents_eth_configural model has the lowest AIC and BIC, suggesting it is the best fit according to these criteria.</span>
<span id="cb86-1741"><a href="#cb86-1741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1742"><a href="#cb86-1742" aria-hidden="true" tabindex="-1"></a><span class="ss">8.  </span>**p_Chi2 and p_RMSEA**: These are the significance levels for the Chi-square test and the RMSEA, respectively. Non-significant values (p <span class="sc">\&gt;</span> 0.05) suggest a good fit. Only the RMSEA for the two_latents_eth_configural model is non-significant, suggesting a good fit.</span>
<span id="cb86-1743"><a href="#cb86-1743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1744"><a href="#cb86-1744" aria-hidden="true" tabindex="-1"></a>Overall, the two_latents_eth_configural model appears to provide the best fit across multiple indices, suggesting configural invariance (i.e., the same general factor structure) across ethnic categories with a two-factor solution. As with the previous assessment, theoretical soundness and other substantive considerations should also be taken into account when deciding on the final model. We will return to these issues next week.</span>
<span id="cb86-1745"><a href="#cb86-1745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1746"><a href="#cb86-1746" aria-hidden="true" tabindex="-1"></a><span class="fu">### Metric Equivalence</span></span>
<span id="cb86-1747"><a href="#cb86-1747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1750"><a href="#cb86-1750" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1751"><a href="#cb86-1751" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(compare_eth_metric)<span class="sc">|&gt;</span></span>
<span id="cb86-1752"><a href="#cb86-1752" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span>
<span id="cb86-1753"><a href="#cb86-1753" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1754"><a href="#cb86-1754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1755"><a href="#cb86-1755" aria-hidden="true" tabindex="-1"></a>This table presents the results of a multi-group confirmatory factor analysis (CFA) conducted to test metric equivalence (also known as measurement invariance) across different ethnic categories (eth_cat). The models (one_latent_eth_metric, two_latents_eth_metric, three_latents_eth_metric) were run with a constraint of equal factor loadings across groups, which is a requirement for metric invariance.</span>
<span id="cb86-1756"><a href="#cb86-1756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1757"><a href="#cb86-1757" aria-hidden="true" tabindex="-1"></a>Here's the interpretation of the fit indices:</span>
<span id="cb86-1758"><a href="#cb86-1758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1759"><a href="#cb86-1759" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Chi2 (Chi-square)**: Lower values indicate better model fit. The two_latents_eth_metric model has the lowest Chi2 value, suggesting the best fit according to this measure.</span>
<span id="cb86-1760"><a href="#cb86-1760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1761"><a href="#cb86-1761" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**GFI (Goodness of Fit Index), AGFI (Adjusted Goodness of Fit Index)**: These range from 0 to 1, with values closer to 1 indicating a better fit. The two_latents_eth_metric model has the highest GFI and AGFI values, suggesting the best fit according to these indices.</span>
<span id="cb86-1762"><a href="#cb86-1762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1763"><a href="#cb86-1763" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**NFI (Normed Fit Index), NNFI (Non-Normed Fit Index, or TLI), CFI (Comparative Fit Index)**: These range from 0 to 1, with values closer to 1 indicating a better fit. For these indices, the one_latent_eth_metric model has the highest values, suggesting the best fit according to these measures.</span>
<span id="cb86-1764"><a href="#cb86-1764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1765"><a href="#cb86-1765" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**RMSEA (Root Mean Square Error of Approximation)**: Lower values are better, with values below 0.05 generally considered good, and values up to 0.08 considered acceptable. Only the two_latents_eth_metric model has an RMSEA within the acceptable range (0.051).</span>
<span id="cb86-1766"><a href="#cb86-1766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1767"><a href="#cb86-1767" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>**RMR (Root Mean Square Residual) and SRMR (Standardized Root Mean Square Residual)**: Lower values are better, typically less than 0.08 is considered a good fit. All models have acceptable RMR and SRMR values, with the two_latents_eth_metric model having the lowest, indicating the best fit.</span>
<span id="cb86-1768"><a href="#cb86-1768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1769"><a href="#cb86-1769" aria-hidden="true" tabindex="-1"></a><span class="ss">6.  </span>**RFI (Relative Fit Index), PNFI (Parsimonious Normed Fit Index), IFI (Incremental Fit Index), RNI (Relative Noncentrality Index)**: These range from 0 to 1, with values closer to 1 indicating better fit. The one_latent_eth_metric model has the highest values, suggesting the best fit according to these indices.</span>
<span id="cb86-1770"><a href="#cb86-1770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1771"><a href="#cb86-1771" aria-hidden="true" tabindex="-1"></a><span class="ss">7.  </span>**AIC (Akaike Information Criterion) and BIC (Bayesian Information Criterion)**: Lower values indicate a better fit when comparing models. The two_latents_eth_metric model has the lowest AIC and BIC, indicating the best fit according to these criteria.</span>
<span id="cb86-1772"><a href="#cb86-1772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1773"><a href="#cb86-1773" aria-hidden="true" tabindex="-1"></a><span class="ss">8.  </span>**p_Chi2 and p_RMSEA**: These are the significance levels for the Chi-square test and the RMSEA, respectively. Statistically non-significant values at the traditional threshold (p <span class="sc">\&gt;</span> 0.05) suggest a good fit. Only the RMSEA for the two_latents_eth_metric model is statistically non-significant, suggesting a good fit.</span>
<span id="cb86-1774"><a href="#cb86-1774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1775"><a href="#cb86-1775" aria-hidden="true" tabindex="-1"></a>In summary, the two_latents_eth_metric model appears to provide the best fit overall, indicating that a two-factor solution might be appropriate and that the metric equivalence (equal factor loadings) assumption is supported across ethnic categories. However, one must also take into consideration the theoretical soundness of the model and other substantive considerations when deciding on the final model.</span>
<span id="cb86-1776"><a href="#cb86-1776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1777"><a href="#cb86-1777" aria-hidden="true" tabindex="-1"></a><span class="fu">### Scalar Equivalence</span></span>
<span id="cb86-1778"><a href="#cb86-1778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1781"><a href="#cb86-1781" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1782"><a href="#cb86-1782" aria-hidden="true" tabindex="-1"></a><span class="co"># view as html table</span></span>
<span id="cb86-1783"><a href="#cb86-1783" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(compare_eth_scalar)<span class="sc">|&gt;</span></span>
<span id="cb86-1784"><a href="#cb86-1784" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span>
<span id="cb86-1785"><a href="#cb86-1785" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1786"><a href="#cb86-1786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1787"><a href="#cb86-1787" aria-hidden="true" tabindex="-1"></a>The table presents the results of a multi-group confirmatory factor analysis (CFA) conducted to test scalar equivalence (also known as measurement invariance) across different ethnic categories (eth_cat). The models (one_latent_eth_scalar, two_latents_eth_scalar, three_latents_eth_scalar) were run with constraints on both factor loadings and intercepts to be equal across groups, a requirement for scalar invariance.</span>
<span id="cb86-1788"><a href="#cb86-1788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1789"><a href="#cb86-1789" aria-hidden="true" tabindex="-1"></a>Here's the interpretation of the fit indices:</span>
<span id="cb86-1790"><a href="#cb86-1790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1791"><a href="#cb86-1791" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Chi2 (Chi-square)**: Lower values indicate better model fit. The two_latents_eth_scalar model has the lowest Chi2 value, suggesting the best fit according to this measure.</span>
<span id="cb86-1792"><a href="#cb86-1792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1793"><a href="#cb86-1793" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**GFI (Goodness of Fit Index), AGFI (Adjusted Goodness of Fit Index)**: These range from 0 to 1, with values closer to 1 indicating a better fit. The two_latents_eth_scalar model has the highest GFI and AGFI values, suggesting the best fit according to these indices.</span>
<span id="cb86-1794"><a href="#cb86-1794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1795"><a href="#cb86-1795" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**NFI (Normed Fit Index), NNFI (Non-Normed Fit Index, or TLI), CFI (Comparative Fit Index)**: These range from 0 to 1, with values closer to 1 indicating a better fit. The one_latent_eth_scalar model has the highest values, suggesting the best fit according to these measures.</span>
<span id="cb86-1796"><a href="#cb86-1796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1797"><a href="#cb86-1797" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**RMSEA (Root Mean Square Error of Approximation)**: Lower values are better, with values below 0.05 generally considered good, and values up to 0.08 considered acceptable. Only the two_latents_eth_scalar model has an RMSEA within the acceptable range (0.05).</span>
<span id="cb86-1798"><a href="#cb86-1798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1799"><a href="#cb86-1799" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>**RMR (Root Mean Square Residual) and SRMR (Standardized Root Mean Square Residual)**: Lower values are better, typically less than 0.08 is considered a good fit. All models have acceptable RMR and SRMR values, with the two_latents_eth_scalar model having the lowest, indicating the best fit.</span>
<span id="cb86-1800"><a href="#cb86-1800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1801"><a href="#cb86-1801" aria-hidden="true" tabindex="-1"></a><span class="ss">6.  </span>**RFI (Relative Fit Index), PNFI (Parsimonious Normed Fit Index), IFI (Incremental Fit Index), RNI (Relative Noncentrality Index)**: These range from 0 to 1, with values closer to 1 indicating better fit. The one_latent_eth_scalar model has the highest values, suggesting the best fit according to these indices.</span>
<span id="cb86-1802"><a href="#cb86-1802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1803"><a href="#cb86-1803" aria-hidden="true" tabindex="-1"></a><span class="ss">7.  </span>**AIC (Akaike Information Criterion) and BIC (Bayesian Information Criterion)**: Lower values indicate a better fit when comparing models. The two_latents_eth_scalar model has the lowest AIC and BIC, indicating the best fit according to these criteria.</span>
<span id="cb86-1804"><a href="#cb86-1804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1805"><a href="#cb86-1805" aria-hidden="true" tabindex="-1"></a><span class="ss">8.  </span>**p_Chi2 and p_RMSEA**: These are the significance levels for the Chi-square test and the RMSEA, respectively. Non-significant values (p <span class="sc">\&gt;</span> 0.05) suggest a good fit. Only the RMSEA for the two_latents_eth_scalar model is non-significant, suggesting a good fit.</span>
<span id="cb86-1806"><a href="#cb86-1806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1807"><a href="#cb86-1807" aria-hidden="true" tabindex="-1"></a>In summary, the two_latents_eth_scalar model appears to provide the best fit overall, indicating that a two-factor solution might be appropriate and that the scalar equivalence (equal factor loadings and intercepts) assumption is supported across ethnic categories. However, we must also consider the theoretical soundness of the model and other substantive considerations when deciding on the final model (a matter to which we will return next week.)</span>
<span id="cb86-1808"><a href="#cb86-1808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1809"><a href="#cb86-1809" aria-hidden="true" tabindex="-1"></a>Overall it seems that we have good evidence for the two-factor model of Kessler-6.</span>
<span id="cb86-1810"><a href="#cb86-1810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1811"><a href="#cb86-1811" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solutions</span></span>
<span id="cb86-1812"><a href="#cb86-1812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1813"><a href="#cb86-1813" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Generate a Kessler 6 binary score (Not Depressed vs. Moderately or Severely Depressed)</span>
<span id="cb86-1814"><a href="#cb86-1814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1815"><a href="#cb86-1815" aria-hidden="true" tabindex="-1"></a>and also:</span>
<span id="cb86-1816"><a href="#cb86-1816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1817"><a href="#cb86-1817" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Create a variable for the log of exercise hour</span>
<span id="cb86-1818"><a href="#cb86-1818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1821"><a href="#cb86-1821" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb86-1822"><a href="#cb86-1822" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: exercise_1_2</span></span>
<span id="cb86-1823"><a href="#cb86-1823" aria-hidden="true" tabindex="-1"></a><span class="co"># functions </span></span>
<span id="cb86-1824"><a href="#cb86-1824" aria-hidden="true" tabindex="-1"></a><span class="co">#source("https://raw.githubusercontent.com/go-bayes/templates/main/functions/funs.R")</span></span>
<span id="cb86-1825"><a href="#cb86-1825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1826"><a href="#cb86-1826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1827"><a href="#cb86-1827" aria-hidden="true" tabindex="-1"></a><span class="co"># experimental functions (more functions)</span></span>
<span id="cb86-1828"><a href="#cb86-1828" aria-hidden="true" tabindex="-1"></a><span class="co">#source(</span></span>
<span id="cb86-1829"><a href="#cb86-1829" aria-hidden="true" tabindex="-1"></a> <span class="co"># "https://raw.githubusercontent.com/go-bayes/templates/main/functions/experimental_funs.R"</span></span>
<span id="cb86-1830"><a href="#cb86-1830" aria-hidden="true" tabindex="-1"></a><span class="co">#)</span></span>
<span id="cb86-1831"><a href="#cb86-1831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1832"><a href="#cb86-1832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1833"><a href="#cb86-1833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1834"><a href="#cb86-1834" aria-hidden="true" tabindex="-1"></a>nzavs_synth <span class="ot">&lt;-</span></span>
<span id="cb86-1835"><a href="#cb86-1835" aria-hidden="true" tabindex="-1"></a>  arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"nzavs_dat_synth_t10_t12"</span>))</span>
<span id="cb86-1836"><a href="#cb86-1836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1837"><a href="#cb86-1837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1838"><a href="#cb86-1838" aria-hidden="true" tabindex="-1"></a>dt_new <span class="ot">&lt;-</span> nzavs_synth <span class="sc">%&gt;%</span></span>
<span id="cb86-1839"><a href="#cb86-1839" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">%&gt;%</span></span>
<span id="cb86-1840"><a href="#cb86-1840" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-1841"><a href="#cb86-1841" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">kessler_6  =</span> <span class="fu">mean</span>(<span class="fu">sum</span>(</span>
<span id="cb86-1842"><a href="#cb86-1842" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Specify the Kessler scale items</span></span>
<span id="cb86-1843"><a href="#cb86-1843" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb86-1844"><a href="#cb86-1844" aria-hidden="true" tabindex="-1"></a>      kessler_depressed,</span>
<span id="cb86-1845"><a href="#cb86-1845" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel so depressed that nothing could cheer you up?</span></span>
<span id="cb86-1846"><a href="#cb86-1846" aria-hidden="true" tabindex="-1"></a>      kessler_hopeless,</span>
<span id="cb86-1847"><a href="#cb86-1847" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel hopeless?</span></span>
<span id="cb86-1848"><a href="#cb86-1848" aria-hidden="true" tabindex="-1"></a>      kessler_nervous,</span>
<span id="cb86-1849"><a href="#cb86-1849" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel nervous?</span></span>
<span id="cb86-1850"><a href="#cb86-1850" aria-hidden="true" tabindex="-1"></a>      kessler_effort,</span>
<span id="cb86-1851"><a href="#cb86-1851" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel that everything was an effort?</span></span>
<span id="cb86-1852"><a href="#cb86-1852" aria-hidden="true" tabindex="-1"></a>      kessler_restless,</span>
<span id="cb86-1853"><a href="#cb86-1853" aria-hidden="true" tabindex="-1"></a>      <span class="co"># During the last 30 days, how often did you feel restless or fidgety ?</span></span>
<span id="cb86-1854"><a href="#cb86-1854" aria-hidden="true" tabindex="-1"></a>      kessler_worthless  <span class="co"># During the last 30 days, how often did you feel worthless?</span></span>
<span id="cb86-1855"><a href="#cb86-1855" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-1856"><a href="#cb86-1856" aria-hidden="true" tabindex="-1"></a>  ))) <span class="sc">|&gt;</span></span>
<span id="cb86-1857"><a href="#cb86-1857" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">kessler_6_sum =</span> <span class="fu">round</span>(<span class="fu">sum</span>(</span>
<span id="cb86-1858"><a href="#cb86-1858" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span> (</span>
<span id="cb86-1859"><a href="#cb86-1859" aria-hidden="true" tabindex="-1"></a>      kessler_depressed,</span>
<span id="cb86-1860"><a href="#cb86-1860" aria-hidden="true" tabindex="-1"></a>      kessler_hopeless,</span>
<span id="cb86-1861"><a href="#cb86-1861" aria-hidden="true" tabindex="-1"></a>      kessler_nervous,</span>
<span id="cb86-1862"><a href="#cb86-1862" aria-hidden="true" tabindex="-1"></a>      kessler_effort,</span>
<span id="cb86-1863"><a href="#cb86-1863" aria-hidden="true" tabindex="-1"></a>      kessler_restless,</span>
<span id="cb86-1864"><a href="#cb86-1864" aria-hidden="true" tabindex="-1"></a>      kessler_worthless</span>
<span id="cb86-1865"><a href="#cb86-1865" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-1866"><a href="#cb86-1866" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb86-1867"><a href="#cb86-1867" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">0</span>)) <span class="sc">|&gt;</span>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb86-1868"><a href="#cb86-1868" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a categorical variable 'kessler_6_coarsen' based on the sum of Kessler scale items</span></span>
<span id="cb86-1869"><a href="#cb86-1869" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb86-1870"><a href="#cb86-1870" aria-hidden="true" tabindex="-1"></a>    <span class="at">kessler_6_coarsen =</span> <span class="fu">cut</span>(</span>
<span id="cb86-1871"><a href="#cb86-1871" aria-hidden="true" tabindex="-1"></a>      kessler_6_sum,</span>
<span id="cb86-1872"><a href="#cb86-1872" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">24</span>),</span>
<span id="cb86-1873"><a href="#cb86-1873" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"not_depressed"</span>,</span>
<span id="cb86-1874"><a href="#cb86-1874" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"mildly_to_severely_depressed"</span>),</span>
<span id="cb86-1875"><a href="#cb86-1875" aria-hidden="true" tabindex="-1"></a>      <span class="at">include.lowest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb86-1876"><a href="#cb86-1876" aria-hidden="true" tabindex="-1"></a>      <span class="at">include.highest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb86-1877"><a href="#cb86-1877" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb86-1878"><a href="#cb86-1878" aria-hidden="true" tabindex="-1"></a>      <span class="at">right =</span> <span class="cn">FALSE</span></span>
<span id="cb86-1879"><a href="#cb86-1879" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-1880"><a href="#cb86-1880" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb86-1881"><a href="#cb86-1881" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform 'hours_exercise' by applying the log function to compress its scale</span></span>
<span id="cb86-1882"><a href="#cb86-1882" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hours_exercise_log =</span> <span class="fu">log</span>(hours_exercise <span class="sc">+</span> <span class="dv">1</span>)) <span class="co"># Add 1 to avoid undefined log(0). Hours spent exercising/physical activity</span></span>
<span id="cb86-1883"><a href="#cb86-1883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1884"><a href="#cb86-1884" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb86-1885"><a href="#cb86-1885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1886"><a href="#cb86-1886" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Take Home: estimate whether exercise causally affects nervousness, using the single item of the kessler 6 score. Briefly write up your results.</span>
<span id="cb86-1887"><a href="#cb86-1887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-1888"><a href="#cb86-1888" aria-hidden="true" tabindex="-1"></a>*To be reviewed next week.*</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>