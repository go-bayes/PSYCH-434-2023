---
title: "Temporal Causal Diagrams: Unveiling Causal Order and Indexing Nodes by Time"
execute:
  warning: false
code_folding: true
echo: true
draft: false
author:
  - name: Joseph Bulbulia
orcid: 0000-0002-5861-2056
affiliation: Victoria University of Wellington, New Zealand
email: joseph.bulbulia@vuw.ac.nz
corresponding: yes
date-format: short
sanitize: true
keep-tex: false
editor_options: 
  chunk_output_type: inline
---




## Common Causal Graphs

```{r}
#| include: false
#| echo: false
#read libraries

library("tinytex")
library(extrafont)
loadfonts(device = "all")

# read libraries
source("/Users/joseph/GIT/templates/functions/libs2.R")

# read functions
#source("/Users/joseph/GIT/templates/functions/funs.R")
```


## Graphs of Canonical confounders


### Confounding by Common Cause. 


The problem of confounding by common cause arises when there is an unmeasured or unaccounted-for variable, denoted as "L," that influences both the treatment variable, denoted as "A," and the outcome variable, denoted as "Y." This confounder L creates an association between A and Y that is not solely due to the direct causal effect of A on Y. Instead, the observed association between A and Y may be partially or entirely driven by the presence of L, making it difficult to isolate and accurately estimate the true causal effect of A on Y.

```{tikz}
#| label: fig-dag-common-cause
#| fig-cap: "Counfounding by common cause."
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}


\begin{tikzpicture}[{every node/.append style}=draw]
\node [ellipse, draw=white] (L) at (0, 0) {t0/L};
\node [rectangle, draw=white] (A) at (4, 0) {t1/A};
\node [rectangle, draw=white] (Y) at (8, 0) {t2/Y};
\draw [-latex, draw=red, dashed] (A) to (Y);
\draw [-latex, bend left, draw =black] (L) to (Y);
\draw [-latex, black] (L) to (A);
\end{tikzpicture}
```



### Solution: adjust for the pre-exposure confounder

Confounding by a pre-exposure confounder can be addressed by adjusting for it. A pre-exposure confounder refers to a variable that affects both the treatment (A) and the outcome (Y) but is measured before the treatment is assigned. By adjusting for this confounder, typically through statistical techniques such as stratification, regression, or matching, we can account for its influence and isolate the true causal effect of the treatment on the outcome. This adjustment helps to mitigate the bias caused by the confounder, allowing for a more accurate estimation of the causal relationship between the treatment and the outcome.

```{tikz}
#| label: fig-dag-common-cause-solution
#| fig-cap: "Solution: adjust for pre-exposure confounder."
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}


\begin{tikzpicture}[{every node/.append style}=draw]
\node [rectangle, draw=black] (L) at (0, 0) {t0/L};
\node [ellipse, draw=white] (A) at (4, 0) {t1/A};
\node [rectangle, draw=white] (Y) at (8, 0) {t2/Y};
\draw [-latex, draw=white] (A) to (Y);
\draw [-latex, bend left, draw =black] (L) to (Y);
\draw [-latex, black] (L) to (A);
\end{tikzpicture}

```


### Second problem: conditioning on a common effect (Collider Stratification)

Conditioning on a common effect refers to a situation where there is a variable, denoted as "L," that is affected by both the treatment (A) and an outcome (Y). When conditioning on L, it creates a spurious association between A and Y, making it challenging to determine the true causal relationship. This occurs because the relationship between A and Y becomes confounded by the common effect L. Conditioning on L can lead to biased estimates and erroneous conclusions about the causal effect of A on Y, as the observed association may be solely driven by the influence of L.

```{tikz}
#| label: fig-dag-common-effect
#| fig-cap: "Solution: ensure confounder is measured prior to the exposure."
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}


\begin{tikzpicture}[{every node/.append style}=draw]
\node [rectangle, draw=white] (A) at (0, 0) {t0/A};
\node [ellipse, draw=white] (Y) at (4, 0) {t1/Y};
\node [rectangle, draw=black] (L) at (8, 0) {t1*/L};
\draw [-latex, draw=black, bend right] (A) to (L);
\draw [-latex, draw=black] (Y) to (L);
\draw [-latex, draw=red, dashed] (A) to (Y);

\end{tikzpicture}

```



### Solution: ensure confounders are measured before the exposure


To address the problem of conditioning on a common effect, it is crucial to measure all potential confounders before the exposure (A). By measuring confounders prior to exposure, we can ensure that they are not influenced by A and therefore do not lie on the causal pathway between A and Y. This approach allows for proper adjustment and control of confounding variables, ensuring that the estimated causal effect of A on Y is not distorted by conditioning on the common effect L. By measuring all relevant confounders in advance, researchers can minimize bias and obtain more reliable estimates of the true causal relationship between A and Y.


```{tikz}
#| label: fig-dag-common-effect-solution
#| fig-cap: "Causal graph reveals bias: solve by stratification"
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}


\begin{tikzpicture}[{every node/.append style}=draw]
\node [rectangle, draw=black] (L) at (0, 0) {t0/L};
\node [ellipse, draw=white] (A) at (4, 0) {t1/A};
\node [rectangle, draw=white] (Y) at (8, 0) {t2/Y};
\draw [-latex, draw=white] (A) to (Y);
\draw [-latex, bend left, draw =black] (L) to (Y);
\draw [-latex, black] (L) to (A);
\end{tikzpicture}



```



### Third problem: conditioning on a mediator 

Conditioning on a mediator refers to a situation where a variable, known as the mediator (L), lies on the causal pathway between the treatment (A) and the outcome (Y). When conditioning on M, it can lead to biased estimates of the direct causal effect of A on Y. This occurs because conditioning on L may block or distort the true causal pathway between A and Y, making it challenging to isolate the direct effect of A on Y. 


```{tikz}
#| label: fig-dag-mediator
#| fig-cap: "Third problem: conditioning on a mediator."
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}


\begin{tikzpicture}[{every node/.append style}=draw]
\node [ellipse, draw=white] (A) at (0, 0) {t0/A};
\node [rectangle, draw=black] (L) at (4, 0) {t1/L};
\node [rectangle, draw=white] (Y) at (8, 0) {t2/Y};
\draw [-latex, bend left, draw=black, dotted] (A) to (Y);
\draw [-latex, draw =black] (L) to (Y);
\draw [-latex, black] (A) to (L);
\end{tikzpicture}
```



### Solution: ensure confounders are measured before the exposure.

To address the problem of mediator bias, do not condition on a mediator. Ensure that L occurs before A (and Y). This will set you on the path to grace. 

```{tikz}
#| label: fig-dag-mediator-solution
#| fig-cap: "Do not condition on a mediator"
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}

\begin{tikzpicture}[{every node/.append style}=draw]
\node [rectangle, draw=black] (L) at (0, 0) {t0/L};
\node [ellipse, draw=white] (A) at (4, 0) {t1/A};
\node [rectangle, draw=white] (Y) at (8, 0) {t2/Y};
\draw [-latex, draw=white] (A) to (Y);
\draw [-latex, bend left, draw =black] (L) to (Y);
\draw [-latex, black] (L) to (A);
\end{tikzpicture}


```


### Fourth problem: conditioning on a descendant


The problem of confounding by conditioning on a descendant arises when there is a confounder L that is caused by an unobserved variable U, occurring after the exposure A. Additionally, U also causes the outcome Y, which occurs after L. While A causes L, it does not directly cause Y, and U does not cause A. In this scenario, conditioning on L, which is a descendant of A, can lead to bias. This is because conditioning on L may introduce an association between A and Y that arise from A to L and through the backdoorpath from L through U to Y. 

```{tikz}
#| label: fig-dag-descendent
#| fig-cap: "Conditioning on a descendant"
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}

\begin{tikzpicture}[{every node/.append style}=draw]

\node [rectangle, draw=white] (U) at (0, 0) {U};
\node [ellipse, draw=white] (A) at (2, 0) {t0/A};
\node [rectangle, draw=black](L) at (4, 0) {t1/L};
\node [ellipse, draw=white] (Y) at (6, 0) {t2/Y};

\draw [-latex, bend right=50] (U) to (L);
\draw [-latex, bend left, draw=black] (U) to (Y);
\draw [-latex,draw=black] (A) to (L);
\draw [-latex, bend left, draw=red, dashed] (A) to (Y);

\end{tikzpicture}

```


### Solution: (yet again) ensure that counfounders are measured before the exposure


Ensuring the confounder (L) is measured before the exposure (A) has two beneficial properties. Firstly, it rules out collider bias, which occurs when conditioning on a collider (L) introduces spurious associations. Secondly, if an unmeasured confounder is associated with both A, Y, and L, adjusting for L helps reduce confounding caused by the unmeasured confounder. By measuring L before A, these advantages can be achieved, allowing for more accurate estimation of the causal effect of A on Y.

```{tikz}
#| label: fig-dag-descendent-solution
#| fig-cap: "Solution: conditioning on a descendent is part of the solution, not the problem, when baseline confounders are measured before the exposure."
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}

\begin{tikzpicture}[{every node/.append style}=draw]


\node [rectangle, draw=white] (U) at (0, 0) {U};
\node [rectangle, draw=black] (L) at (2, 0) {t0/L};
\node [rectangle, draw=white](A) at (4, 0) {t1/A};
\node [ellipse, draw=white] (Y) at (6, 0) {t2/Y};

\draw [-latex, draw=black] (U) to (L);
\draw [-latex, draw=black] (L) to (A);
\draw [-latex, draw=blue, dotted] (A) to (Y);
\draw [-latex, bend left=50, draw =black] (L) to (Y);
\draw [-latex, bend right=50, draw =black, dotted] (U) to (Y);
\draw [-latex, bend left=50, draw =black, dotted] (U) to (A);

\end{tikzpicture}

```

## EXAMPLES 


### Common cause of exposure and outcome. 


```{tikz}
#| label: fig-dag-1
#| fig-cap: "Common cause of exposure and outcome: example"
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}


\begin{tikzpicture}[{every node/.append style}=draw]
\node [ellipse, draw=white] (L) at (0, 0) {t0/Male};
\node [rectangle, draw=white] (A) at (4, 0) {t1/DoctorVisit};
\node [rectangle, draw=white] (Y) at (8, 0) {t2/Heart Attack};
\draw [-latex, draw=red, dashed] (A) to (Y);
\draw [-latex, bend left, draw =black] (L) to (Y);
\draw [-latex, black] (L) to (A);
\end{tikzpicture}
```

### Solution: Adjust for Confounder

```{tikz}
#| label: fig-dag-2
#| fig-cap: "Solution to this problem."
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}


\begin{tikzpicture}[{every node/.append style}=draw]
\node [rectangle, draw=black] (L) at (0, 0) {t0/Male};
\node [ellipse, draw=white] (A) at (4, 0) {t1/DoctorVisit};
\node [rectangle, draw=white] (Y) at (8, 0) {t2/Heart Attack};
\draw [-latex, draw=white] (A) to (Y);
\draw [-latex, bend left, draw =black] (L) to (Y);
\draw [-latex, black] (L) to (A);
\end{tikzpicture}

```



### Bias: exposure at baseline is a common cause of the exposure at t1 and outcome at t2


```{tikz}
#| label: fig-dag-3
#| fig-cap: "Causal graph reveals bias from pre-exosure indicator"
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}


\begin{tikzpicture}[{every node/.append style}=draw]
\node [rectangle, draw=white] (L) at (0, 0) {t0/Doctor Visit};
\node [ellipse, draw=white] (A) at (4, 0) {t1/Doctor Visit};
\node [rectangle, draw=white] (Y) at (8, 0) {t2/Heart Attack};
\draw [-latex, draw=red, dashed] (A) to (Y);
\draw [-latex, bend left, draw =black] (L) to (Y);
\draw [-latex, black] (L) to (A);
\end{tikzpicture}

```




### Solution: adjust for confounder at baseline



```{tikz}
#| label: fig-dag-4
#| fig-cap: "Solution to this problem"
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}


\begin{tikzpicture}[{every node/.append style}=draw]
\node [rectangle, draw=white, align=left] (L) at (0, 0) {t0/Heart Attack};
\node [ellipse, draw=white] (A) at (4, 0) {t1/Doctor Visit};
\node [rectangle, draw=white] (Y) at (8, 0) {t2/Heart Attack};
\draw [-latex, draw=red, dashed] (A) to (Y);
\draw [-latex, bend left, draw =black] (L) to (Y);
\draw [-latex, black] (L) to (A);
\end{tikzpicture}

```




###  A more thorough confounding control

```{tikz}
#| label: fig-dag-5
#| fig-cap: "Causal graph:more general panel design"
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}


\begin{tikzpicture}[{every node/.append style}=draw]
\node [rectangle, draw=white, align=left] (L) at (0, 0) {t0/Male \\t0/Heart Attack \\t0/Heart Attack};
\node [ellipse, draw=white] (A) at (4, 0) {t1/Doctor Visit};
\node [rectangle, draw=white] (Y) at (8, 0) {t2/Heart Attack};
\draw [-latex, draw=red, dashed] (A) to (Y);
\draw [-latex, bend left, draw =black] (L) to (Y);
\draw [-latex, black] (L) to (A);
\end{tikzpicture}


```


###  Generic 3-wave panel design (VanderWeeele 2020)

```{tikz}
#| label: fig-dag-6
#| fig-cap: "Causal graph: three-wave panel design"
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}

\begin{tikzpicture}[{every node/.append style}=draw]
\node [rectangle, draw=white] (U) at (0, 0) {U};
\node [rectangle, draw=black, align=left] (L) at (2, 0) {t0/L \\t0/A \\t0/Y};
\node [rectangle, draw=white] (A) at (4, 0) {t1/A};
\node [ellipse, draw=white] (Y) at (6, 0) {t2/Y};
\draw [-latex, draw=black] (U) to (L);
\draw [-latex, draw=black] (L) to (A);
\draw [-latex, draw=red, dotted] (A) to (Y);
\draw [-latex, bend left=50, draw =black] (L) to (Y);
\draw [-latex, bend right=50, draw =black, dotted] (U) to (Y);
\draw [-latex, bend left=50, draw =black, dotted] (U) to (A);


\end{tikzpicture}
```



<!-- ### Selection bias version 1 -->




<!-- ```{tikz} -->
<!-- #| label: fig-dag-7 -->
<!-- #| fig-cap: "Causal graph: three-wave panel design with selection bias" -->
<!-- #| out-width: 100% -->
<!-- #| echo: false -->

<!-- \usetikzlibrary{positioning} -->
<!-- \usetikzlibrary{shapes.geometric} -->
<!-- \usetikzlibrary{arrows} -->
<!-- \usetikzlibrary{decorations} -->
<!-- \tikzstyle{Arrow} = [->, thin, preaction = {decorate}] -->
<!-- \tikzset{>=latex} -->

<!-- \begin{tikzpicture}[{every node/.append style}=draw] -->

<!-- \node [rectangle, draw=white] (U) at (0, 0) {U}; -->
<!-- \node [rectangle, draw=black, align=left] (L) at (2, 0) {t0/L \\t0/A \\t0/Y}; -->
<!-- \node [rectangle, draw=white] (A) at (4, 0) {t1/A}; -->
<!-- \node [ellipse, draw=white] (Y) at (6, 0) {t2/Y}; -->
<!-- \node [rectangle, draw=black] (S) at (8, 0) {S}; -->

<!-- \draw [-latex, draw=black] (U) to (L); -->
<!-- \draw [-latex, draw=black] (L) to (A); -->
<!-- \draw [-latex, bend left=50, draw=black] (L) to (Y); -->
<!-- \draw [-latex, bend right=50, draw=black, dotted] (U) to (Y); -->
<!-- \draw [-latex, bend left=50, draw=black, dotted] (U) to (A); -->
<!-- \draw [-latex, draw=black] (Y) to (S); -->
<!-- \draw [-latex, bend right, draw=black] (A) to (S); -->
<!-- \draw [-latex, draw=red, dashed] (A) to (Y); -->


<!-- \end{tikzpicture} -->


<!-- ``` -->


### Selection bias




```{tikz}
#| label: fig-dag-8
#| fig-cap: "Causal graph: three-wave panel design with selection bias"
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}

\begin{tikzpicture}[{every node/.append style}=draw]

\node [rectangle, draw=white] (U) at (0, 0) {U};
\node [rectangle, draw=black, align=left] (L) at (2, 0) {t0/L \\t0/A \\t0/Y};
\node [rectangle, draw=white] (A) at (4, 0) {t1/A};
\node [ellipse, draw=white] (US) at (4, -1) {U};
\node [rectangle, draw=black](S) at (6, 0) {S};
\node [ellipse, draw=white] (Y) at (8, 0) {t2/Y};

\draw [-latex, draw=black] (U) to (L);
\draw [-latex, draw=black] (L) to (A);
\draw [-latex, bend left=50, draw=black] (L) to (Y);
\draw [-latex, bend right=50, draw=black, dotted] (U) to (Y);
\draw [-latex, bend left=50, draw=black, dotted] (U) to (A);
\draw [-latex, draw=black] (A) to (S);
\draw [-latex, draw=black] (US) to (S);
\draw [-latex, draw=black] (US) to (Y);
\draw [-latex, bend left = 40, draw=red, dashed] (A) to (Y);


\end{tikzpicture}


```


## Important Causal Diagrammes




### What if mediation is of interest? 


Consider the assumptions required for mediation analysis.


```{tikz}
#| label: fig-dag-mediation-assuptions
#| fig-cap: "Assumptions for mediation analysis"
#| out-width: 100%
#| echo: false

\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}

\begin{tikzpicture}[{every node/.append style}=draw]


\node [rectangle, draw=black] (L1) at (0, 1) {t0/L1};
\node [rectangle, draw=black] (L2) at (0, -1) {t0/L2};
\node [ellipse, draw=white] (A) at (3, 0) {t1/A};
\node [rectangle, draw=black](L3) at (6, -1) {t2/L3};
\node [rectangle, draw=white](M) at (9, 0) {t2*/M};
\node [rectangle, draw=white](Y) at (12, 0) {t3/Y};


\draw [-latex, draw=brown] (L1) to (A);
\draw [-latex, draw=brown, bend left] (L1) to (Y);
\draw [-latex, draw=green] (L2) to (A);
\draw [-latex, draw=green] (L2) to (M);
\draw [-latex, draw= gray, dashed] (A) to (M);
\draw [-latex, draw= gray, dashed, bend left] (A) to (Y);
\draw [-latex, draw=red] (A) to (L3);
\draw [-latex, draw=purple] (L3) to (M);
\draw [-latex, draw=purple] (L3) to (Y);
\draw [-latex, draw= gray, dashed] (M) to (Y);




\end{tikzpicture}

```




### Confounder-Treatment Feedback



```{tikz}
#| label: fig-dag-9
#| fig-cap: "Confounder Treatement Feedback"
#| out-width: 100%
#| echo: false


\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations}
\tikzstyle{Arrow} = [->, thin, preaction = {decorate}]
\tikzset{>=latex}

\begin{tikzpicture}[{every node/.append style}=draw]
\node [rectangle, draw=white] (U) at (0, 0) {U};
\node [rectangle, draw=black] (L0) at (2, 0) {t0/L};
\node [rectangle, draw=white] (A1) at (4, 0) {t1/A};
\node [rectangle, draw=black] (Y2) at (6, 0) {t2/Y};
\node [rectangle, draw=black] (L2) at (8, 0) {t2/L};
\node [rectangle, draw=white] (A2) at (10, 0) {t3/A};
\node [rectangle, draw=black] (Y3) at (12, 0) {t4/Y};

\draw [-latex, draw=black] (U) to (L0);
\draw [-latex, draw=black] (L0) to (A1);
\draw [-latex, draw=black] (L2) to (A2);

\draw [-latex, bend right, draw=black] (U) to (Y2);
\draw [-latex, bend right, draw=black] (U) to (L2);
\draw [-latex, bend right, draw=black] (U) to (Y3);

\draw [-latex, bend right, draw=red, dashed] (A1) to (Y3);
\draw [-latex, bend left, draw=red] (A1) to (L2);


\end{tikzpicture}
```
